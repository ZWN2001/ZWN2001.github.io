<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>读paper3-Katana_Dual_Slicing-Based_Context_for_Learning_Bug_Fixes | ZWN's blog</title><meta name="author" content="琉璃月"><meta name="copyright" content="琉璃月"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="读paper3-Katana: Dual Slicing-Based Context for Learning Bug Fixes 提出了一种基于程序切片的方法，其不是任意地将代码作为上下文包含进来，而是分析对错误语句具有控制或数据依赖关系的语句。利用代码的上下文和修复版本的上下文来捕获相关的修复要素。这里修复版本的上下文并不是指错误代码区的代码前缀与后缀，而是指的是与错误代码直接关联的代码块，无"><meta property="og:type" content="article"><meta property="og:title" content="读paper3-Katana_Dual_Slicing-Based_Context_for_Learning_Bug_Fixes"><meta property="og:url" content="https://zwn2001.space/posts/%E8%AF%BBpaper3-Katana-Dual-Slicing-Based-Context-for-Learning-Bug-Fixes/index.html"><meta property="og:site_name" content="ZWN&#39;s blog"><meta property="og:description" content="读paper3-Katana: Dual Slicing-Based Context for Learning Bug Fixes 提出了一种基于程序切片的方法，其不是任意地将代码作为上下文包含进来，而是分析对错误语句具有控制或数据依赖关系的语句。利用代码的上下文和修复版本的上下文来捕获相关的修复要素。这里修复版本的上下文并不是指错误代码区的代码前缀与后缀，而是指的是与错误代码直接关联的代码块，无"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://zwn2001.space/img/cover/42.jpg"><meta property="article:published_time" content="2024-08-11T12:30:40.000Z"><meta property="article:modified_time" content="2024-08-16T12:37:44.805Z"><meta property="article:author" content="琉璃月"><meta property="article:tag" content="研"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://zwn2001.space/img/cover/42.jpg"><link rel="shortcut icon" href="/img/favicon.webp"><link rel="canonical" href="https://zwn2001.space/posts/%E8%AF%BBpaper3-Katana-Dual-Slicing-Based-Context-for-Learning-Bug-Fixes/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://unpkg.com/@fancyapps/ui/dist/fancybox/fancybox.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.xml",preload:!0,top_n_per_article:-1,unescape:!1,languages:{hits_empty:"找不到您查询的内容：${query}",hits_stats:"共找到 ${hits} 篇文章"}},translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"简"},noticeOutdate:{limitDay:200,position:"top",messagePrev:"距离上次更新已经过去",messageNext:"天啦！注意内容可能过时。"},highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:300},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"天",dateSuffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"fancybox",Snackbar:void 0,source:{justifiedGallery:{js:"https://unpkg.com/flickr-justified-gallery/dist/fjGallery.min.js",css:"https://unpkg.com/flickr-justified-gallery/dist/fjGallery.css"}},isPhotoFigcaption:!0,islazyload:!1,isAnchor:!0,percent:{toc:!0,rightside:!0},autoDarkmode:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"读paper3-Katana_Dual_Slicing-Based_Context_for_Learning_Bug_Fixes",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2024-08-16 20:37:44"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,a){0!==a&&(a=864e5*a,t={value:t,expiry:(new Date).getTime()+a},localStorage.setItem(e,JSON.stringify(t)))},get:function(e){var t=localStorage.getItem(e);if(t){t=JSON.parse(t);if(!((new Date).getTime()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=o=>new Promise((t,e)=>{const a=document.createElement("script");a.src=o,a.async=!0,a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.getCSS=(o,n=!1)=>new Promise((t,e)=>{const a=document.createElement("link");a.rel="stylesheet",a.href=o,n&&(a.id=n),a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","ffffff")};e=saveToLocal.get("theme"),"dark"===e?activateDarkMode():"light"===e&&activateLightMode(),e=saveToLocal.get("aside-status");void 0!==e&&("hide"===e?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="/css/transpancy.css"><link rel="stylesheet" href="/css/iconfont.css"><link rel="stylesheet" href="/css/rightmenu.css"><link rel="stylesheet" href="/css/loadimg.css"><link rel="stylesheet" href="/css/project.css"><link type="text/html" rel="stylesheet" href="/css/wide_screen.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css"><style>#recent-posts>.recent-post-item>.recent-post-info>.article-meta-wrap>.tags:before{content:"\A";white-space:pre}#recent-posts>.recent-post-item>.recent-post-info>.article-meta-wrap>.tags>.article-meta__separator{display:none}</style><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" src="/img/favicon.webp"><div class="loading-image-dot"></div><div id="loading-percentage"></div></div></div><script>const loadingPercentage=document.getElementById("loading-percentage");loadingPercentage.style.color="black";let loadingPercentageTimer=setInterval(function(){var e=document.querySelector(".pace-progress");e&&(e=e.getAttribute("data-progress-text"))!==loadingPercentage.textContent&&"60%"===(loadingPercentage.textContent=e)&&clearInterval(loadingPercentageTimer)},100);const preloader={endLoading:()=>{document.body.style.overflow="auto",document.getElementById("loading-box").classList.add("loaded")},initLoading:()=>{document.body.style.overflow="",document.getElementById("loading-box").classList.remove("loaded")}};window.addEventListener("load",()=>{preloader.endLoading()})</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/favicon.webp" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">147</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">48</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(/img/cover/42.jpg)"><nav id="nav"><span id="blog-info"><a href="/" title="ZWN's blog"><span class="site-name">ZWN's blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">读paper3-Katana_Dual_Slicing-Based_Context_for_Learning_Bug_Fixes</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-08-11T12:30:40.000Z" title="发表于 2024-08-11 20:30:40">2024-08-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-08-16T12:37:44.805Z" title="更新于 2024-08-16 20:37:44">2024-08-16</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%A0%94%E7%A9%B6%E7%94%9F%E5%B7%A5%E4%BD%9C/">研究生工作</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">12.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>54分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1>读paper3-Katana: Dual Slicing-Based Context for Learning Bug Fixes</h1><p>提出了一种基于程序切片的方法，其不是任意地将代码作为上下文包含进来，而是分析对错误语句具有控制或数据依赖关系的语句。利用代码的上下文和修复版本的上下文来捕获相关的修复要素。这里修复版本的上下文并不是指错误代码区的代码前缀与后缀，而是指的是与错误代码直接关联的代码块，无论是控制流还是数据流。</p><p>思路上还是基于变形的AST+图神经网络，同时通过上下文的切分尽可能减少冗余信息，通过修复版本的上下文为神经网络的学习提供更多信息。</p><p>关键点：算法1，图1尤其是其中的图表示</p><p>项目开源在https://github.com/saltlab/Katana</p><h2 id="问题引入">问题引入</h2><p>当前最先进的基于学习的程序修复方法以各种方式利用上下文，并且其中许多方法使用基于序列和树/图的源代码表示来学习程序修复。这些方法使用包含buggy语句的包围类、包围函数、buggy子树或整个文件来捕获buggy语句的上下文。然而，所有这些方法都对处理buggy语句设置了一个界限限制。基于序列的方法使用最大标记数限制（例如，1,000个标记），在这个范围内提取buggy方法或类，以避免截断的序列。类似地，当前基于图的学习技术对程序修复使用最大节点限制（例如，500个节点）。在实践中，<strong>我们不能指望真实世界的错误总是包含在小/中型方法中，或者限制在任意数量的标记或AST节点上。因此，这种定量约束可能导致一些与bug修复相关的重要信息被截断，整体上下文甚至可能失去语义意义</strong>。</p><p>我们的思路是，<strong>对于上下文，我们可以通过程序切片的概念来限制代码，而不是仅仅限制在包围实体或标记/节点数量上的任意限制</strong>。我们假设基于切片的上下文对于学习bug修复模式的机器学习模型是有帮助的。我们的技术名为Katana，它基于<strong>静态程序切片</strong>来获得与bug和其修复相关的上下文。然后，将这个获得的切片上下文表示为<strong>增加了控制流和数据流边的AST图</strong>。然后将这个图输入到<strong>图神经网络</strong>（GNN）进行训练。</p><p>图1描绘了我们方法的概述。我们的整体方法包括五个主要步骤，即数据收集、程序切片、图表示、训练和推理。接下来，我们描述每个步骤。（宽虚线框标识的四部分）</p><p><img src="image-20240811205420427.png" alt=""></p><p>本文样例：开发者注意到属性<code>currentUser</code>调用了对<code>service</code>的函数调用。在查看函数声明后，他们注意到<code>service</code>需要一个必需的<code>user</code>参数，并且有错误的行没有传递任何参数。开发者确定了错误的原因，并通过将在第12行声明的缺失参数<code>user</code>传递给函数调用来生成修复。</p><img src="image-20240811234148940.png" style="zoom:67%"><h2 id="数据收集">数据收集</h2><p>爬虫，爬取思路还是挺有意思：</p><p>我们认为一个AST节点的差异就是一个bug，如果只有一个AST节点在有bug的树和修复后的树之间被添加、删除或修改，那么我们认为数据点之间存在一个节点的差异。我们通过以下步骤提取这些数据点：</p><ul><li>使用SHIFT AST2解析器生成每个数据点的有bug和已修复文件的AST</li><li>仅选择那些两个AST之间的差异等于一个的数据点。</li></ul><p>我们还使用SHIFT AST解析器剪枝掉任何无法解析的JavaScript数据点。如果一个JavaScript文件存在不完整的闭包，例如缺少大括号或括号，我们使用解析器来检查是否可以生成AST。</p><h2 id="程序切片-Static-Program-Slicing">程序切片 Static Program Slicing</h2><p>使用后向切片作为上下文，它是相对于切片准则 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>p</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(p,V)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:.22222em">V</span><span class="mclose">)</span></span></span></span> 的所有<strong>具有数据或控制依赖关系</strong>的语句的子集，其中切片准则是有问题的程序点 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.625em;vertical-align:-.19444em"></span><span class="mord mathnormal">p</span></span></span></span> 处的变量集合 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.22222em">V</span></span></span></span>。</p><p>我们对数据集中的每个数据点进行分析，收集必要信息进行切片分析。为了确定切片准则，我们首先对有错误和修复的行进行差异分析，以获得有错误的行号。然后，我们将该行号输入到我们的切片框架中，并提取该行中使用的变量和函数调用。为了通过静态后向切片提取上下文语句，我们结合了控制流和数据流分析，并在适用的情况下识别切片语句。</p><p>算法1概述了从给定行号 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.10903em">N</span></span></span></span> 和文件 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mi>i</mi><mi>l</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">file</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.8888799999999999em;vertical-align:-.19444em"></span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mord mathnormal">e</span></span></span></span> 中提取上下文的步骤。具体来说，算法1从给定的有错误或修复的行中提取Entity实体（即变量、函数、对象）。算法1遍历所有实体，使用后向切片（backward slice）分析获取所有的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>o</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>x</mi><mi>t</mi><mi>L</mi><mi>i</mi><mi>n</mi><mi>e</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">contextLines</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal">co</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal">t</span><span class="mord mathnormal">L</span><span class="mord mathnormal">in</span><span class="mord mathnormal">es</span></span></span></span>。<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>o</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>x</mi><mi>t</mi><mi>L</mi><mi>i</mi><mi>n</mi><mi>e</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">contextLines</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal">co</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal">t</span><span class="mord mathnormal">L</span><span class="mord mathnormal">in</span><span class="mord mathnormal">es</span></span></span></span> 是切片上下文的行号集合。在 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mi>a</mi><mi>c</mi><mi>k</mi><mi>w</mi><mi>a</mi><mi>r</mi><mi>d</mi><mi>S</mi><mi>l</mi><mi>i</mi><mi>c</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">BackwardSlice</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.69444em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.05017em">B</span><span class="mord mathnormal">a</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:.03148em">k</span><span class="mord mathnormal" style="margin-right:.02691em">w</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:.01968em">Sl</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ce</span></span></span></span> 函数中，算法1遍历给定实体中的所有引用；<strong>如果引用的实体是控制流或数据依赖的，那么相应的行被添加到</strong> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>o</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>x</mi><mi>t</mi><mi>L</mi><mi>i</mi><mi>n</mi><mi>e</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">contextLines</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal">co</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal">t</span><span class="mord mathnormal">L</span><span class="mord mathnormal">in</span><span class="mord mathnormal">es</span></span></span></span>；该过程递归地进行，以获取引用实体的后向切片。最后，算法生成从 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>o</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>x</mi><mi>t</mi><mi>L</mi><mi>i</mi><mi>n</mi><mi>e</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">contextLines</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal">co</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal">t</span><span class="mord mathnormal">L</span><span class="mord mathnormal">in</span><span class="mord mathnormal">es</span></span></span></span> 构造的源代码语句，以返回输出。</p><p>此处，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mi>e</mi><mi>t</mi><mi>S</mi><mi>t</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi>m</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">getStatements</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.8777699999999999em;vertical-align:-.19444em"></span><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="mord mathnormal">e</span><span class="mord mathnormal">tSt</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">m</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">s</span></span></span></span> 函数确保正确提取给定上下文行的所有闭包，因为在JavaScript这样的动态语言中，这是一个具有挑战性的过程。例如，与Java不同，JavaScript中的声明或表达式语句不需要分号；在这种情况下，我们将换行符视为语句的结束。有些情况下，有错误的行位于循环或条件语句中。对于这种有错误的语句，我们通过控制流分析确定闭包，以避免通过后向切片获得不完整的上下文。</p><p>我们提取的有错误和修复的文件的数据点包含了完整的JavaScript代码，只有错误和在相同错误行处的修补程序的差异。</p><img src="image-20240811225223744.png" style="zoom:70%"><h3 id="单一切片">单一切片</h3><p>单一切片<strong>用于提取与错误行有关的上下文</strong>。我们首先以错误行作为切片准则，捕获后向切片（backward slice）语句作为上下文。这生成了一个只包含后向切片语句的错误文件作为上下文。然后我们将这个错误文件的上下文附加到正确的行上，并生成修复版本的错误文件。我们称之为单一切片，因为只在错误文件上应用了后向切片，并且错误文件的上下文只是简单地转移到了修复文件上。</p><p>列表3和4展示了单一切片错误和修复文件的代码片段。由于切片准则是错误行，修复文件包含与错误文件相同的切片上下文，并且不包含有关已作为修复传递的变量user的信息。</p><img src="image-20240811230505325.png" style="zoom:80%"> <img src="image-20240811230522694.png" style="zoom:80%"><h3 id="双重切片">双重切片</h3><p>修复后的上下文中存在一些修复成分，它们可以改善整个学习过程。双重切片分析旨在<strong>分别从错误和修复文件中提取上下文</strong>，为模型提供附加的语义信息。通过使用错误行和修复行的切片准则，我们分别从这两行中提取切片语句，生成切片的错误和修复文件。</p><p>列表3和5展示了错误和修复文件。在这种方法中，切片准则是错误行和修复行，修复文件包含了额外的行，其中包含了在第10行上对变量user的声明，这对于生成修补程序是必要的，因为函数service需要此参数。</p><img src="image-20240811233723318.png" style="zoom:80%"><h2 id="图表示-Graph-Representation">图表示 Graph Representation</h2><p>通常，程序的抽象语法树(AST)被用作程序图的主干，该图由编程语言语法的语法非终结符和终结符组成。通过不同类型的边缘，图形能够利用节点之间的句法和语义关系。它们还能够通过边缘考虑远程依赖，即使这些变量或函数位于不同的位置。</p><p>对于每个数据点，我们分别为有问题和修复后的切片文件创建图形。我们提取了每个切片文件的AST，并将其转换为图形，通过添加SuccToken边缘连接叶节点和ValueLink边缘连接附加值节点。图1展示了我们示例切片的有问题和修复后的图形。表示源代码为图形后，我们使用图神经网络（GNN）将结果图形映射为向量表示。具体而言，给定一个图形 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mo>=</mo><mo stretchy="false">(</mo><mi>V</mi><mo separator="true">,</mo><mi>E</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">g=(V,E)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.625em;vertical-align:-.19444em"></span><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:.22222em">V</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:.05764em">E</span><span class="mclose">)</span></span></span></span>，其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.22222em">V</span></span></span></span> 是节点集合，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.05764em">E</span></span></span></span> 是边集合，我们使用函数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>g</mi><mo stretchy="false">)</mo><mo>→</mo><mo stretchy="false">(</mo><msup><mi mathvariant="double-struck">R</mi><mi>d</mi></msup><mo separator="true">,</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi mathvariant="normal">∣</mi><mi>V</mi><mi mathvariant="normal">∣</mi><mo>×</mo><mi>d</mi></mrow></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(g)\rightarrow(\mathbb R ^d,\mathbb R^{|V|\times d})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="mclose">)</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">→</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-.25em"></span><span class="mopen">(</span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.849108em"><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.8879999999999999em"><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">∣</span><span class="mord mathnormal mtight" style="margin-right:.22222em">V</span><span class="mord mtight">∣</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 确定图形 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi></mrow><annotation encoding="application/x-tex">g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.625em;vertical-align:-.19444em"></span><span class="mord mathnormal" style="margin-right:.03588em">g</span></span></span></span> 和个体节点 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mo>∈</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">v\in V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.5782em;vertical-align:-.0391em"></span><span class="mord mathnormal" style="margin-right:.03588em">v</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.22222em">V</span></span></span></span> 的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.69444em;vertical-align:0"></span><span class="mord mathnormal">d</span></span></span></span> 维度表示。节点嵌入是一个向量，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>v</mi><mo>⃗</mo></mover><mo>=</mo><msubsup><mi>h</mi><mi>v</mi><mrow><mo stretchy="false">(</mo><mi>L</mi><mo stretchy="false">)</mo></mrow></msubsup></mrow><annotation encoding="application/x-tex">\vec v=h_v^{(L)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.714em;vertical-align:0"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.714em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord mathnormal" style="margin-right:.03588em">v</span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="accent-body" style="left:-.20772em"><span class="overlay" style="height:.714em;width:.471em"><svg xmlns="http://www.w3.org/2000/svg" width="0.471em" height="0.714em" style="width:.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z"/></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1.161392em;vertical-align:-.11659199999999997em"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em"><span style="top:-2.5834080000000004em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span><span style="top:-3.2198em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">L</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.11659199999999997em"><span></span></span></span></span></span></span></span></span></span>，其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal">L</span></span></span></span> 表示通过消息传递在 GNN 中的总传播数。消息传递在 GNN 模型中使用，其中向量消息在图中的节点之间交换并通过聚合函数进行更新。图形表示 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>g</mi><mo>⃗</mo></mover></mrow><annotation encoding="application/x-tex">\vec g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.9084399999999999em;vertical-align:-.19444em"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.714em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord mathnormal" style="margin-right:.03588em">g</span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="accent-body" style="left:-.20772em"><span class="overlay" style="height:.714em;width:.471em"><svg xmlns="http://www.w3.org/2000/svg" width="0.471em" height="0.714em" style="width:.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z"/></svg></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.19444em"><span></span></span></span></span></span></span></span></span> 是节点嵌入 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>h</mi><mi>v</mi><mi>l</mi></msubsup><mo separator="true">,</mo><mi mathvariant="normal">∀</mi><mi>l</mi><mo>∈</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><mi>L</mi></mrow><annotation encoding="application/x-tex">h_v^l,\forall l\in 0,1,\dots,L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.096108em;vertical-align:-.247em"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.849108em"><span style="top:-2.4530000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">v</span></span></span><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:.01968em">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.247em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord">∀</span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.8777699999999999em;vertical-align:-.19444em"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="minner">…</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal">L</span></span></span></span> 的聚合，对于每个 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi></mrow><annotation encoding="application/x-tex">l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.69444em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.01968em">l</span></span></span></span>，使用最大池化来计算平均的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">L+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76666em;vertical-align:-.08333em"></span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">1</span></span></span></span> 个向量以获得 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>g</mi><mo>⃗</mo></mover></mrow><annotation encoding="application/x-tex">\vec g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.9084399999999999em;vertical-align:-.19444em"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.714em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord mathnormal" style="margin-right:.03588em">g</span></span><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="accent-body" style="left:-.20772em"><span class="overlay" style="height:.714em;width:.471em"><svg xmlns="http://www.w3.org/2000/svg" width="0.471em" height="0.714em" style="width:.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z"/></svg></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.19444em"><span></span></span></span></span></span></span></span></span>。</p><p><img src="image-20240811234554456.png" alt=""></p><h2 id="训练">训练</h2><p>为了训练一个模型，我们采用了一个GNN架构，将图表示映射到一个固定维度的向量空间中。<strong>程序修复本质上是一系列图转换操作</strong>，从有错误的图到修复后的图，包括添加或删除节点，替换节点值或节点类型等操作。在图创建步骤中，为每个数据点生成了有错误的图 (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>g</mi><mrow><mi>b</mi><mi>u</mi><mi>g</mi></mrow></msub></mrow><annotation encoding="application/x-tex">g_{bug}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.716668em;vertical-align:-.286108em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.3361079999999999em"><span style="top:-2.5500000000000003em;margin-left:-.03588em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mord mathnormal mtight" style="margin-right:.03588em">ug</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span></span></span></span>)、修复后的图 (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>g</mi><mrow><mi>f</mi><mi>i</mi><mi>x</mi></mrow></msub></mrow><annotation encoding="application/x-tex">g_{fix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.716668em;vertical-align:-.286108em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.3361079999999999em"><span style="top:-2.5500000000000003em;margin-left:-.03588em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.10764em">f</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span></span></span></span>) 以及用于创建 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>g</mi><mrow><mi>f</mi><mi>i</mi><mi>x</mi></mrow></msub></mrow><annotation encoding="application/x-tex">g_{fix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.716668em;vertical-align:-.286108em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.3361079999999999em"><span style="top:-2.5500000000000003em;margin-left:-.03588em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.10764em">f</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span></span></span></span> 的相应图编辑序列，即图差异。换句话说，模型通过将图编辑操作应用于有错误的行上的有错误的图（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>g</mi><mrow><mi>b</mi><mi>u</mi><mi>g</mi></mrow></msub></mrow><annotation encoding="application/x-tex">g_{bug}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.716668em;vertical-align:-.286108em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.3361079999999999em"><span style="top:-2.5500000000000003em;margin-left:-.03588em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mord mathnormal mtight" style="margin-right:.03588em">ug</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span></span></span></span>）来创建 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>g</mi><mrow><mi>f</mi><mi>i</mi><mi>x</mi></mrow></msub></mrow><annotation encoding="application/x-tex">g_{fix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.716668em;vertical-align:-.286108em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.3361079999999999em"><span style="top:-2.5500000000000003em;margin-left:-.03588em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.10764em">f</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span></span></span></span>。这个图差异包含了一系列AST修改，作为一个细粒度的监督机制来进行图转换。修改包含图编辑操作的类型、节点在图中的位置和要添加/修改的值（删除操作时不提供值）。总之，给定一个数据集 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi><mo>=</mo><mo stretchy="false">{</mo><mo stretchy="false">(</mo><msubsup><mi>g</mi><mrow><mi>b</mi><mi>u</mi><mi>g</mi></mrow><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msubsup><mo separator="true">,</mo><msubsup><mi>g</mi><mrow><mi>f</mi><mi>i</mi><mi>x</mi></mrow><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msubsup><mo stretchy="false">)</mo><msubsup><mo stretchy="false">}</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow><mi mathvariant="normal">∣</mi><mi>D</mi><mi mathvariant="normal">∣</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">D=\{(g_{bug}^{(i)},g_{fix}^{(i)})\}_{i=1}^{|D|}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.02778em">D</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1.4822159999999998em;vertical-align:-.4374159999999999em"></span><span class="mopen">{(</span><span class="mord"><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em"><span style="top:-2.3986920000000005em;margin-left:-.03588em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mord mathnormal mtight" style="margin-right:.03588em">ug</span></span></span></span><span style="top:-3.2198em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.4374159999999999em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em"><span style="top:-2.3986920000000005em;margin-left:-.03588em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.10764em">f</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">x</span></span></span></span><span style="top:-3.2198em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.4374159999999999em"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose"><span class="mclose">}</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em"><span style="top:-2.4231360000000004em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2198em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">∣</span><span class="mord mathnormal mtight" style="margin-right:.02778em">D</span><span class="mord mtight">∣</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.27686399999999994em"><span></span></span></span></span></span></span></span></span></span> ，其中包含有错误的和修复过的切片代码对，模型通过学习目标 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mi>a</mi><msub><mi>x</mi><mi>θ</mi></msub><msub><mi mathvariant="double-struck">E</mi><mrow><mo stretchy="false">(</mo><msub><mi>g</mi><mrow><mi>b</mi><mi>u</mi><mi>g</mi></mrow></msub><mo separator="true">,</mo><msub><mi>g</mi><mrow><mi>f</mi><mi>i</mi><mi>x</mi></mrow></msub><mo stretchy="false">)</mo><mo>∼</mo><mi>D</mi></mrow></msub><mtext> </mtext><mi>p</mi><mo stretchy="false">(</mo><msub><mi>g</mi><mrow><mi>b</mi><mi>u</mi><mi>g</mi></mrow></msub><mi mathvariant="normal">∣</mi><msub><mi>g</mi><mrow><mi>f</mi><mi>i</mi><mi>x</mi></mrow></msub><mo separator="true">;</mo><mi>θ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">max_\theta \mathbb E_{(g_{bug},g_{fix})\sim D}\,p(g_{bug}|g_{fix};\theta)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1332799999999998em;vertical-align:-.38327999999999984em"></span><span class="mord mathnormal">ma</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.33610799999999996em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:.02778em">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathbb">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.3448em"><span style="top:-2.5198em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.3448em"><span style="top:-2.3487714285714287em;margin-left:-.03588em;margin-right:.07142857142857144em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mord mathnormal mtight" style="margin-right:.03588em">ug</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.29011428571428566em"><span></span></span></span></span></span></span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03588em">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.3448em"><span style="top:-2.3487714285714287em;margin-left:-.03588em;margin-right:.07142857142857144em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.10764em">f</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.29011428571428566em"><span></span></span></span></span></span></span><span class="mclose mtight">)</span><span class="mrel mtight">∼</span><span class="mord mathnormal mtight" style="margin-right:.02778em">D</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.38327999999999984em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.3361079999999999em"><span style="top:-2.5500000000000003em;margin-left:-.03588em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mord mathnormal mtight" style="margin-right:.03588em">ug</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.3361079999999999em"><span style="top:-2.5500000000000003em;margin-left:-.03588em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.10764em">f</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span><span class="mpunct">;</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:.02778em">θ</span><span class="mclose">)</span></span></span></span> 来最大化修复的可能性。最大似然估计（MLE）目标函数是在每个图编辑步骤上的交叉熵损失的总和。</p><p>对于单一切片，GNN模型的输入是有错误的图 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>g</mi><mrow><mi>b</mi><mi>u</mi><mi>g</mi></mrow></msub></mrow><annotation encoding="application/x-tex">g_{bug}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.716668em;vertical-align:-.286108em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.3361079999999999em"><span style="top:-2.5500000000000003em;margin-left:-.03588em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mord mathnormal mtight" style="margin-right:.03588em">ug</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span></span></span></span>，其中只包含与有错误行相关的切片上下文。模型的输出是应用于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>g</mi><mrow><mi>b</mi><mi>u</mi><mi>g</mi></mrow></msub></mrow><annotation encoding="application/x-tex">g_{bug}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.716668em;vertical-align:-.286108em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.3361079999999999em"><span style="top:-2.5500000000000003em;margin-left:-.03588em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mord mathnormal mtight" style="margin-right:.03588em">ug</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span></span></span></span> 的有错误节点上的图编辑操作，从而得到修复后的图 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>g</mi><mrow><mi>f</mi><mi>i</mi><mi>x</mi></mrow></msub></mrow><annotation encoding="application/x-tex">g_{fix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.716668em;vertical-align:-.286108em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.3361079999999999em"><span style="top:-2.5500000000000003em;margin-left:-.03588em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.10764em">f</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span></span></span></span>。</p><p>对于双重切片，模型的输入是有错误的图 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>g</mi><mrow><mi>b</mi><mi>u</mi><mi>g</mi></mrow></msub></mrow><annotation encoding="application/x-tex">g_{bug}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.716668em;vertical-align:-.286108em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.3361079999999999em"><span style="top:-2.5500000000000003em;margin-left:-.03588em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mord mathnormal mtight" style="margin-right:.03588em">ug</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span></span></span></span>，其中包含与有错误行和修复行相关的切片上下文。输出与之前的情况相同，即应用于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>g</mi><mrow><mi>b</mi><mi>u</mi><mi>g</mi></mrow></msub></mrow><annotation encoding="application/x-tex">g_{bug}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.716668em;vertical-align:-.286108em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.3361079999999999em"><span style="top:-2.5500000000000003em;margin-left:-.03588em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">b</span><span class="mord mathnormal mtight" style="margin-right:.03588em">ug</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span></span></span></span> 中有错误节点的图编辑操作。简而言之，使用双重切片的上下文进行训练的模型可以访问与错误和修复两者相关的额外上下文信息。</p><blockquote><p>Note that, we do not differentiate the buggy or fixed graph input to the model based on any particular bug type, and feed the data as is.</p></blockquote><h2 id="结果评估">结果评估</h2><h3 id="RQ1：双切片与单切片在学习修复方面有何区别？">RQ1：双切片与单切片在学习修复方面有何区别？</h3><p>双切片实现了更高的准确率。Top-1，3，5指的是beam size为1、3和5</p><img src="image-20240812004633399.png" style="zoom:67%"><h3 id="RQ2：Katana与最新的基于学习的修复技术相比如何？">RQ2：Katana与最新的基于学习的修复技术相比如何？</h3><p>Katana对于所有的beam size都优于现有的技术。</p><h3 id="RQ3：切片对于获得上下文信息有何影响？">RQ3：切片对于获得上下文信息有何影响？</h3><p>我们对我们的切片技术进行了定量分析，以衡量所考虑的上下文的类型和数量，并将其与其他方法进行比较。我们在程序切片分析期间对我们的数据集进行了统计。我们计算了切片前后的行数以及经过控制流和数据流分析的数据点的比例。我们发现，26.96%的总数据点（113,975对有错误和修复的文件）需要同时使用控制流和数据流分析来生成切片。其余的73.04%仅通过数据流分析进行了切片。图3显示了数据点在切片前后的行数。在这里，我们将切片前的数据集称为未切片的数据集。Katana的程序切片将需要考虑的上下文的平均行数从39条减少到15条。中位数也从33条减少到9条。切片前的最大行数为1,087行，切片后减少到636行，而最小行数在两种情况下均为1。</p><h2 id="Limitations">Limitations</h2><p>一个明显的问题是仅针对JS进行的训练。</p><p>Katana<strong>无法从被压缩或混淆的JavaScript代码中生成切片</strong>。压缩步骤会移除空白字符、混淆变量名，并且通常产生单行输出。因此，我们在数据集中排除了被压缩的JavaScript文件，因为它们可能会在学习过程中引入噪音。然而，在实际应用中，这些被压缩或混淆的代码在部署到生产环境之前会执行该压缩步骤，并且这些代码并不供人类阅读。因此，压缩或混淆的代码不会限制Katana的适用性。</p><p>JavaScript是一种动态类型语言，这本质上使得在<strong>程序切片期间难以跟踪控制和数据流依赖关系</strong>。在控制和数据流分析无法获得切片上下文的情况下，我们将整个文件内容视为有错误的行的上下文范围。</p><p>目前的Katana实现<strong>不支持生成多行补丁</strong>。由于我们的数据集只包含一个AST节点的差异，我们使用单行作为切片准则来提取上下文语句。然而，从概念上讲，我们可以扩展程序切片的概念来修复多行错误。</p><p>我们使用了跨程序和内部程序的后向切片分析，但<strong>限定了JavaScript文件的程序分析范围</strong>。之所以选择这种方式，是因为我们的数据收集是基于提交而不是项目；这种方法不能确保所有依赖文件都包含在提交中。此外，由于我们使用的切片框架（Understand）仅支持文件内的静态分析，因此我们的JavaScript切片器受到此限制的约束。然而，根据之前的研究，大部分修复的关键在于包含错误的文件中。正如第5.3节中讨论的那样，Katana修复错误的能力受到词汇的可用性的限制。如果修复错误需要替换一个节点或添加一个节点，则该节点值需要在词汇字典中存在。增加词汇量可能会提高Katana在修复错误时的性能。</p><p>我们使用了后向切片分析，这可能会导致<strong>在别名期间遗漏一些相关的上下文语句</strong>。别名是指多个变量引用内存中的同一位置。某些错误可能在更新变量的别名时发生，而这会改变原始变量。由于这些错误可能发生在有错误的行之后，前向切片可以帮助捕获相关的上下文语句。在未来的工作中，可以将前向切片支持纳入Katana中以处理这种错误模式。</p><h2 id="项目复现">项目复现</h2><h3 id="数据收集-2">数据收集</h3><p><code>data-collection</code>文件夹下，根据readme，依次</p><ul><li>Run <code>npm install</code></li><li>Download JS repositories using <code>node download_repos.js</code></li><li>Install packages <code>pip install -r requirements.txt</code></li><li>Mine commits from the downloaded repositories using <code>python commitminer.py</code></li></ul><p>注意点：</p><ul><li><p>nodejs某些版本在win11下执行<code>npm install</code>会爆<code>[nodegit] ERROR - finished with error code: Error: spawn EINVAL</code></p><ul><li>解决方案就是换个老点的版本，比如https://nodejs.org/dist/v14.17.3/</li></ul></li><li><p><code>node download_repos.js</code>会down 39G 的仓库，准备好硬盘空间</p></li><li><p><code>commitminer.py</code>第19行会爆warning，改为如下：</p></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">match</span> = re.findall(<span class="string">&#x27;\\d+|\\D+&#x27;</span>, identifier)</span><br></pre></td></tr></table></figure><ul><li><code>commitminer.py</code>第207行会爆：</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;path\data-collection\commitminer.py&quot;</span>, line <span class="number">216</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    createRepositoriesList()</span><br><span class="line">  File <span class="string">&quot;path\data-collection\commitminer.py&quot;</span>, line <span class="number">94</span>, <span class="keyword">in</span> createRepositoriesList</span><br><span class="line">    traverseCommits(repos)</span><br><span class="line">    ^^^^^^^^^^^^^^^^^^^^^^</span><br><span class="line">  File <span class="string">&quot;path\data-collection\commitminer.py&quot;</span>, line <span class="number">207</span>, <span class="keyword">in</span> traverseCommits</span><br><span class="line">    f.write(m.source_code)</span><br><span class="line">UnicodeEncodeError: <span class="string">&#x27;gbk&#x27;</span> codec can<span class="string">&#x27;t encode character &#x27;</span>\ufef<span class="string">f&#x27; in position 0: illegal multibyte sequence</span></span><br></pre></td></tr></table></figure><p>改为utf-8并忽略无法编码的字符：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">f = <span class="built_in">open</span>(newFile, <span class="string">&quot;w+&quot;</span>,encoding=<span class="string">&#x27;utf-8&#x27;</span>, errors=<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">f.write(m.source_code)</span><br><span class="line">f.close()</span><br><span class="line">f = <span class="built_in">open</span>(oldFile, <span class="string">&quot;w+&quot;</span>,encoding=<span class="string">&#x27;utf-8&#x27;</span>, errors=<span class="string">&#x27;ignore&#x27;</span>)</span><br></pre></td></tr></table></figure><ul><li>可能存在某些仓库无法被down，导致执行<code>python commitminer.py</code>爆文件路径不存在，122行处修改如下：</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">repo_path = <span class="string">&#x27;repositories/&#x27;</span> + repo.address</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> os.path.exists(repo_path):</span><br><span class="line">    <span class="keyword">for</span> commit <span class="keyword">in</span> RepositoryMining(repo_path, only_no_merge=<span class="literal">True</span>, only_modifications_with_file_types=[<span class="string">&#x27;.js&#x27;</span>]).traverse_commits():</span><br><span class="line">        <span class="comment"># code......</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;The path <span class="subst">&#123;repo_path&#125;</span> does not exist.&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="程序切片">程序切片</h3><p>需要这个<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.scitools.com">Understand by Scitools</a>的api，学生貌似可以申免费，但我没申下来</p><blockquote><p>破解来自：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/weixin_48220838/article/details/131297065">https://blog.csdn.net/weixin_48220838/article/details/131297065</a></p><p>understand.exe用不到，可以不用破解</p><ol><li><p>正常安装，设置自己的安装路径</p></li><li><p>找到自己安装目录下的 bin文件夹 找到可执行程序understand.exe，复制一份到桌面</p></li><li><p>打开HxD(好兄弟)软件，然后使用他打开刚刚复制的exe文件<a target="_blank" rel="noopener external nofollow noreferrer" href="https://mh-nexus.de/en/downloads.php?product=HxD20">好兄弟下载链接 : Downloads | mh-nexus</a></p></li><li><p>按下Ctrl+F 以文本方式 搜索&quot;areYouThere&quot; ， 用&quot;IamNotHere!&quot; 替代。（都不带引号）</p></li><li><p>以字节序列模式搜索&quot;45 33 FF 41 0F B6 C6 48 3B DF 44 0F 4E F8&quot;，替换为&quot;41 BF 01 00 00 00 90 90 90 90 90 90 90 90&quot;</p></li><li><p>Ctrl+S保存退出，然后将刚刚修改的在桌面上的文件，拖到之前的bin文件替换原有的exe即可</p></li></ol><p>后面用到的und，upython要破解，找到自己安装目录下的 bin文件夹 找到可执行程序，其余同上</p></blockquote><p>省流步骤：</p><ul><li><p>使用<code>python partition.py --dir=path --num_files=10000</code> 来划分子目录，其中<code>path</code>是需要划分的文件目录</p></li><li><p>编辑 <code>und undCommands.txt</code> ，将路径改为自己项目的文件夹路径，并运行 <code>und undCommands.txt</code> 创建 <code>.und</code> 数据库</p><ul><li>这个文件夹内容可能看起来很少（就两个，且很小），不必担心</li></ul></li><li><p>使用脚本 <code>python generate-file-info.py --path=&lt;data-dir&gt;</code> 生成 CSV 文件</p></li><li><p>运行<code>upython backward-slice.py multiple True dir1 dir2 dir3</code> 进行切片</p><ul><li>这个过程最大内存需求可能在22G左右，可能会更多</li><li>很耗时，可以同步准备后面训练的环境</li></ul></li><li><p>使用脚本 <code>node prune-unparsable-files.js &lt;path-to-unsliced-folder&gt; &lt;path-to-sliced-folder&gt; dual</code> 剪除未完全切片的文件</p></li></ul><hr><p>原文如下，略有改动：</p><h4 id="预处理">预处理</h4><ul><li><p><code>backward-slice.py</code> 中的切片函数需要三样东西：</p><ul><li>一个包含有错误和修复文件对的目录。</li><li>该目录中的 <code>.und</code> 数据库。这基本上是该目录中所有文件的 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.scitools.com">Understand</a> 数据库。请注意，<code>understand</code> 无法处理包含超过 10,000 对文件的文件夹，因此最好将整个数据集分割成包含 10,000 <strong>对</strong>文件的多个子目录。使用 <code>partition.py</code> 脚本将根目录分块为多个包含 10,000 对文件的子目录。</li><li>使用<code>python partition.py --dir=path --num_files=10000</code> 来划分，其中<code>path</code>是需要划分的文件目录</li><li>一个包含有错误行、修复行、有错误行号的 CSV 文件。即生成的<code>commits.csv</code></li></ul></li><li><p>对于这些目录中的每一个，通过编辑并运行 <code>und undCommands.txt</code> 创建 <code>.und</code> 数据库。可以在命令<code>txt</code>中添加更多目录块。</p></li><li><p>如果您使用的是 Linux，在终端中应该可以通过 <code>upython</code> 使用 understand 命令行。在 Mac 上，您需要将 <code>upython</code> 可执行文件的路径添加到应用程序文件夹中。</p></li><li><p>使用脚本 <code>python generate-file-info.py --path=&lt;data-dir&gt;</code> 生成 CSV 文件。确保在 <code>--path</code> 中传递所有在understand处理中创建的文件夹块。这将在每个子目录中创建 .csv 文件。</p></li></ul><h4 id="运行切片器">运行切片器</h4><ul><li><p><code>upython backward-slice.py multiple True dir1 dir2 dir3</code></p><ul><li><code>multiple</code> 表示将对包含文件有错误和修复文件的多个目录进行切片。如果您只想在一个文件夹中执行操作，请使用 <code>single</code>。如果您只想测试切片器（进行健全性检查），请运行 <code>upython backward-slice.py test True</code></li><li>这里的 <code>True</code> 表示启用双重切片。<code>False</code> 将进行单一切片。</li><li><code>dir</code>是所有要进行切片的文件夹</li><li><code>upython</code>其实调用的是understand内置的python解释器</li><li><blockquote><p>upython也要破解，找到自己安装目录下的 bin文件夹 找到可执行程序upython.exe，其余同上</p></blockquote></li></ul></li><li><p>运行切片器后，您需要使用脚本 <code>node prune-unparsable-files.js &lt;path-to-unsliced-folder&gt; &lt;path-to-sliced-folder&gt; dual</code> 剪除我们未完全切片的文件。</p></li></ul><hr><h4 id="一些代码问题">一些代码问题</h4><h5 id="generate-file-info-py"><code>generate-file-info.py</code></h5><p>主要是一些操作系统不兼容的问题</p><p>首先，win需要将所有&quot;/“替换为”\\&quot;</p><p>其次，可能出现csv为空的情况，说明有报错。</p><ul><li><p>报错<code>module 'mmap' has no attribute 'PROT_READ'</code>，来自函数第25行，win可改为<code>m = mmap.mmap(f.fileno(), 0, access=mmap.ACCESS_READ)</code></p></li><li><p>报错<code>'mmap.mmap' object has no attribute 'madvise'</code>，win没有这个系统调用，注释掉即可</p></li></ul><p>win可运行代码如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> difflib</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> listdir</span><br><span class="line"><span class="keyword">from</span> os.path <span class="keyword">import</span> isfile, join</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"><span class="keyword">import</span> mmap</span><br><span class="line"><span class="keyword">import</span> queue</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">produce</span>(<span class="params">i, mypath, item</span>):</span><br><span class="line">    <span class="comment"># Data processing goes here; row goes into queue</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;processing item &#123;&#125; - file prefix &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(i, item[<span class="number">0</span>]))</span><br><span class="line">    data = generate_file(mypath, item)</span><br><span class="line">    queue.put(data)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;submitted to queue item &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(i))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bin2str</span>(<span class="params">text, encoding=<span class="string">&#x27;utf-8&#x27;</span></span>):</span><br><span class="line">    <span class="keyword">return</span> text.decode(encoding)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mmap_io</span>(<span class="params">mypath, filename</span>):</span><br><span class="line">    lines = []</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(mypath + <span class="string">&#x27;\\&#x27;</span> + filename, <span class="string">&quot;rb&quot;</span>, buffering=<span class="number">0</span>) <span class="keyword">as</span> f:</span><br><span class="line">            m = mmap.mmap(f.fileno(), <span class="number">0</span>, access=mmap.ACCESS_READ)</span><br><span class="line">            <span class="comment"># m.madvise(mmap.MADV_SEQUENTIAL)</span></span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                line = m.readline()</span><br><span class="line">                <span class="keyword">if</span> line:</span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">len</span>(line) &gt; <span class="number">180</span>:</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&#x27;Large lines in file &#123;&#125; --- Skipping!!&#x27;</span>.<span class="built_in">format</span>(filename))</span><br><span class="line">                        <span class="keyword">return</span> []</span><br><span class="line">                    lines.append(bin2str(line))</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            m.close()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">        lines = []</span><br><span class="line">    <span class="keyword">return</span> lines</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_diff</span>(<span class="params">mypath, fileAName, fileBName</span>):</span><br><span class="line">      <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># fileA = open(mypath + &#x27;/&#x27; + fileAName, &quot;rt&quot;, encoding=&quot;utf-8&quot;).readlines()</span></span><br><span class="line">        fileA = mmap_io(mypath, fileAName)</span><br><span class="line">        <span class="comment"># fileB = open(mypath + &#x27;/&#x27; + fileBName, &quot;rt&quot;, encoding=&quot;utf-8&quot;).readlines()</span></span><br><span class="line">        fileB = mmap_io(mypath, fileBName)</span><br><span class="line">      <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> <span class="built_in">len</span>(fileA) != <span class="built_in">len</span>(fileB) <span class="keyword">or</span> <span class="built_in">len</span>(fileA) == <span class="number">0</span> <span class="keyword">or</span> <span class="built_in">len</span>(fileB) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">      d = difflib.Differ()</span><br><span class="line">      diffs = d.compare(fileA, fileB)</span><br><span class="line"> </span><br><span class="line">      lineNum = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">      final_line_num = <span class="literal">None</span></span><br><span class="line">      patch_line = <span class="literal">None</span></span><br><span class="line">      buggy_line = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> line <span class="keyword">in</span> diffs:</span><br><span class="line">            code = line[:<span class="number">2</span>]</span><br><span class="line">            <span class="comment"># print(code)</span></span><br><span class="line">            <span class="comment"># if the  line is in both files or just b, increment the line number.</span></span><br><span class="line">            <span class="keyword">if</span> code <span class="keyword">in</span> (<span class="string">&quot;  &quot;</span>, <span class="string">&quot;+ &quot;</span>):</span><br><span class="line">                  lineNum += <span class="number">1</span></span><br><span class="line">            <span class="comment"># if this line is only in b, print the line number and the text on the line</span></span><br><span class="line">            <span class="keyword">if</span> code == <span class="string">&quot;- &quot;</span>:</span><br><span class="line">                  buggy_line = line[<span class="number">2</span>:].strip(<span class="string">&#x27;\n&#x27;</span>).strip()</span><br><span class="line">            <span class="keyword">if</span> code == <span class="string">&quot;+ &quot;</span>:</span><br><span class="line">                  final_line_num = lineNum</span><br><span class="line">                  patch_line = line[<span class="number">2</span>:].strip(<span class="string">&#x27;\n&#x27;</span>).strip()</span><br><span class="line">            </span><br><span class="line">      <span class="keyword">return</span> final_line_num, patch_line, buggy_line</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_whitespace_diff</span>(<span class="params">buggy_line, fixed_line</span>):</span><br><span class="line">  output_list = [li <span class="keyword">for</span> li <span class="keyword">in</span> difflib.ndiff(fixed_line, buggy_line) <span class="keyword">if</span> li[<span class="number">0</span>] != <span class="string">&#x27; &#x27;</span>]</span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">len</span>(output_list):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">all</span>(f.strip() <span class="keyword">in</span> [<span class="string">&#x27;+&#x27;</span>, <span class="string">&#x27;-&#x27;</span>] <span class="keyword">for</span> f <span class="keyword">in</span> output_list)</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_get_prefix</span>(<span class="params">filename</span>):</span><br><span class="line">    <span class="keyword">if</span> filename.endswith(<span class="string">&#x27;_babel.js&#x27;</span>):</span><br><span class="line">            <span class="keyword">return</span> filename.split(<span class="string">&#x27;_buggy_babel.js&#x27;</span>)[<span class="number">0</span>] <span class="keyword">if</span> <span class="string">&#x27;_buggy_babel.js&#x27;</span> <span class="keyword">in</span> filename <span class="keyword">else</span> filename.split(<span class="string">&#x27;_fixed_babel.js&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> filename.endswith(<span class="string">&#x27;_buggy.js&#x27;</span>) <span class="keyword">or</span> filename.endswith(<span class="string">&#x27;_fixed.js&#x27;</span>):</span><br><span class="line">            <span class="keyword">return</span> filename.split(<span class="string">&#x27;_buggy.js&#x27;</span>)[<span class="number">0</span>] <span class="keyword">if</span> <span class="string">&#x27;_buggy.js&#x27;</span> <span class="keyword">in</span> filename <span class="keyword">else</span> filename.split(<span class="string">&#x27;_fixed.js&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_file</span>(<span class="params">mypath, item</span>):</span><br><span class="line">    time_start = datetime.datetime.now()</span><br><span class="line">    line_num, fixed_line, buggy_line = find_diff(mypath, item[<span class="number">1</span>][<span class="string">&#x27;buggy_file&#x27;</span>], item[<span class="number">1</span>][<span class="string">&#x27;fixed_file&#x27;</span>])</span><br><span class="line">    <span class="keyword">if</span> line_num <span class="keyword">and</span> <span class="keyword">not</span> is_whitespace_diff(buggy_line, fixed_line):</span><br><span class="line">        time_elapsed = datetime.datetime.now() - time_start</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Elapsed time in seconds for file &#123;&#125;:&#x27;</span>.<span class="built_in">format</span>(item[<span class="number">0</span>]), time_elapsed.seconds)</span><br><span class="line">        data = [item[<span class="number">1</span>][<span class="string">&#x27;buggy_file&#x27;</span>], item[<span class="number">1</span>][<span class="string">&#x27;fixed_file&#x27;</span>], line_num, buggy_line, fixed_line]</span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_file_info</span>(<span class="params">mypath</span>):</span><br><span class="line">    <span class="comment"># blacklisted_prefixes = &#123;&#125;</span></span><br><span class="line">    <span class="comment"># with open(&#x27;./bugs_info.csv&#x27;, &#x27;r&#x27;, encoding=&quot;ISO-8859-1&quot;) as csv_file:</span></span><br><span class="line">    <span class="comment">#     csv_reader = csv.reader(csv_file, delimiter=&#x27;,&#x27;)</span></span><br><span class="line">    <span class="comment">#     for row in csv_reader:</span></span><br><span class="line">    <span class="comment">#         print(row)</span></span><br><span class="line">    <span class="comment">#         if len(row):</span></span><br><span class="line">    <span class="comment">#             if row[0] == &#x27;Buggy file&#x27;:</span></span><br><span class="line">    <span class="comment">#                 continue</span></span><br><span class="line">    <span class="comment">#             prefix = _get_prefix(row[0])</span></span><br><span class="line">    <span class="comment">#             blacklisted_prefixes[prefix] = True</span></span><br><span class="line"></span><br><span class="line">    onlyfiles = [f <span class="keyword">for</span> f <span class="keyword">in</span> listdir(mypath) <span class="keyword">if</span> isfile(join(mypath, f)) <span class="keyword">and</span> f.endswith(<span class="string">&#x27;.js&#x27;</span>)]</span><br><span class="line"></span><br><span class="line">    file_map = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> onlyfiles:</span><br><span class="line">        prefix = _get_prefix(file)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;xml&#x27;</span> <span class="keyword">in</span> file:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;_buggy&#x27;</span> <span class="keyword">in</span> file:</span><br><span class="line">                <span class="keyword">if</span> prefix <span class="keyword">not</span> <span class="keyword">in</span> file_map:</span><br><span class="line">                    file_map[prefix] = &#123;</span><br><span class="line">                            <span class="string">&#x27;buggy_file&#x27;</span>: file</span><br><span class="line">                    &#125;</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    file_map[prefix][<span class="string">&#x27;buggy_file&#x27;</span>] = file</span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&#x27;_fixed&#x27;</span> <span class="keyword">in</span> file:</span><br><span class="line">                <span class="keyword">if</span> prefix <span class="keyword">in</span> file_map:</span><br><span class="line">                    file_map[prefix][<span class="string">&#x27;fixed_file&#x27;</span>] = file</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    file_map[prefix] = &#123;</span><br><span class="line">                            <span class="string">&#x27;fixed_file&#x27;</span>: file</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Number of datapoints&#x27;</span>, <span class="built_in">len</span>(file_map))</span><br><span class="line">    <span class="keyword">return</span> file_map</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init_queue</span>(<span class="params">queue</span>):</span><br><span class="line">    <span class="built_in">globals</span>()[<span class="string">&#x27;queue&#x27;</span>] = queue</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line">parser = argparse.ArgumentParser()</span><br><span class="line">parser.add_argument(</span><br><span class="line">    <span class="string">&#x27;--path&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Folder path of files&#x27;</span>, required=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    path = args.path</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;start loading file info&#x27;</span>)</span><br><span class="line">    file_map = get_file_info(path)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;done loading file_info&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    time_start = datetime.datetime.now()</span><br><span class="line">    queue = queue.Queue()</span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(max_workers=<span class="number">10</span>,</span><br><span class="line">                            initializer=init_queue,</span><br><span class="line">                            initargs=(queue,)) <span class="keyword">as</span> executor:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;produce items&#x27;</span>)</span><br><span class="line">        <span class="keyword">for</span> i, item <span class="keyword">in</span> <span class="built_in">enumerate</span>(file_map.items()):</span><br><span class="line">            executor.submit(produce, i, path, item)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;done producing items&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;queue size:&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(queue.qsize()))</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(path + <span class="string">&#x27;\\&#x27;</span> + <span class="string">&#x27;&#123;&#125;_bugs_info.csv&#x27;</span>.<span class="built_in">format</span>(path.split(<span class="string">&#x27;\\&#x27;</span>)[-<span class="number">1</span>]), <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>, newline=<span class="string">&#x27;&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        writer = csv.writer(f)</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> queue.empty():</span><br><span class="line">            data = queue.get()</span><br><span class="line">            <span class="keyword">if</span> data:</span><br><span class="line">                writer.writerow(data)</span><br><span class="line"></span><br><span class="line">    time_elapsed = datetime.datetime.now() - time_start</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Elapsed time in seconds &#123;&#125; to run the script:&#x27;</span>.<span class="built_in">format</span>(time_elapsed.seconds))</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="backward-slice-py"><code>backward-slice.py</code></h5><p>有很多文件读写时没有规定编码导致的报错，以及前文提到的不同os的路径分隔符问题</p><p>win可用代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> understand</span><br><span class="line"><span class="keyword">import</span> traceback</span><br><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> difflib <span class="keyword">import</span> get_close_matches, ndiff</span><br><span class="line"><span class="keyword">import</span> concurrent.futures</span><br><span class="line"></span><br><span class="line">csv.field_size_limit(<span class="number">1000000</span>)</span><br><span class="line">REL_KIND = [<span class="string">&#x27;web Javascript Definein&#x27;</span>, <span class="string">&#x27;web Javascript Setby&#x27;</span>, <span class="string">&#x27;web Javascript Modifyby&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">safe_list_get</span>(<span class="params">arr, idx</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> arr[idx]</span><br><span class="line">    <span class="keyword">except</span> IndexError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_patch_from_diff</span>(<span class="params">diff</span>):</span><br><span class="line">    buggy_line = <span class="literal">None</span></span><br><span class="line">    fixed_line = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> diff.split(<span class="string">&#x27;\n&#x27;</span>):</span><br><span class="line">        <span class="keyword">if</span> line.startswith(<span class="string">&#x27;-&#x27;</span>):</span><br><span class="line">            buggy_line = line.lstrip(<span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">        <span class="keyword">elif</span> line.startswith(<span class="string">&#x27;+&#x27;</span>):</span><br><span class="line">            fixed_line = line.lstrip(<span class="string">&#x27;+&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> buggy_line, fixed_line</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BackwardSlicing</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, db, file, buggy_line_num</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self.file = file</span><br><span class="line">        self.db = db</span><br><span class="line">        self.buggy_line_num = buggy_line_num</span><br><span class="line">        self.method_lines = []</span><br><span class="line">        self.loops = &#123;&#125;</span><br><span class="line">        self.conds = &#123;&#125;</span><br><span class="line">        self.conditional_scope = &#123;&#125;</span><br><span class="line">        self.statement_closure = &#123;&#125;</span><br><span class="line">        self.scope = &#123;&#125;</span><br><span class="line">        self.method_start_line_num = -<span class="number">1</span></span><br><span class="line">        self.function_variables = []</span><br><span class="line">        self.has_function_call = <span class="literal">False</span></span><br><span class="line">        self.else_lines = <span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> lexeme <span class="keyword">in</span> file.lexer():</span><br><span class="line">            <span class="keyword">if</span> lexeme.line_begin() == buggy_line_num:</span><br><span class="line">                <span class="keyword">if</span> lexeme.token() == <span class="string">&#x27;Identifier&#x27;</span> <span class="keyword">and</span> lexeme.ent() <span class="keyword">and</span> lexeme.ent().parent() <span class="keyword">and</span> lexeme.ent().parent().kindname() <span class="keyword">in</span> [</span><br><span class="line">                    <span class="string">&#x27;Function&#x27;</span>, <span class="string">&#x27;Class&#x27;</span>, <span class="string">&#x27;File&#x27;</span>]:</span><br><span class="line">                    lines = <span class="built_in">set</span>()</span><br><span class="line">                    <span class="keyword">for</span> ref <span class="keyword">in</span> lexeme.ent().parent().refs():</span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">not</span> self.method_start_line_num:</span><br><span class="line">                            self.method_start_line_num = ref.line()</span><br><span class="line">                        <span class="keyword">if</span> ref.kind().longname() <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">&#x27;web Javascript Callby Nondynamic&#x27;</span>, <span class="string">&#x27;web Javascript Useby&#x27;</span>,</span><br><span class="line">                                                         <span class="string">&#x27;web Javascript Useby Deref Partial&#x27;</span>]:</span><br><span class="line">                            lines.add(ref.line())</span><br><span class="line">                    self.method_lines = <span class="built_in">sorted</span>(lines)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_outermost_parent</span>(<span class="params">self, first_line</span>):</span><br><span class="line">        <span class="keyword">for</span> lexeme <span class="keyword">in</span> self.file.lexer():</span><br><span class="line">            <span class="keyword">if</span> lexeme.line_begin() == first_line <span class="keyword">and</span> lexeme.token() <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">&#x27;Whitespace&#x27;</span>, <span class="string">&#x27;Newline&#x27;</span>]:</span><br><span class="line">                <span class="keyword">if</span> lexeme.ent() <span class="keyword">and</span> lexeme.ent().parent():</span><br><span class="line">                    <span class="keyword">if</span> lexeme.ent().parent().kindname() == <span class="string">&#x27;File&#x27;</span>:</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">                    <span class="keyword">elif</span> lexeme.ent().parent().kindname() != <span class="string">&#x27;File&#x27;</span>:</span><br><span class="line">                        <span class="keyword">return</span> lexeme.ent().parent().refs()[<span class="number">0</span>].line()</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># For cases when the . goes to next line, for example,</span></span><br><span class="line">    <span class="comment"># array</span></span><br><span class="line">    <span class="comment">#  .find(a =&gt; a !== 2)</span></span><br><span class="line">    <span class="comment">#  .map(a =&gt; a + 1)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_object_beginning</span>(<span class="params">self, line_number</span>):</span><br><span class="line">        <span class="keyword">for</span> lexeme <span class="keyword">in</span> self.file.lexer():</span><br><span class="line">            <span class="keyword">if</span> lexeme.line_begin() == line_number:</span><br><span class="line">                <span class="keyword">if</span> lexeme.token() <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">&#x27;Whitespace&#x27;</span>, <span class="string">&#x27;Newline&#x27;</span>]:</span><br><span class="line">                    <span class="keyword">if</span> lexeme.text() == <span class="string">&#x27;.&#x27;</span> <span class="keyword">and</span> lexeme.previous().token() == <span class="string">&#x27;Whitespace&#x27;</span>:</span><br><span class="line">                        <span class="keyword">return</span> self._get_object_beginning(line_number - <span class="number">1</span>)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="keyword">return</span> line_number</span><br><span class="line"></span><br><span class="line">                        <span class="comment"># Find all variables in the line</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_variable_entities</span>(<span class="params">self, line_number</span>):</span><br><span class="line">        variables = []</span><br><span class="line">        <span class="keyword">for</span> lexeme <span class="keyword">in</span> self.file.lexer():</span><br><span class="line">            <span class="keyword">if</span> lexeme.line_begin() == line_number:</span><br><span class="line">                <span class="keyword">if</span> lexeme.token() == <span class="string">&#x27;Identifier&#x27;</span> <span class="keyword">and</span> lexeme.ent():</span><br><span class="line">                    variables.append(lexeme.ent())</span><br><span class="line">                <span class="keyword">if</span> lexeme.ent() <span class="keyword">and</span> lexeme.ent().kindname() == <span class="string">&#x27;Property&#x27;</span>:</span><br><span class="line">                    variables.append(lexeme.ent().parent())</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> variables</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_within_loop</span>(<span class="params">self, line_num</span>):</span><br><span class="line">        loop_lines = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> self.loops.items():</span><br><span class="line">            <span class="keyword">if</span> i[<span class="number">1</span>].get(<span class="string">&#x27;line_num_begin&#x27;</span>) <span class="keyword">and</span> i[<span class="number">1</span>].get(<span class="string">&#x27;line_num_end&#x27;</span>) <span class="keyword">and</span> line_num:</span><br><span class="line">                <span class="keyword">if</span> line_num &gt;= <span class="built_in">int</span>(i[<span class="number">1</span>][<span class="string">&#x27;line_num_begin&#x27;</span>]) <span class="keyword">and</span> line_num &lt;= <span class="built_in">int</span>(i[<span class="number">1</span>][<span class="string">&#x27;line_num_end&#x27;</span>]):</span><br><span class="line">                    loop_lines.append((i[<span class="number">1</span>][<span class="string">&#x27;line_num_begin&#x27;</span>], i[<span class="number">1</span>][<span class="string">&#x27;line_num_end&#x27;</span>]))</span><br><span class="line">        <span class="keyword">return</span> loop_lines</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_within_scope</span>(<span class="params">self, line_num</span>):</span><br><span class="line">        scope_lines = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> self.scope.items():</span><br><span class="line">            <span class="keyword">if</span> i[<span class="number">1</span>].get(<span class="string">&#x27;line_num_begin&#x27;</span>) <span class="keyword">and</span> i[<span class="number">1</span>].get(<span class="string">&#x27;line_num_end&#x27;</span>) <span class="keyword">and</span> line_num:</span><br><span class="line">                <span class="keyword">if</span> line_num &gt;= <span class="built_in">int</span>(i[<span class="number">1</span>][<span class="string">&#x27;line_num_begin&#x27;</span>]) <span class="keyword">and</span> line_num &lt;= <span class="built_in">int</span>(i[<span class="number">1</span>][<span class="string">&#x27;line_num_end&#x27;</span>]):</span><br><span class="line">                    scope_lines.append((i[<span class="number">1</span>][<span class="string">&#x27;line_num_begin&#x27;</span>], i[<span class="number">1</span>][<span class="string">&#x27;line_num_end&#x27;</span>], i[<span class="number">1</span>][<span class="string">&#x27;is_variable&#x27;</span>]))</span><br><span class="line">        <span class="keyword">return</span> scope_lines</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_within_conditional</span>(<span class="params">self, line_num</span>):</span><br><span class="line">        cond_lines = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> self.conds.items():</span><br><span class="line">            <span class="keyword">if</span> i[<span class="number">1</span>].get(<span class="string">&#x27;line_num_begin&#x27;</span>) <span class="keyword">and</span> i[<span class="number">1</span>].get(<span class="string">&#x27;line_num_end&#x27;</span>) <span class="keyword">and</span> line_num:</span><br><span class="line">                <span class="keyword">if</span> line_num &gt;= <span class="built_in">int</span>(i[<span class="number">1</span>][<span class="string">&#x27;line_num_begin&#x27;</span>]) <span class="keyword">and</span> line_num &lt;= <span class="built_in">int</span>(i[<span class="number">1</span>][<span class="string">&#x27;line_num_end&#x27;</span>]):</span><br><span class="line">                    cond_lines.append((i[<span class="number">1</span>][<span class="string">&#x27;line_num_begin&#x27;</span>], i[<span class="number">1</span>][<span class="string">&#x27;line_num_end&#x27;</span>]))</span><br><span class="line">                    <span class="keyword">if</span> <span class="string">&#x27;else&#x27;</span> <span class="keyword">in</span> i[<span class="number">0</span>]:</span><br><span class="line">                        self.else_lines.add(i[<span class="number">1</span>][<span class="string">&#x27;line_num_begin&#x27;</span>])</span><br><span class="line">        <span class="keyword">return</span> cond_lines</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_conditional_by_else</span>(<span class="params">self, lines</span>):</span><br><span class="line">        updated_lines = lines.copy()</span><br><span class="line">        common_lines_between_current_and_else_lines = self.else_lines.intersection(lines)</span><br><span class="line">        <span class="keyword">for</span> line_num <span class="keyword">in</span> common_lines_between_current_and_else_lines:</span><br><span class="line">            <span class="keyword">for</span> cond_type_line_map <span class="keyword">in</span> self.conditional_scope.values():</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&#x27;else&#x27;</span> <span class="keyword">in</span> cond_type_line_map:</span><br><span class="line">                    last_index = <span class="built_in">len</span>(cond_type_line_map[<span class="string">&#x27;else&#x27;</span>]) - <span class="number">1</span></span><br><span class="line">                    <span class="keyword">for</span> idx, val <span class="keyword">in</span> <span class="built_in">enumerate</span>(cond_type_line_map[<span class="string">&#x27;else&#x27;</span>]):</span><br><span class="line">                        <span class="keyword">if</span> val[<span class="string">&#x27;line_num_begin&#x27;</span>] == line_num:</span><br><span class="line">                            start_if = cond_type_line_map[<span class="string">&#x27;if&#x27;</span>][<span class="string">&#x27;line_num_begin&#x27;</span>]</span><br><span class="line">                            <span class="keyword">if</span> start_if <span class="keyword">not</span> <span class="keyword">in</span> lines:</span><br><span class="line">                                c = start_if</span><br><span class="line">                                <span class="keyword">while</span> c &lt; line_num:</span><br><span class="line">                                    updated_lines.add(c)</span><br><span class="line">                                    c += <span class="number">1</span></span><br><span class="line">                            <span class="keyword">if</span> idx == last_index <span class="keyword">and</span> cond_type_line_map.get(<span class="string">&#x27;endif&#x27;</span>):</span><br><span class="line">                                updated_lines.add(cond_type_line_map[<span class="string">&#x27;endif&#x27;</span>][<span class="string">&#x27;line_num_begin&#x27;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> updated_lines</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_add_line</span>(<span class="params">self, line_numbers</span>):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">_on_add</span>(<span class="params">line_num</span>):</span><br><span class="line">            is_within_loop = self.is_within_loop(line_num)</span><br><span class="line">            is_within_conditional = self.is_within_conditional(line_num)</span><br><span class="line">            is_within_scope = self.is_within_scope(line_num)</span><br><span class="line">            new_lines = <span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(is_within_loop):  <span class="comment"># if a line is start of the loop, add the end of the loop (curly brace)</span></span><br><span class="line">                <span class="keyword">for</span> l <span class="keyword">in</span> is_within_loop:</span><br><span class="line">                    new_lines.add(l[<span class="number">0</span>])</span><br><span class="line">                    new_lines.add(l[<span class="number">1</span>])</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(is_within_conditional):  <span class="comment"># if a line is start of the loop, add the end of the loop (curly brace)</span></span><br><span class="line">                <span class="keyword">for</span> l <span class="keyword">in</span> is_within_conditional:</span><br><span class="line">                    new_lines.add(l[<span class="number">0</span>])</span><br><span class="line">                    new_lines.add(l[<span class="number">1</span>])</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(is_within_scope):  <span class="comment"># if a line is start of the scope, add the end of the scope (curly brace)</span></span><br><span class="line">                <span class="keyword">for</span> l <span class="keyword">in</span> is_within_scope:</span><br><span class="line">                    new_lines.add(l[<span class="number">0</span>])</span><br><span class="line">                    i = l[<span class="number">0</span>]</span><br><span class="line">                    <span class="keyword">if</span> l[<span class="number">2</span>]:</span><br><span class="line">                        <span class="keyword">while</span> i &lt;= l[<span class="number">1</span>]:</span><br><span class="line">                            new_lines.add(i)</span><br><span class="line">                            i += <span class="number">1</span></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        new_lines.add(l[<span class="number">1</span>])</span><br><span class="line">            <span class="keyword">return</span> new_lines</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(line_numbers) <span class="keyword">is</span> <span class="built_in">set</span>:</span><br><span class="line">            updated_set = <span class="built_in">set</span>()</span><br><span class="line">            <span class="keyword">for</span> l <span class="keyword">in</span> line_numbers:</span><br><span class="line">                updated_set = _on_add(l).union(updated_set)</span><br><span class="line">            <span class="keyword">return</span> updated_set</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> _on_add(line_numbers)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_statements</span>(<span class="params">self, lines</span>):</span><br><span class="line">        statements = []</span><br><span class="line">        line_to_col_map = &#123;&#125;  <span class="comment"># stores the lines where some parts of the line needs to be included (not the whole line)</span></span><br><span class="line">        updated_lines = lines.copy()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> line_num <span class="keyword">in</span> lines:</span><br><span class="line">            key = <span class="built_in">str</span>(line_num)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> self.has_function_call <span class="keyword">and</span> line_num <span class="keyword">in</span> self.function_variables:  <span class="comment"># for variables that are function calls, get the whole scope of the function</span></span><br><span class="line">                <span class="keyword">if</span> key <span class="keyword">in</span> self.scope <span class="keyword">and</span> self.scope[key] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    i = line_num</span><br><span class="line">                    <span class="keyword">while</span> i &lt; self.scope[key].get(<span class="string">&#x27;line_num_begin&#x27;</span>):</span><br><span class="line">                        updated_lines.add(i)</span><br><span class="line">                        i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">            updated_lines = self.on_add_line(line_num).union(updated_lines)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> key <span class="keyword">in</span> self.conds <span class="keyword">and</span> self.conds[key][</span><br><span class="line">                <span class="string">&#x27;line_num_end&#x27;</span>]:  <span class="comment"># if a line is start of a conditional, add the end of the loop (curly brace)</span></span><br><span class="line">                line = self.conds[key][<span class="string">&#x27;line_num_end&#x27;</span>]</span><br><span class="line">                updated_lines.add(line)</span><br><span class="line">                <span class="keyword">if</span> self.conds[key].get(</span><br><span class="line">                        <span class="string">&#x27;column_num_begin&#x27;</span>) <span class="keyword">and</span> line <span class="keyword">not</span> <span class="keyword">in</span> line_to_col_map:  <span class="comment"># this takes care of the column end</span></span><br><span class="line">                    line_to_col_map[line] = &#123;</span><br><span class="line">                        <span class="string">&#x27;column_num_begin&#x27;</span>: self.conds[key][<span class="string">&#x27;column_num_begin&#x27;</span>],</span><br><span class="line">                        <span class="string">&#x27;column_num_end&#x27;</span>: self.conds[key][<span class="string">&#x27;column_num_end&#x27;</span>]</span><br><span class="line">                    &#125;</span><br><span class="line">            <span class="keyword">if</span> key <span class="keyword">in</span> self.scope <span class="keyword">and</span> self.scope[key] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> <span class="string">&#x27;line_num_end&#x27;</span> <span class="keyword">in</span> self.scope[</span><br><span class="line">                key]:  <span class="comment"># if a line falls within a method scope, add the end of the line to the list</span></span><br><span class="line">                line = self.scope[key][<span class="string">&#x27;line_num_end&#x27;</span>]</span><br><span class="line">                updated_lines.add(line)</span><br><span class="line">                <span class="keyword">if</span> self.scope[key].get(<span class="string">&#x27;column_num_begin&#x27;</span>) <span class="keyword">and</span> self.scope[key].get(</span><br><span class="line">                        <span class="string">&#x27;column_num_end&#x27;</span>) <span class="keyword">and</span> line <span class="keyword">not</span> <span class="keyword">in</span> line_to_col_map:  <span class="comment"># this takes care of the column end</span></span><br><span class="line">                    line_to_col_map[line] = &#123;</span><br><span class="line">                        <span class="string">&#x27;column_num_begin&#x27;</span>: self.scope[key][<span class="string">&#x27;column_num_begin&#x27;</span>],</span><br><span class="line">                        <span class="string">&#x27;column_num_end&#x27;</span>: self.scope[key][<span class="string">&#x27;column_num_end&#x27;</span>]</span><br><span class="line">                    &#125;</span><br><span class="line">                updated_lines.add(self.scope[key][<span class="string">&#x27;line_num_end&#x27;</span>])</span><br><span class="line"></span><br><span class="line">                <span class="comment"># check if the lines fall within an if block, then add the else blocks too</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> self.conds:</span><br><span class="line">                block_start = <span class="built_in">int</span>(i.split(<span class="string">&#x27;_&#x27;</span>)[-<span class="number">1</span>]) <span class="keyword">if</span> i.startswith(<span class="string">&#x27;else_&#x27;</span>) <span class="keyword">else</span> <span class="built_in">int</span>(i)</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">int</span>(line_num) &gt;= block_start <span class="keyword">and</span> <span class="built_in">int</span>(line_num) &lt;= <span class="built_in">int</span>(self.conds[i][<span class="string">&#x27;line_num_end&#x27;</span>]):</span><br><span class="line">                    updated_lines.add(block_start)</span><br><span class="line">                    updated_lines.add(self.conds[i][<span class="string">&#x27;line_num_end&#x27;</span>])</span><br><span class="line">                    <span class="keyword">if</span> self.conds[i].get(<span class="string">&#x27;column_num_end&#x27;</span>):</span><br><span class="line">                        <span class="keyword">if</span> block_start <span class="keyword">in</span> line_to_col_map:</span><br><span class="line">                            <span class="keyword">del</span> line_to_col_map[block_start]</span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            line_to_col_map[self.conds[i][<span class="string">&#x27;line_num_end&#x27;</span>]] = &#123;</span><br><span class="line">                                <span class="string">&#x27;column_num_begin&#x27;</span>: self.conds[i][<span class="string">&#x27;column_num_begin&#x27;</span>],</span><br><span class="line">                                <span class="string">&#x27;column_num_end&#x27;</span>: self.conds[i][<span class="string">&#x27;column_num_end&#x27;</span>]</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment"># this takes care of single line statement end</span></span><br><span class="line">            <span class="keyword">for</span> statement_continuations <span class="keyword">in</span> self.statement_closure.values():</span><br><span class="line">                <span class="keyword">if</span> line_num <span class="keyword">in</span> statement_continuations:</span><br><span class="line">                    <span class="keyword">for</span> s <span class="keyword">in</span> statement_continuations:</span><br><span class="line">                        updated_lines.add(s)</span><br><span class="line">                        updated_lines = self.on_add_line(s).union(updated_lines)</span><br><span class="line"></span><br><span class="line">        updated_lines = <span class="built_in">set</span>(<span class="built_in">sorted</span>([i <span class="keyword">for</span> i <span class="keyword">in</span> updated_lines <span class="keyword">if</span> i]))</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">int</span>(self.method_start_line_num) <span class="keyword">in</span> updated_lines:</span><br><span class="line">            updated_lines.add(self.method_lines[-<span class="number">1</span>])</span><br><span class="line">            updated_lines = self.on_add_line(self.method_lines[-<span class="number">1</span>]).union(updated_lines)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># this takes care of object start</span></span><br><span class="line">        start_of_line = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">for</span> line_num <span class="keyword">in</span> <span class="built_in">list</span>(updated_lines.copy()):</span><br><span class="line">            <span class="keyword">for</span> lexeme <span class="keyword">in</span> self.file.lexer():</span><br><span class="line">                <span class="keyword">if</span> lexeme.line_begin() == line_num:</span><br><span class="line">                    <span class="keyword">if</span> lexeme.text() == <span class="string">&#x27;.&#x27;</span> <span class="keyword">and</span> lexeme.previous().token() == <span class="string">&#x27;Whitespace&#x27;</span>:</span><br><span class="line">                        start_of_line = self._get_object_beginning(line_num - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> start_of_line:</span><br><span class="line">                            updated_lines.add(start_of_line)</span><br><span class="line">                            updated_lines = self.on_add_line(start_of_line).union(updated_lines)</span><br><span class="line">                            start_of_line = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        parent_line = self._get_outermost_parent(<span class="built_in">min</span>(updated_lines))</span><br><span class="line">        <span class="keyword">if</span> parent_line <span class="keyword">and</span> self.scope.get(<span class="built_in">str</span>(parent_line)):</span><br><span class="line">            updated_lines.add(parent_line)</span><br><span class="line">            end_line = self.scope[<span class="built_in">str</span>(parent_line)].get(<span class="string">&#x27;line_num_end&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> end_line:</span><br><span class="line">                updated_lines.add(end_line)</span><br><span class="line"></span><br><span class="line">        lines_with_related_vars = self.get_related_var_lines(<span class="built_in">set</span>(updated_lines), <span class="built_in">set</span>(updated_lines), show_use_by=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        unified_lines = self.on_add_line(lines_with_related_vars.difference(updated_lines)).union(</span><br><span class="line">            lines_with_related_vars)</span><br><span class="line">        final_lines = self.find_conditional_by_else(unified_lines)</span><br><span class="line">        updated_lines = <span class="built_in">sorted</span>([i <span class="keyword">for</span> i <span class="keyword">in</span> final_lines <span class="keyword">if</span> i])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> line_num <span class="keyword">in</span> updated_lines:</span><br><span class="line">            statement = <span class="string">&#x27;&#x27;</span></span><br><span class="line">            <span class="keyword">for</span> lexeme <span class="keyword">in</span> self.file.lexer():</span><br><span class="line">                <span class="keyword">if</span> lexeme.line_begin() == line_num:</span><br><span class="line">                    <span class="keyword">if</span> lexeme.token() <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">&#x27;Newline&#x27;</span>]:</span><br><span class="line">                        <span class="keyword">if</span> line_num <span class="keyword">in</span> line_to_col_map:</span><br><span class="line">                            <span class="keyword">if</span> lexeme.column_end() &lt;= line_to_col_map[line_num][<span class="string">&#x27;column_num_end&#x27;</span>]:</span><br><span class="line">                                statement += lexeme.text()</span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            statement += lexeme.text()</span><br><span class="line"></span><br><span class="line">            statements.append(statement.rstrip())</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> statements</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">analyze_closure</span>(<span class="params">self</span>):</span><br><span class="line">        self._record_scope()</span><br><span class="line">        self._record_conditional_scope()</span><br><span class="line">        <span class="keyword">for</span> line_num <span class="keyword">in</span> self.method_lines:</span><br><span class="line">            <span class="keyword">for</span> lexeme <span class="keyword">in</span> self.file.lexer():</span><br><span class="line">                <span class="keyword">if</span> lexeme.line_begin() == line_num:</span><br><span class="line">                    <span class="keyword">if</span> lexeme.token() <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">&#x27;Whitespace&#x27;</span>, <span class="string">&#x27;Newline&#x27;</span>]:</span><br><span class="line">                        <span class="keyword">if</span> lexeme.token() == <span class="string">&#x27;Keyword&#x27;</span> <span class="keyword">and</span> lexeme.text() <span class="keyword">in</span> [<span class="string">&#x27;for&#x27;</span>, <span class="string">&#x27;while&#x27;</span>]:</span><br><span class="line">                            self._record_loop_closure(lexeme, line_num)</span><br><span class="line">                        <span class="keyword">elif</span> lexeme.text() == <span class="string">&#x27;if&#x27;</span>:</span><br><span class="line">                            self._record_if_closure(lexeme, line_num)</span><br><span class="line">                            self._record_else_closure(lexeme)</span><br><span class="line">                    self._record_line_closure(lexeme, line_num)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_record_line_closure</span>(<span class="params">self, lexeme, line_num</span>):</span><br><span class="line">        line_key = <span class="built_in">str</span>(line_num)</span><br><span class="line">        <span class="keyword">if</span> line_key <span class="keyword">not</span> <span class="keyword">in</span> self.statement_closure:</span><br><span class="line">            self.statement_closure[line_key] = []</span><br><span class="line">            <span class="keyword">while</span> lexeme <span class="keyword">and</span> lexeme.line_begin() &lt; (self.method_lines[-<span class="number">1</span>] + <span class="number">1</span>) <span class="keyword">and</span> lexeme.line_begin() &gt; \</span><br><span class="line">                    self.method_lines[<span class="number">0</span>]:</span><br><span class="line">                <span class="keyword">if</span> lexeme.text() <span class="keyword">in</span> [<span class="string">&#x27;&#123;&#x27;</span>, <span class="string">&#x27;&#125;&#x27;</span>, <span class="string">&#x27;if&#x27;</span>, <span class="string">&#x27;else&#x27;</span>, <span class="string">&#x27;while&#x27;</span>, <span class="string">&#x27;try&#x27;</span>,</span><br><span class="line">                                     <span class="string">&#x27;catch&#x27;</span>] <span class="keyword">and</span> lexeme.line_begin() == line_num:</span><br><span class="line">                    <span class="keyword">del</span> self.statement_closure[line_key]</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> lexeme.text() == <span class="string">&#x27;;&#x27;</span>:</span><br><span class="line">                    self.statement_closure[line_key] = <span class="built_in">list</span>(<span class="built_in">range</span>(line_num, lexeme.line_begin() + <span class="number">1</span>))</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                lexeme = lexeme.<span class="built_in">next</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_record_scope</span>(<span class="params">self</span>):</span><br><span class="line">        brace_map = &#123;<span class="string">&#x27;&#123;&#x27;</span>: <span class="string">&#x27;&#125;&#x27;</span>, <span class="string">&#x27;[&#x27;</span>: <span class="string">&#x27;]&#x27;</span>, <span class="string">&#x27;(&#x27;</span>: <span class="string">&#x27;)&#x27;</span>&#125;</span><br><span class="line">        stack = []</span><br><span class="line">        line_stack = []</span><br><span class="line">        is_variable = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> lexeme <span class="keyword">in</span> self.file.lexer():</span><br><span class="line">            line_key = <span class="built_in">str</span>(lexeme.line_begin())</span><br><span class="line">            <span class="keyword">if</span> lexeme.token() == <span class="string">&#x27;Keyword&#x27;</span> <span class="keyword">and</span> lexeme.text() == <span class="string">&#x27;function&#x27;</span>:</span><br><span class="line">                self.function_variables.append(lexeme.line_begin())</span><br><span class="line">            <span class="keyword">if</span> lexeme.ent() <span class="keyword">and</span> lexeme.ent().kindname() == <span class="string">&#x27;Variable&#x27;</span> <span class="keyword">and</span> lexeme.ent().<span class="built_in">type</span>() <span class="keyword">in</span> [<span class="string">&#x27;&#123;&#125;&#x27;</span>, <span class="string">&#x27;[&#123;&#125;]&#x27;</span>, <span class="string">&#x27;[]&#x27;</span>]:</span><br><span class="line">                is_variable[line_key] = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">if</span> lexeme.text() <span class="keyword">in</span> [<span class="string">&#x27;&#123;&#x27;</span>, <span class="string">&#x27;(&#x27;</span>, <span class="string">&#x27;[&#x27;</span>]:</span><br><span class="line">                stack.append(lexeme.text())</span><br><span class="line">                line_stack.append(line_key)</span><br><span class="line">                self.scope[line_key] = &#123;</span><br><span class="line">                    <span class="string">&#x27;is_variable&#x27;</span>: is_variable.get(line_key, <span class="literal">False</span>),</span><br><span class="line">                    <span class="string">&#x27;line_num_begin&#x27;</span>: lexeme.line_begin(),</span><br><span class="line">                    <span class="string">&#x27;column_num_begin&#x27;</span>: lexeme.column_begin(),</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">elif</span> lexeme.text() <span class="keyword">in</span> [<span class="string">&#x27;&#125;&#x27;</span>, <span class="string">&#x27;]&#x27;</span>, <span class="string">&#x27;)&#x27;</span>]:</span><br><span class="line">                <span class="keyword">if</span> stack <span class="keyword">and</span> brace_map[stack[-<span class="number">1</span>]] == lexeme.text():</span><br><span class="line">                    self.scope[line_stack[-<span class="number">1</span>]][<span class="string">&#x27;line_num_end&#x27;</span>] = lexeme.line_begin()</span><br><span class="line">                    <span class="keyword">if</span> lexeme.<span class="built_in">next</span>() <span class="keyword">and</span> lexeme.<span class="built_in">next</span>().<span class="built_in">next</span>() <span class="keyword">and</span> lexeme.<span class="built_in">next</span>().token() == <span class="string">&#x27;Newline&#x27;</span> <span class="keyword">and</span> lexeme.<span class="built_in">next</span>().<span class="built_in">next</span>().token() != <span class="string">&#x27;Indent&#x27;</span>:</span><br><span class="line">                        self.scope[line_stack[-<span class="number">1</span>]][<span class="string">&#x27;column_num_end&#x27;</span>] = lexeme.column_end()</span><br><span class="line"></span><br><span class="line">                    stack.pop()</span><br><span class="line">                    line_stack.pop()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_record_loop_closure</span>(<span class="params">self, lexeme, line_num</span>):</span><br><span class="line">        loop_key = <span class="built_in">str</span>(line_num)</span><br><span class="line">        self.loops[loop_key] = &#123;</span><br><span class="line">            <span class="string">&#x27;line_num_begin&#x27;</span>: line_num,</span><br><span class="line">            <span class="string">&#x27;line_num_end&#x27;</span>: line_num,</span><br><span class="line">            <span class="string">&#x27;enclosing_brace_count&#x27;</span>: <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> lexeme <span class="keyword">and</span> lexeme.line_begin() &lt; self.method_lines[-<span class="number">1</span>]:</span><br><span class="line">            <span class="keyword">if</span> lexeme.text() == <span class="string">&#x27;&#123;&#x27;</span>:</span><br><span class="line">                self.loops[loop_key][<span class="string">&#x27;enclosing_brace_count&#x27;</span>] += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> lexeme.text() == <span class="string">&#x27;&#125;&#x27;</span> <span class="keyword">and</span> self.loops[loop_key][<span class="string">&#x27;enclosing_brace_count&#x27;</span>] &gt; <span class="number">0</span>:</span><br><span class="line">                self.loops[loop_key][<span class="string">&#x27;enclosing_brace_count&#x27;</span>] -= <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> self.loops[loop_key][<span class="string">&#x27;enclosing_brace_count&#x27;</span>] == <span class="number">0</span>:</span><br><span class="line">                    self.loops[loop_key][<span class="string">&#x27;line_num_end&#x27;</span>] = lexeme.line_begin()</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            lexeme = lexeme.<span class="built_in">next</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_record_conditional_scope</span>(<span class="params">self</span>):</span><br><span class="line">        if_tracker_stack = []</span><br><span class="line">        self.conditional_scope = &#123;&#125;</span><br><span class="line">        else_if_tracker = []</span><br><span class="line">        curr_if = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.parent_type == <span class="string">&#x27;File&#x27;</span>:</span><br><span class="line">            <span class="keyword">for</span> entity <span class="keyword">in</span> self.db.ents(<span class="string">&#x27;file&#x27;</span>):</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">str</span>(self.file) <span class="keyword">in</span> <span class="built_in">str</span>(entity):</span><br><span class="line">                    self.extract_control_flow(entity)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> lexeme <span class="keyword">in</span> self.file.lexer():</span><br><span class="line">            <span class="keyword">if</span> lexeme.token() <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">&#x27;Whitespace&#x27;</span>, <span class="string">&#x27;Newline&#x27;</span>]:</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> lexeme.ent():</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                control_flow_graph = lexeme.ent().freetext(<span class="string">&#x27;CGraph&#x27;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> self.parent_type == <span class="string">&#x27;Function&#x27;</span>:</span><br><span class="line">                    self.extract_control_flow(lexeme.ent())</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> control_flow_graph:</span><br><span class="line">                    <span class="keyword">for</span> parser <span class="keyword">in</span> control_flow_graph.split(<span class="string">&#x27;;&#x27;</span>):</span><br><span class="line">                        parser_nums = []</span><br><span class="line">                        <span class="keyword">for</span> x <span class="keyword">in</span> parser.split(<span class="string">&#x27;,&#x27;</span>):  <span class="comment"># node_type, start_line, start_col, end_line, end_col</span></span><br><span class="line">                            <span class="keyword">if</span> x != <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">                                <span class="keyword">try</span>:</span><br><span class="line">                                    parser_nums.append(<span class="built_in">int</span>(x))</span><br><span class="line">                                <span class="keyword">except</span> ValueError:</span><br><span class="line">                                    parser_nums = []</span><br><span class="line">                                    <span class="keyword">break</span></span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">not</span> parser_nums <span class="keyword">or</span> <span class="built_in">len</span>(parser_nums) &lt; <span class="number">5</span>:</span><br><span class="line">                            <span class="keyword">continue</span></span><br><span class="line">                        <span class="keyword">if</span> parser_nums[<span class="number">0</span>] == <span class="number">5</span>:</span><br><span class="line">                            <span class="keyword">if</span> parser_nums[<span class="number">1</span>] <span class="keyword">not</span> <span class="keyword">in</span> else_if_tracker:</span><br><span class="line">                                if_tracker_stack.append(parser_nums)</span><br><span class="line">                                curr_if.append(parser_nums)</span><br><span class="line">                                self.conditional_scope[parser_nums[<span class="number">1</span>]] = &#123;</span><br><span class="line">                                    <span class="string">&#x27;if&#x27;</span>: &#123;</span><br><span class="line">                                        <span class="string">&#x27;line_num_begin&#x27;</span>: parser_nums[<span class="number">1</span>],</span><br><span class="line">                                        <span class="string">&#x27;column_num_begin&#x27;</span>: parser_nums[<span class="number">2</span>],</span><br><span class="line">                                        <span class="string">&#x27;line_num_end&#x27;</span>: parser_nums[<span class="number">3</span>],</span><br><span class="line">                                        <span class="string">&#x27;column_num_end&#x27;</span>: parser_nums[<span class="number">4</span>]</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                        <span class="keyword">elif</span> parser_nums[<span class="number">0</span>] == <span class="number">7</span> <span class="keyword">and</span> (<span class="built_in">len</span>(if_tracker_stack) <span class="keyword">or</span> curr_if):  <span class="comment"># 7 = else, 8 = endif</span></span><br><span class="line">                            <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">len</span>(curr_if):</span><br><span class="line">                                curr_if.append(if_tracker_stack[-<span class="number">1</span>])</span><br><span class="line">                            else_if_tracker.append(parser_nums[<span class="number">1</span>])</span><br><span class="line">                            current = curr_if.pop()</span><br><span class="line">                            <span class="keyword">if</span> <span class="string">&#x27;else&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> self.conditional_scope[current[<span class="number">1</span>]]:</span><br><span class="line">                                self.conditional_scope[current[<span class="number">1</span>]][<span class="string">&#x27;else&#x27;</span>] = [&#123;</span><br><span class="line">                                    <span class="string">&#x27;line_num_begin&#x27;</span>: parser_nums[<span class="number">1</span>],</span><br><span class="line">                                    <span class="string">&#x27;column_num_begin&#x27;</span>: parser_nums[<span class="number">2</span>],</span><br><span class="line">                                    <span class="string">&#x27;line_num_end&#x27;</span>: parser_nums[<span class="number">3</span>],</span><br><span class="line">                                    <span class="string">&#x27;column_num_end&#x27;</span>: parser_nums[<span class="number">4</span>]</span><br><span class="line">                                &#125;]</span><br><span class="line">                            <span class="keyword">else</span>:</span><br><span class="line">                                self.conditional_scope[current[<span class="number">1</span>]][<span class="string">&#x27;else&#x27;</span>].append(&#123;</span><br><span class="line">                                    <span class="string">&#x27;line_num_begin&#x27;</span>: parser_nums[<span class="number">1</span>],</span><br><span class="line">                                    <span class="string">&#x27;column_num_begin&#x27;</span>: parser_nums[<span class="number">2</span>],</span><br><span class="line">                                    <span class="string">&#x27;line_num_end&#x27;</span>: parser_nums[<span class="number">3</span>],</span><br><span class="line">                                    <span class="string">&#x27;column_num_end&#x27;</span>: parser_nums[<span class="number">4</span>]</span><br><span class="line">                                &#125;)</span><br><span class="line">                        <span class="keyword">elif</span> parser_nums[<span class="number">0</span>] == <span class="number">8</span> <span class="keyword">and</span> (<span class="built_in">len</span>(curr_if)):</span><br><span class="line">                            current = curr_if.pop()</span><br><span class="line">                            self.conditional_scope[current[<span class="number">1</span>]][<span class="string">&#x27;endif&#x27;</span>] = &#123;</span><br><span class="line">                                <span class="string">&#x27;line_num_begin&#x27;</span>: parser_nums[<span class="number">1</span>],</span><br><span class="line">                                <span class="string">&#x27;column_num_begin&#x27;</span>: parser_nums[<span class="number">2</span>],</span><br><span class="line">                                <span class="string">&#x27;line_num_end&#x27;</span>: parser_nums[<span class="number">3</span>],</span><br><span class="line">                                <span class="string">&#x27;column_num_end&#x27;</span>: parser_nums[<span class="number">4</span>]</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> <span class="built_in">len</span>(if_tracker_stack):</span><br><span class="line">                                if_tracker_stack.pop()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_lexeme_matcher</span>(<span class="params">self, lexeme, string, line_num, direction=<span class="string">&#x27;next&#x27;</span></span>):</span><br><span class="line">        <span class="keyword">while</span> lexeme:</span><br><span class="line">            <span class="keyword">if</span> lexeme.line_begin() == line_num:</span><br><span class="line">                <span class="keyword">if</span> lexeme.text() == string:</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> direction == <span class="string">&#x27;next&#x27;</span>:</span><br><span class="line">                lexeme = lexeme.<span class="built_in">next</span>()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                lexeme = lexeme.previous()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_matched_lexeme</span>(<span class="params">self, <span class="built_in">type</span>, lexeme, string, line_num, direction=<span class="string">&#x27;next&#x27;</span></span>):</span><br><span class="line">        matcher = lexeme.text() == string <span class="keyword">if</span> <span class="built_in">type</span> == <span class="string">&#x27;string&#x27;</span> <span class="keyword">else</span> lexeme.token() == string</span><br><span class="line">        <span class="keyword">while</span> lexeme:</span><br><span class="line">            <span class="keyword">if</span> lexeme.line_begin() == line_num:</span><br><span class="line">                <span class="keyword">if</span> matcher:</span><br><span class="line">                    <span class="keyword">return</span> lexeme</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> direction == <span class="string">&#x27;next&#x27;</span>:</span><br><span class="line">                lexeme = lexeme.<span class="built_in">next</span>()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                lexeme = lexeme.previous()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_record_if_closure</span>(<span class="params">self, lexeme, line_num</span>):</span><br><span class="line">        cond_key = <span class="built_in">str</span>(line_num)</span><br><span class="line">        self.conds[cond_key] = &#123;</span><br><span class="line">            <span class="string">&#x27;line_num_begin&#x27;</span>: line_num,</span><br><span class="line">            <span class="string">&#x27;line_num_end&#x27;</span>: line_num,</span><br><span class="line">            <span class="string">&#x27;column_num_begin&#x27;</span>: lexeme.column_begin(),</span><br><span class="line">            <span class="string">&#x27;column_num_end&#x27;</span>: lexeme.column_begin(),</span><br><span class="line">            <span class="string">&#x27;enclosing_brace_count&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if_without_braces = <span class="literal">False</span></span><br><span class="line">        has_braces = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">while</span> lexeme <span class="keyword">and</span> lexeme.line_begin() &lt; self.method_lines[-<span class="number">1</span>]:</span><br><span class="line">            <span class="keyword">if</span> lexeme.token() == <span class="string">&#x27;Newline&#x27;</span> <span class="keyword">and</span> self._lexeme_matcher(lexeme, <span class="string">&#x27;)&#x27;</span>, lexeme.line_begin(),</span><br><span class="line">                                                                    <span class="string">&#x27;previous&#x27;</span>) <span class="keyword">and</span> <span class="keyword">not</span> has_braces:</span><br><span class="line">                if_without_braces = <span class="literal">True</span></span><br><span class="line">                has_braces = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">if</span> if_without_braces <span class="keyword">and</span> lexeme.text() == <span class="string">&#x27;;&#x27;</span>:</span><br><span class="line">                self.conds[cond_key][<span class="string">&#x27;has_braces&#x27;</span>] = <span class="literal">False</span></span><br><span class="line">                self.conds[cond_key][<span class="string">&#x27;line_num_end&#x27;</span>] = lexeme.line_begin()</span><br><span class="line">                self.conds[cond_key][<span class="string">&#x27;column_num_end&#x27;</span>] = lexeme.column_end()</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> lexeme.text() == <span class="string">&#x27;&#123;&#x27;</span> <span class="keyword">and</span> <span class="keyword">not</span> if_without_braces:</span><br><span class="line">                has_braces = <span class="literal">True</span></span><br><span class="line">                self.conds[cond_key][<span class="string">&#x27;enclosing_brace_count&#x27;</span>] += <span class="number">1</span></span><br><span class="line">                self.conds[cond_key][<span class="string">&#x27;has_braces&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">if</span> lexeme.text() == <span class="string">&#x27;&#125;&#x27;</span> <span class="keyword">and</span> self.conds[cond_key][<span class="string">&#x27;enclosing_brace_count&#x27;</span>] &gt; <span class="number">0</span> <span class="keyword">and</span> <span class="keyword">not</span> if_without_braces:</span><br><span class="line">                self.conds[cond_key][<span class="string">&#x27;enclosing_brace_count&#x27;</span>] -= <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> self.conds[cond_key][<span class="string">&#x27;enclosing_brace_count&#x27;</span>] == <span class="number">0</span>:</span><br><span class="line">                    self.conds[cond_key][<span class="string">&#x27;line_num_end&#x27;</span>] = lexeme.line_begin()</span><br><span class="line">                    self.conds[cond_key][<span class="string">&#x27;column_num_end&#x27;</span>] = lexeme.column_end()</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            lexeme = lexeme.<span class="built_in">next</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_record_else_closure</span>(<span class="params">self, lexeme</span>):</span><br><span class="line">        <span class="keyword">while</span> lexeme <span class="keyword">and</span> lexeme.line_begin() &lt; self.method_lines[-<span class="number">1</span>]:</span><br><span class="line">            <span class="keyword">if</span> lexeme.text() == <span class="string">&#x27;else&#x27;</span>:</span><br><span class="line">                else_key = lexeme.text() + <span class="string">&#x27;_&#x27;</span> + <span class="built_in">str</span>(lexeme.line_begin())</span><br><span class="line">                lex_it = lexeme</span><br><span class="line">                self.conds[else_key] = &#123;&#125;</span><br><span class="line">                self.conds[else_key] = &#123;</span><br><span class="line">                    <span class="string">&#x27;column_num_begin&#x27;</span>: lexeme.column_begin(),</span><br><span class="line">                    <span class="string">&#x27;column_num_end&#x27;</span>: lexeme.column_end(),</span><br><span class="line">                    <span class="string">&#x27;line_num_begin&#x27;</span>: lexeme.line_begin()</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                else_without_braces = <span class="literal">False</span></span><br><span class="line">                has_braces = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">while</span> lex_it <span class="keyword">and</span> lex_it.line_begin() &lt; self.method_lines[-<span class="number">1</span>]:</span><br><span class="line">                    <span class="keyword">if</span> lex_it.token() != <span class="string">&#x27;Whitespace&#x27;</span>:</span><br><span class="line">                        <span class="keyword">if</span> lex_it.text() == <span class="string">&#x27;&#123;&#x27;</span> <span class="keyword">and</span> lex_it.previous().text() != <span class="string">&#x27;$&#x27;</span>:</span><br><span class="line">                            has_braces = <span class="literal">True</span></span><br><span class="line">                            self.conds[else_key][<span class="string">&#x27;has_braces&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">                            else_without_braces = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> lex_it.token() == <span class="string">&#x27;Newline&#x27;</span> <span class="keyword">and</span> <span class="keyword">not</span> has_braces:</span><br><span class="line">                            else_without_braces = <span class="literal">True</span></span><br><span class="line">                            self.conds[else_key][<span class="string">&#x27;has_braces&#x27;</span>] = <span class="literal">False</span></span><br><span class="line">                            matched_lexeme = self._get_matched_lexeme(<span class="string">&#x27;string&#x27;</span>, lex_it.<span class="built_in">next</span>(), <span class="string">&#x27;;&#x27;</span>,</span><br><span class="line">                                                                      lex_it.line_end() + <span class="number">1</span>) <span class="keyword">or</span> self._get_matched_lexeme(</span><br><span class="line">                                <span class="string">&#x27;token&#x27;</span>, lex_it.<span class="built_in">next</span>(), <span class="string">&#x27;Newline&#x27;</span>, lex_it.line_end() + <span class="number">1</span>)</span><br><span class="line">                            <span class="keyword">if</span> matched_lexeme:</span><br><span class="line">                                self.conds[else_key][<span class="string">&#x27;column_num_end&#x27;</span>] = matched_lexeme.column_end()</span><br><span class="line">                                self.conds[else_key][<span class="string">&#x27;line_num_end&#x27;</span>] = lex_it.line_end() + <span class="number">1</span></span><br><span class="line">                                <span class="keyword">break</span></span><br><span class="line">                            lex_it = lex_it.<span class="built_in">next</span>()</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> else_without_braces <span class="keyword">and</span> (</span><br><span class="line">                                lex_it.text() == <span class="string">&#x27;;&#x27;</span> <span class="keyword">or</span> (lex_it.<span class="built_in">next</span>() <span class="keyword">and</span> lex_it.<span class="built_in">next</span>().token() == <span class="string">&#x27;Newline&#x27;</span>)):</span><br><span class="line">                            self.conds[else_key][<span class="string">&#x27;column_num_end&#x27;</span>] = lex_it.column_end() + <span class="number">1</span></span><br><span class="line">                            self.conds[else_key][<span class="string">&#x27;line_num_end&#x27;</span>] = lex_it.line_end()</span><br><span class="line">                            else_without_braces = <span class="literal">False</span></span><br><span class="line">                            self.conds[else_key][<span class="string">&#x27;has_braces&#x27;</span>] = <span class="literal">False</span></span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> lex_it.text() == <span class="string">&#x27;&#125;&#x27;</span> <span class="keyword">and</span> lex_it.<span class="built_in">next</span>().text() != <span class="string">&#x27;`&#x27;</span> <span class="keyword">and</span> <span class="keyword">not</span> else_without_braces:</span><br><span class="line">                            self.conds[else_key][<span class="string">&#x27;column_num_end&#x27;</span>] = lex_it.column_end()</span><br><span class="line">                            self.conds[else_key][<span class="string">&#x27;line_num_end&#x27;</span>] = lex_it.line_end()</span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">                        self.conds[else_key][<span class="string">&#x27;column_num_end&#x27;</span>] = lex_it.column_end()</span><br><span class="line">                        self.conds[else_key][<span class="string">&#x27;line_num_end&#x27;</span>] = lex_it.line_end()</span><br><span class="line"></span><br><span class="line">                    lex_it = lex_it.<span class="built_in">next</span>()</span><br><span class="line">            lexeme = lexeme.<span class="built_in">next</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_record_class_scope</span>(<span class="params">self, lexeme, line_stack</span>):</span><br><span class="line">        <span class="keyword">while</span> lexeme:</span><br><span class="line">            <span class="keyword">if</span> lexeme.text() == <span class="string">&#x27;class&#x27;</span>:</span><br><span class="line">                line_stack.add(lexeme.line_begin())</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            lexeme = lexeme.previous()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_record_method_scope</span>(<span class="params">self, lexeme, line_stack</span>):</span><br><span class="line">        builder = []</span><br><span class="line">        <span class="keyword">while</span> lexeme:</span><br><span class="line">            <span class="keyword">if</span> lexeme.text() <span class="keyword">in</span> [<span class="string">&#x27;&#123;&#x27;</span>, <span class="string">&#x27;)&#x27;</span>]:</span><br><span class="line">                builder.append(lexeme.text())</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&#x27; &#x27;</span>.join(builder) == <span class="string">&#x27;) &#123;&#x27;</span>):</span><br><span class="line">                line_stack.add(lexeme.line_begin())</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            lexeme = lexeme.previous()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_record_object_scope</span>(<span class="params">self, lexeme, line_stack</span>):</span><br><span class="line">        <span class="keyword">while</span> lexeme:</span><br><span class="line">            <span class="keyword">if</span> lexeme.text() == <span class="string">&#x27;&#123;&#x27;</span>:</span><br><span class="line">                line_stack.add(lexeme.line_begin())</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            lexeme = lexeme.previous()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_related_var_lines</span>(<span class="params">self, line_stack, analyzed_lines, show_use_by=<span class="literal">False</span></span>):</span><br><span class="line">        pointer_line = <span class="built_in">next</span>(<span class="built_in">iter</span>(line_stack))</span><br><span class="line">        variables = self.get_variable_entities(pointer_line)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">len</span>(line_stack) &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">for</span> var <span class="keyword">in</span> variables:</span><br><span class="line">                <span class="keyword">for</span> reference <span class="keyword">in</span> var.refs():</span><br><span class="line">                    current_line = reference.line()</span><br><span class="line">                    <span class="keyword">if</span> current_line &lt;= self.buggy_line_num <span class="keyword">and</span> current_line <span class="keyword">not</span> <span class="keyword">in</span> analyzed_lines <span class="keyword">and</span> reference.kind().longname() <span class="keyword">in</span> REL_KIND:</span><br><span class="line">                        line_stack.add(current_line)</span><br><span class="line"></span><br><span class="line">            analyzed_lines.add(pointer_line)</span><br><span class="line">            line_stack.remove(pointer_line)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(line_stack) &gt; <span class="number">0</span>:</span><br><span class="line">                pointer_line = <span class="built_in">next</span>(<span class="built_in">iter</span>(line_stack))</span><br><span class="line">                variables = self.get_variable_entities(pointer_line)</span><br><span class="line">        <span class="keyword">return</span> analyzed_lines</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, file_obj=<span class="literal">None</span>, root_path=<span class="literal">None</span>, dual_slice=<span class="literal">False</span>, js_file_type=<span class="literal">None</span></span>):</span><br><span class="line">        line_stack = <span class="built_in">set</span>()</span><br><span class="line">        analyzed_lines = <span class="built_in">set</span>()</span><br><span class="line">        variables = self.get_variable_entities(self.buggy_line_num)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> var <span class="keyword">in</span> variables:</span><br><span class="line">            <span class="keyword">if</span> var.kindname() == <span class="string">&#x27;Function&#x27;</span>:</span><br><span class="line">                self.has_function_call = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">if</span> var.parent() <span class="keyword">and</span> (</span><br><span class="line">                    var.parent().name() == <span class="string">&#x27;constructor&#x27;</span> <span class="keyword">or</span> var.parent().kindname() == <span class="string">&#x27;Function&#x27;</span>):  <span class="comment"># If its a function within a class, record the parent scope</span></span><br><span class="line">                lexeme = var.lexer().lexeme(var.ref().line(), var.ref().column())</span><br><span class="line">                self._record_class_scope(lexeme, line_stack)</span><br><span class="line">                self._record_method_scope(lexeme, line_stack)</span><br><span class="line">            <span class="keyword">for</span> reference <span class="keyword">in</span> var.refs():</span><br><span class="line">                current_line = reference.line()</span><br><span class="line">                <span class="keyword">if</span> current_line &lt; self.buggy_line_num <span class="keyword">and</span> current_line &gt; self.method_start_line_num <span class="keyword">and</span> current_line <span class="keyword">not</span> <span class="keyword">in</span> analyzed_lines <span class="keyword">and</span> reference.kind().longname() <span class="keyword">in</span> REL_KIND:</span><br><span class="line">                    line_stack.add(current_line)</span><br><span class="line"></span><br><span class="line">        analyzed_lines.add(self.buggy_line_num)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">len</span>(line_stack):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;No lines&#x27;</span></span><br><span class="line"></span><br><span class="line">        analyzed_lines = self.get_related_var_lines(line_stack, analyzed_lines)</span><br><span class="line"></span><br><span class="line">        self.analyze_closure()</span><br><span class="line">        statements = self.get_statements(<span class="built_in">set</span>([a <span class="keyword">for</span> a <span class="keyword">in</span> analyzed_lines <span class="keyword">if</span> a <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>]))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> file_obj <span class="keyword">and</span> file_obj[<span class="string">&#x27;buggy_line&#x27;</span>] <span class="keyword">and</span> <span class="built_in">len</span>(statements):</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> dual_slice:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;Writing slice to files......&#x27;</span>)</span><br><span class="line">                buggy_file = <span class="built_in">open</span>(root_path + file_obj[<span class="string">&#x27;buggy_file&#x27;</span>], <span class="string">&quot;w&quot;</span>)</span><br><span class="line">                fixed_file = <span class="built_in">open</span>(root_path + file_obj[<span class="string">&#x27;fixed_file&#x27;</span>], <span class="string">&quot;w&quot;</span>)</span><br><span class="line">                closest_match = get_close_matches(file_obj[<span class="string">&#x27;buggy_line&#x27;</span>], statements, n=<span class="number">1</span>)</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(closest_match):</span><br><span class="line">                    last_occurence_of_buggy_line = <span class="built_in">len</span>(statements) - statements[::-<span class="number">1</span>].index(closest_match[<span class="number">0</span>]) - <span class="number">1</span></span><br><span class="line">                    <span class="keyword">if</span> last_occurence_of_buggy_line &gt; -<span class="number">1</span>:</span><br><span class="line">                        <span class="keyword">for</span> idx, s <span class="keyword">in</span> <span class="built_in">enumerate</span>(statements):</span><br><span class="line">                            buggy_file.write(s + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">                            <span class="keyword">if</span> s <span class="keyword">in</span> closest_match <span class="keyword">and</span> idx == last_occurence_of_buggy_line:</span><br><span class="line">                                fixed_file.write(file_obj[<span class="string">&#x27;fixed_line&#x27;</span>] + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">                            <span class="keyword">else</span>:</span><br><span class="line">                                fixed_file.write(s + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">                        buggy_file.close()</span><br><span class="line">                        fixed_file.close()</span><br><span class="line">                        <span class="keyword">return</span> statements</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;Writing dual slice to files for file type &#123;&#125;......&#x27;</span>.<span class="built_in">format</span>(js_file_type))</span><br><span class="line">                js_file = <span class="built_in">open</span>(root_path + file_obj[js_file_type], <span class="string">&quot;w&quot;</span>)</span><br><span class="line">                <span class="keyword">for</span> s <span class="keyword">in</span> statements:</span><br><span class="line">                    js_file.write(s + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">                js_file.close()</span><br><span class="line">                <span class="keyword">return</span> statements</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;********* Sliced Statements **********&#x27;</span>)</span><br><span class="line">            [<span class="built_in">print</span>(s) <span class="keyword">for</span> s <span class="keyword">in</span> statements]</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;********* End **********&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> statements</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_single_file</span>(<span class="params">project_path</span>):</span><br><span class="line">    db = understand.<span class="built_in">open</span>(project_path)</span><br><span class="line"></span><br><span class="line">    buggy_line_num = <span class="number">9</span></span><br><span class="line">    file = db.lookup(<span class="string">&quot;test.js&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">    bs = BackwardSlicing(db, file, buggy_line_num)</span><br><span class="line">    bs.run()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_backward_slice</span>():</span><br><span class="line">    db = understand.<span class="built_in">open</span>(<span class="string">&#x27;./test-slice-js/test-slice-js.und&#x27;</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./test-slice-js/file_line_map.json&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        file_line_map = json.load(f)</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> file_line_map:</span><br><span class="line">            file = db.lookup(item[<span class="string">&#x27;file&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">            bs = BackwardSlicing(db, file, item[<span class="string">&#x27;line_num&#x27;</span>])</span><br><span class="line">            actual_statements = bs.run()</span><br><span class="line">            actual_statements = <span class="string">&#x27;&#x27;</span>.join([s.strip() <span class="keyword">for</span> s <span class="keyword">in</span> actual_statements])</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> item[<span class="string">&#x27;expected_output&#x27;</span>]:</span><br><span class="line">                <span class="keyword">assert</span> actual_statements == item[<span class="string">&#x27;expected_output&#x27;</span>], <span class="string">&#x27;Failed assertion in &#123;&#125; &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(item[<span class="string">&#x27;file&#x27;</span>],</span><br><span class="line">                                                                                                        item[</span><br><span class="line">                                                                                                            <span class="string">&#x27;line_num&#x27;</span>])</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;TEST PASSED for file/line&#x27;</span>, item[<span class="string">&#x27;file&#x27;</span>], item[<span class="string">&#x27;line_num&#x27;</span>])</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;ACTUAL --- &#x27;</span>, actual_statements)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_whitespace_diff</span>(<span class="params">buggy_line, fixed_line</span>):</span><br><span class="line">    output_list = [li <span class="keyword">for</span> li <span class="keyword">in</span> ndiff(fixed_line, buggy_line) <span class="keyword">if</span> li[<span class="number">0</span>] != <span class="string">&#x27; &#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(output_list):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">all</span>(f.strip() <span class="keyword">in</span> [<span class="string">&#x27;+&#x27;</span>, <span class="string">&#x27;-&#x27;</span>] <span class="keyword">for</span> f <span class="keyword">in</span> output_list)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_split_projects</span>(<span class="params">project_path, root_sliced_path, dual_slice</span>):</span><br><span class="line">    subdir = project_path.split(<span class="string">&#x27;\\&#x27;</span>)[-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    udb = <span class="string">&#x27;&#123;&#125;\\&#123;&#125;.und&#x27;</span>.<span class="built_in">format</span>(project_path, subdir)</span><br><span class="line">    folderpath_db_map = &#123;&#125;</span><br><span class="line">    folderpath_db_map[udb] = project_path</span><br><span class="line"></span><br><span class="line">    files = []</span><br><span class="line">    csv_file_path = project_path + <span class="string">&#x27;\\&#x27;</span> + <span class="string">&#x27;&#123;&#125;_bugs_info.csv&#x27;</span>.<span class="built_in">format</span>(subdir)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(csv_file_path, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> csv_file:</span><br><span class="line">        csv_reader = csv.reader(csv_file, delimiter=<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> csv_reader:</span><br><span class="line">            files.append(&#123;</span><br><span class="line">                <span class="string">&#x27;buggy_line_num&#x27;</span>: row[<span class="number">2</span>],</span><br><span class="line">                <span class="string">&#x27;buggy_line&#x27;</span>: row[<span class="number">3</span>],</span><br><span class="line">                <span class="string">&#x27;fixed_line&#x27;</span>: row[<span class="number">4</span>],</span><br><span class="line">                <span class="string">&#x27;buggy_file&#x27;</span>: row[<span class="number">0</span>],</span><br><span class="line">                <span class="string">&#x27;fixed_file&#x27;</span>: row[<span class="number">1</span>]</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_slice</span>(<span class="params">row</span>):</span><br><span class="line">        buggy_file = row[<span class="string">&#x27;buggy_file&#x27;</span>]</span><br><span class="line">        fixed_file = row[<span class="string">&#x27;fixed_file&#x27;</span>]</span><br><span class="line">        buggy_line_num = row[<span class="string">&#x27;buggy_line_num&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> os.path.exists(root_sliced_path + buggy_file):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;File already exists ---- Skipping...&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> (os.path.exists(folderpath_db_map[udb] + <span class="string">&#x27;\\&#x27;</span> + buggy_file) <span class="keyword">and</span> os.path.exists(</span><br><span class="line">                folderpath_db_map[udb] + <span class="string">&#x27;\\&#x27;</span> + fixed_file)):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Processing buggy file -----&#x27;</span>, buggy_file, buggy_line_num)</span><br><span class="line">            file_obj = &#123;</span><br><span class="line">                <span class="string">&#x27;buggy_line&#x27;</span>: row[<span class="string">&#x27;buggy_line&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;fixed_line&#x27;</span>: row[<span class="string">&#x27;fixed_line&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;buggy_file&#x27;</span>: buggy_file,</span><br><span class="line">                <span class="string">&#x27;fixed_file&#x27;</span>: fixed_file</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                db_file = db.lookup(buggy_file, <span class="string">&#x27;File&#x27;</span>)</span><br><span class="line">                <span class="keyword">if</span> db_file:</span><br><span class="line">                    buggy_file_slice = BackwardSlicing(db, db_file[<span class="number">0</span>], <span class="built_in">int</span>(buggy_line_num))</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;Doing backward slice on buggy file &#123;&#125;......&#x27;</span>.<span class="built_in">format</span>(buggy_file))</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        buggy_file_slice.run(file_obj, root_path=root_sliced_path, dual_slice=dual_slice,</span><br><span class="line">                                             js_file_type=<span class="string">&#x27;buggy_file&#x27;</span>)</span><br><span class="line">                    <span class="keyword">except</span> Exception <span class="keyword">as</span> err:</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&#x27;Error in file&#x27;</span>, buggy_file, err)</span><br><span class="line">                        traceback.print_exc()</span><br><span class="line">            <span class="keyword">except</span> SystemError:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> dual_slice:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    db_file = db.lookup(fixed_file, <span class="string">&#x27;File&#x27;</span>)</span><br><span class="line">                    <span class="keyword">if</span> db_file:</span><br><span class="line">                        fixed_file_slice = BackwardSlicing(db, db_file[<span class="number">0</span>], <span class="built_in">int</span>(buggy_line_num))</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&#x27;Doing backward slice on fixed file &#123;&#125;......&#x27;</span>.<span class="built_in">format</span>(fixed_file))</span><br><span class="line">                        <span class="keyword">try</span>:</span><br><span class="line">                            fixed_file_slice.run(file_obj, root_path=root_sliced_path, dual_slice=dual_slice,</span><br><span class="line">                                                 js_file_type=<span class="string">&#x27;fixed_file&#x27;</span>)</span><br><span class="line">                            <span class="keyword">return</span> <span class="string">&#x27;Success&#x27;</span></span><br><span class="line">                        <span class="keyword">except</span> Exception <span class="keyword">as</span> err:</span><br><span class="line">                            <span class="built_in">print</span>(<span class="string">&#x27;Error in file&#x27;</span>, fixed_file, err)</span><br><span class="line">                            traceback.print_exc()</span><br><span class="line">                <span class="keyword">except</span> SystemError:</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;Success&#x27;</span></span><br><span class="line"></span><br><span class="line">    db = understand.<span class="built_in">open</span>(udb)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> concurrent.futures.ThreadPoolExecutor(max_workers=<span class="number">5</span>) <span class="keyword">as</span> executor:</span><br><span class="line">        futures = []</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Accessing udb.....&#x27;</span>, udb)</span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> files:</span><br><span class="line">            futures.append(executor.submit(generate_slice, row))</span><br><span class="line">        <span class="keyword">for</span> future <span class="keyword">in</span> concurrent.futures.as_completed(futures):</span><br><span class="line">            <span class="built_in">print</span>(future.result())</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;********** DONE **********&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    project_type = sys.argv[<span class="number">1</span>] <span class="keyword">or</span> <span class="string">&#x27;test&#x27;</span>  <span class="comment"># choices = [&#x27;single&#x27;, &#x27;multiple&#x27;, &#x27;test&#x27;]</span></span><br><span class="line">    dual_slice = <span class="literal">False</span> <span class="keyword">if</span> sys.argv[<span class="number">2</span>] == <span class="string">&#x27;False&#x27;</span> <span class="keyword">else</span> <span class="literal">True</span></span><br><span class="line">    project_path = sys.argv[<span class="number">3</span>:]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> project_type == <span class="string">&#x27;multiple&#x27;</span>:</span><br><span class="line">        <span class="keyword">for</span> <span class="built_in">dir</span> <span class="keyword">in</span> project_path:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Slicing for folder &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">dir</span>))</span><br><span class="line">            root_sliced_path = <span class="string">&#x27;&#123;&#125;\\&#123;&#125;\\&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">dir</span>, <span class="string">&#x27;sliced_dual&#x27;</span> <span class="keyword">if</span> dual_slice <span class="keyword">else</span> <span class="string">&#x27;sliced&#x27;</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                os.mkdir(root_sliced_path)</span><br><span class="line">            <span class="keyword">except</span> FileExistsError:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;Folder exists..&#x27;</span>)</span><br><span class="line">            process_split_projects(<span class="built_in">dir</span>, root_sliced_path, dual_slice)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Completed slicing for folder &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">dir</span>))</span><br><span class="line">    <span class="keyword">elif</span> project_type == <span class="string">&#x27;single&#x27;</span>:</span><br><span class="line">        process_single_file(project_path[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        test_backward_slice()  <span class="comment"># For testing slicing stability</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>对于双重切片代码解析：</p><p><code>safe_list_get(arr, idx)</code>: 这个函数的作用是安全地获取列表 arr 中索引为 idx 的元素。它使用了 try-except 块来捕获可能发生的 IndexError 异常，防止程序因为索引越界而崩溃。如果索引存在，函数会返回对应的元素；否则，返回 None。</p><p><code>get_patch_from_diff(diff)</code>: 这个函数接受一个表示两个字符串差异的 diff 字符串作为输入，并从中提取出存在差异的行。函数首先初始化了两个变量 <code>buggy_line</code> 和 <code>fixed_line</code>，它们分别用于保存出现差异的行。随后，函数遍历 diff 字符串中的每一行，当遇到以 + 开头的行时，将这一行去掉开头的 + 加入到 <code>fixed_line</code> 中；当遇到以 - 开头的行时，将这一行去掉开头的 - 加入到 <code>buggy_line</code> 中。最后，函数返回 <code>buggy_line</code> 和 <code>fixed_line</code>。</p><p><code>BackwardSlicing.__init__(self, db, file, buggy_line_num)</code>: 这个类的构造函数初始化了一些属性和数据结构。它接受一个understand数据库对象db、一个文件对象file和一个有bug的行号<code>buggy_line_num</code>作为输入参数。这些参数分别用于初始化<code>self.db</code>、<code>self.file</code>和<code>self.buggy_line_num</code>属性。另外，构造函数还初始化了一些其它的属性，如<code>self.method_lines</code>、<code>self.loops</code>、<code>self.conds</code>等，并初始化了一些集合数据结构。构造函数的主要目的是准备数据结构以便后续的切片操作。</p><p><code>BackwardSlicing._get_outermost_parent(self, first_line)</code>: 这个方法用于找到 <code>first_line</code> 所在范围内最外层的父级行号。它通过遍历文件对象的 lexer 方法返回的结果，查找与 <code>first_line</code> 行号对应的词元，然后获取该词元对应的父级行号，即文件、类或函数的行号。并返回其结果。如果未找到匹配的父级行，则返回 None。</p><p><code>BackwardSlicing._get_object_beginning(self, line_number)</code>: 这个方法用于处理代码中可能出现的点号换行的情况，即点号后面的对象名在下一行。它通过遍历文件对象的 lexer 方法返回的结果，查找包含 <code>line_number</code> 行号的词元。如果找到一个包含点号的词元，且点号前面是空白字符，则递归调用该方法，传入 <code>line_number - 1</code> 作为参数，继续查找对象开始的行号。如果找到了对象开始的行号，则返回该行号；否则，返回 <code>line_number</code>。</p><p><code>BackwardSlicing.get_variable_entities(self, line_number)</code>: 这个方法用于获取给定行号 <code>line_number</code> 所在行的变量实体。它通过遍历文件对象的 lexer 方法返回的结果，查找与 <code>line_number</code> 行号对应的词元。当词元的类型是 <code>Identifier</code> 且包含实体时，将该实体添加到结果列表中。如果词元的实体是 Property 类型，则将其父实体添加到结果列表中。最后，返回结果列表。</p><p><code>BackwardSlicing.is_within_loop(self, line_num)</code>: 这个方法用于判断给定行号 <code>line_num</code> 是否在某个循环语句内部。函数会遍历存储在 <code>self.loops</code> 属性中的循环语句信息，判断给定行号是否在每个循环语句的起始行号和结束行号之间。如果是，则将该循环语句的起始行号和结束行号添加到结果列表中。最后，返回结果列表。</p><p><code>BackwardSlicing.is_within_scope(self, line_num)</code>: 这个方法用于判断给定行号 <code>line_num</code> 是否在某个作用域内部。函数会遍历存储在 self.scope 属性中的作用域信息，判断给定行号是否在每个作用域的起始行号和结束行号之间。如果是，则将该作用域的起始行号、结束行号和是否为变量作用域的信息添加到结果列表中。最后，返回结果列表。</p><p><code>BackwardSlicing.is_within_conditional(self, line_num)</code>: 这个方法用于判断给定行号 <code>line_num</code> 是否在某个条件语句内部。函数会遍历存储在 <code>self.conds</code> 属性中的条件语句信息，判断给定行号是否在每个条件语句的起始行号和结束行号之间。如果是，则将该条件语句的起始行号和结束行号添加到结果列表中。如果条件语句是一个 else 语句，则还会记录 else 语句的起始行号。最后，返回结果列表。</p><p><code>BackwardSlicing.find_conditional_by_else(self, lines)</code>: 这个方法用于根据else行找到相关条件语句的范围。函数遍历存储在 self.conditional_scope 属性中的条件语句信息，找到跟当前 else 行相关联的条件语句，并将相关条件语句的范围添加到结果集合中。返回最终的结果集合。</p><p><code>BackwardSlicing.on_add_line(self, line_numbers)</code>: 这个方法用于在切片过程中添加某个行号的相关行。它可以接受一个行号集合或单个行号作为输入。如果输入是行号集合，则会遍历集合中的每个行号，调用 <code>_on_add</code> 方法获取与每个行号相关的行，并将其结果合并为最终的行号集合返回。如果输入是单个行号，则直接调用 <code>_on_add</code> 方法返回结果。</p><p><code>BackwardSlicing.get_statements(self, lines)</code>: 这个方法用于根据行号集合获取与这些行号相关的语句。它遍历文件的词法分析结果，根据行号匹配词元，将匹配的词元拼接成字符串，作为一条语句，添加到结果列表中。最后，返回结果语句列表。</p><p><code>BackwardSlicing.analyze_closure(self)</code>: 这个方法用于分析代码的闭包信息。它通过遍历文件对象的 lexer 方法返回的结果，查找与每个行号相关的词元，然后根据词元的类型记录闭包信息，包括循环语句、条件语句和作用域信息。</p><p><code>BackwardSlicing.run(self, file_obj=None, root_path=None, dual_slice=False, js_file_type=None)</code>: 这个方法是类的主要方法，用于执行反向切片操作。它接受一个文件对象 file_obj、一个根目录路径 <code>root_path</code>、一个布尔值 <code>dual_slice</code> 和一个字符串 <code>js_file_type</code> 作为参数。在方法的实现中，它调用了类的其他私有方法和辅助函数，根据参数执行不同的切片操作，并将切片结果写入文件或打印出来。最后，返回切片结果列表。</p></blockquote><h3 id="训练-2">训练</h3><p>在<a target="_blank" rel="noopener external nofollow noreferrer" href="https://openreview.net/pdf?id=SJeqs6EFvB">Hoppity</a>的GNN架构上运行的步骤如下：</p><ul><li>解压<code>./hoppity-data/</code>目录下的<code>sliced_data.tar.gz</code></li></ul><h4 id="如何创建一个新的Conda环境？">如何创建一个新的Conda环境？</h4><p>假设我们要创建的Conda环境的名称是<code>model</code>。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cd gh-crawler</span><br><span class="line">npm install shift-parser fast-json-patch</span><br><span class="line"></span><br><span class="line">cd ../hoppity-data/hoppity</span><br><span class="line">conda create -n gnnEnv</span><br><span class="line">conda activate gnnEnv</span><br><span class="line"></span><br><span class="line">pip install torch</span><br><span class="line">pip install -r requirements.txt</span><br><span class="line"></span><br><span class="line">cd deps/torchext</span><br><span class="line">pip install -e .</span><br><span class="line"></span><br><span class="line">cd ../..</span><br><span class="line">pip install -e .</span><br><span class="line"># 报错就pip install gtrans</span><br></pre></td></tr></table></figure><h4 id="开始训练之前">开始训练之前</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd hoppity-data</span><br></pre></td></tr></table></figure><p>在开始训练之前运行：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reset_data_dirs.sh</span><br></pre></td></tr></table></figure><p>该sh对应的bat文件：</p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"><span class="built_in">rmdir</span> /s /q ml_astPKL</span><br><span class="line"><span class="built_in">mkdir</span> ml_astPKL</span><br><span class="line"><span class="built_in">rmdir</span> /s /q ml_astJSON</span><br><span class="line"><span class="built_in">mkdir</span> ml_astJSON</span><br><span class="line"><span class="built_in">rmdir</span> /s /q ml_raw</span><br><span class="line"><span class="built_in">mkdir</span> ml_raw</span><br><span class="line"><span class="built_in">rmdir</span> /s /q ml_trainingResult</span><br><span class="line"><span class="built_in">mkdir</span> ml_trainingResult</span><br><span class="line"><span class="built_in">rmdir</span> /s /q ml_patch</span><br><span class="line"><span class="built_in">mkdir</span> ml_patch</span><br><span class="line"><span class="built_in">rmdir</span> /s /q eval_dump_folder</span><br><span class="line"><span class="built_in">mkdir</span> eval_dump_folder</span><br></pre></td></tr></table></figure><h4 id="准备数据集的命令">准备数据集的命令</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd ../gh-crawler</span><br><span class="line">ast_diff/my_get_ast_diff.sh</span><br><span class="line"></span><br><span class="line">cd hoppity/gtrans</span><br><span class="line">cd data_process</span><br><span class="line">rm processed.txt</span><br><span class="line">./run_build_dataset.sh</span><br><span class="line">./run_split.sh</span><br></pre></td></tr></table></figure><p><code>my_get_ast_diff.sh</code>对应的bat：</p><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure><h4 id="运行训练的命令">运行训练的命令</h4><p>运行<code>run_main.sh</code>来触发训练。在后续阶段，我们需要在<code>common/config.py</code>文件中调整超参数。至少运行30个epochs的训练。之后终止脚本以结束训练。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd hoppity-data/hoppity/gtrans/training</span><br><span class="line">./run_main.sh</span><br></pre></td></tr></table></figure><h4 id="进行验证的命令">进行验证的命令</h4><p>现在我们需要找到最佳模型。运行<code>find_best_model.sh</code>，并根据结果在<code>eval.sh</code>中相应地设置变量。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd hoppity-data/hoppity/gtrans/eval</span><br><span class="line">./find_best_model.sh</span><br></pre></td></tr></table></figure><p>根据需要在<code>eval.sh</code>中设置目标模型（epoch-*.ckpt）。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./eval.sh</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://zwn2001.space">琉璃月</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://zwn2001.space/posts/%E8%AF%BBpaper3-Katana-Dual-Slicing-Based-Context-for-Learning-Bug-Fixes/">https://zwn2001.space/posts/%E8%AF%BBpaper3-Katana-Dual-Slicing-Based-Context-for-Learning-Bug-Fixes/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zwn2001.space" target="_blank">ZWN's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%A0%94/">研</a></div><div class="post_share"><div class="social-share" data-image="/img/cover/42.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://unpkg.com/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://unpkg.com/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/cs224w-%E5%9B%BE%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A01/" title="cs224w-图机器学习1"><img class="cover" src="/img/cover/53.jpg" onerror='onerror=null,src="/img/404.webp"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">cs224w-图机器学习1</div></div></a></div><div class="next-post pull-right"><a href="/posts/%E8%AF%BBpaper2-%E5%9F%BA%E4%BA%8ELLM%E7%9A%84%E7%BC%BA%E9%99%B7%E4%BF%AE%E5%A4%8D/" title="读paper2-基于LLM的缺陷修复"><img class="cover" src="/img/cover/58.jpg" onerror='onerror=null,src="/img/404.webp"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">读paper2-基于LLM的缺陷修复</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/%E8%AF%BBpaper5-%E5%9F%BA%E4%BA%8E%E5%9B%BE%E7%9A%84%E7%BC%BA%E9%99%B7%E6%A3%80%E6%B5%8B%E4%B8%8E%E4%BF%AE%E5%A4%8D%E4%B8%A4%E7%AF%87/" title="读paper5-基于图的缺陷检测与修复两篇"><img class="cover" src="/img/cover/57.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-09-04</div><div class="title">读paper5-基于图的缺陷检测与修复两篇</div></div></a></div><div><a href="/posts/%E8%AF%BBpaper6-%E7%BC%BA%E9%99%B7%E6%A0%B7%E6%9C%AC%E7%94%9F%E6%88%90/" title="读paper6-缺陷样本生成"><img class="cover" src="/img/cover/21.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-09-05</div><div class="title">读paper6-缺陷样本生成</div></div></a></div><div><a href="/posts/%E8%AF%BBpaper1-%E9%92%88%E5%AF%B9DL%E7%9A%84%E7%BC%BA%E9%99%B7%E5%88%86%E7%B1%BB%E4%B8%8E%E4%BF%AE%E5%A4%8D/" title="读paper1-针对DL的缺陷分类与修复"><img class="cover" src="/img/cover/56.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-26</div><div class="title">读paper1-针对DL的缺陷分类与修复</div></div></a></div><div><a href="/posts/%E8%AF%BBpaper2-%E5%9F%BA%E4%BA%8ELLM%E7%9A%84%E7%BC%BA%E9%99%B7%E4%BF%AE%E5%A4%8D/" title="读paper2-基于LLM的缺陷修复"><img class="cover" src="/img/cover/58.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-09</div><div class="title">读paper2-基于LLM的缺陷修复</div></div></a></div><div><a href="/posts/%E8%AF%BBpaper4-%E5%A4%9A%E6%99%BA%E8%83%BD%E4%BD%93%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0%E5%85%A5%E6%89%8B%E4%B8%8E%E8%AE%BA%E6%96%87%E9%9B%86/" title="读paper4-多智能体强化学习入手与论文集"><img class="cover" src="/img/cover/13.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-21</div><div class="title">读paper4-多智能体强化学习入手与论文集</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/favicon.webp" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">琉璃月</div><div class="author-info__description">我虽无意逐鹿，却知苍生苦楚</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">147</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">48</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/ZWN2001"><i class="fab fa-github"></i><span>我的Github</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/ZWN2001" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">新域名：www.zwn2001.space，有效期：10年。https://www.zwn-blog.xyz已过期。访问时建议科学上网，否则博客内公式渲染会出现问题且速度慢。Ctrl+shift+r可强制刷新网站以避免浏览器缓存造成的更新不及时</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">读paper3-Katana: Dual Slicing-Based Context for Learning Bug Fixes</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E5%BC%95%E5%85%A5"><span class="toc-number">1.1.</span> <span class="toc-text">问题引入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%94%B6%E9%9B%86"><span class="toc-number">1.2.</span> <span class="toc-text">数据收集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E5%88%87%E7%89%87-Static-Program-Slicing"><span class="toc-number">1.3.</span> <span class="toc-text">程序切片 Static Program Slicing</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E4%B8%80%E5%88%87%E7%89%87"><span class="toc-number">1.3.1.</span> <span class="toc-text">单一切片</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8C%E9%87%8D%E5%88%87%E7%89%87"><span class="toc-number">1.3.2.</span> <span class="toc-text">双重切片</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%BE%E8%A1%A8%E7%A4%BA-Graph-Representation"><span class="toc-number">1.4.</span> <span class="toc-text">图表示 Graph Representation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%AD%E7%BB%83"><span class="toc-number">1.5.</span> <span class="toc-text">训练</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E6%9E%9C%E8%AF%84%E4%BC%B0"><span class="toc-number">1.6.</span> <span class="toc-text">结果评估</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RQ1%EF%BC%9A%E5%8F%8C%E5%88%87%E7%89%87%E4%B8%8E%E5%8D%95%E5%88%87%E7%89%87%E5%9C%A8%E5%AD%A6%E4%B9%A0%E4%BF%AE%E5%A4%8D%E6%96%B9%E9%9D%A2%E6%9C%89%E4%BD%95%E5%8C%BA%E5%88%AB%EF%BC%9F"><span class="toc-number">1.6.1.</span> <span class="toc-text">RQ1：双切片与单切片在学习修复方面有何区别？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RQ2%EF%BC%9AKatana%E4%B8%8E%E6%9C%80%E6%96%B0%E7%9A%84%E5%9F%BA%E4%BA%8E%E5%AD%A6%E4%B9%A0%E7%9A%84%E4%BF%AE%E5%A4%8D%E6%8A%80%E6%9C%AF%E7%9B%B8%E6%AF%94%E5%A6%82%E4%BD%95%EF%BC%9F"><span class="toc-number">1.6.2.</span> <span class="toc-text">RQ2：Katana与最新的基于学习的修复技术相比如何？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RQ3%EF%BC%9A%E5%88%87%E7%89%87%E5%AF%B9%E4%BA%8E%E8%8E%B7%E5%BE%97%E4%B8%8A%E4%B8%8B%E6%96%87%E4%BF%A1%E6%81%AF%E6%9C%89%E4%BD%95%E5%BD%B1%E5%93%8D%EF%BC%9F"><span class="toc-number">1.6.3.</span> <span class="toc-text">RQ3：切片对于获得上下文信息有何影响？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Limitations"><span class="toc-number">1.7.</span> <span class="toc-text">Limitations</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E5%A4%8D%E7%8E%B0"><span class="toc-number">1.8.</span> <span class="toc-text">项目复现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%94%B6%E9%9B%86-2"><span class="toc-number">1.8.1.</span> <span class="toc-text">数据收集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E5%88%87%E7%89%87"><span class="toc-number">1.8.2.</span> <span class="toc-text">程序切片</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%84%E5%A4%84%E7%90%86"><span class="toc-number">1.8.2.1.</span> <span class="toc-text">预处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E5%88%87%E7%89%87%E5%99%A8"><span class="toc-number">1.8.2.2.</span> <span class="toc-text">运行切片器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E4%BB%A3%E7%A0%81%E9%97%AE%E9%A2%98"><span class="toc-number">1.8.2.3.</span> <span class="toc-text">一些代码问题</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#generate-file-info-py"><span class="toc-number">1.8.2.3.1.</span> <span class="toc-text">generate-file-info.py</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#backward-slice-py"><span class="toc-number">1.8.2.3.2.</span> <span class="toc-text">backward-slice.py</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%AD%E7%BB%83-2"><span class="toc-number">1.8.3.</span> <span class="toc-text">训练</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%96%B0%E7%9A%84Conda%E7%8E%AF%E5%A2%83%EF%BC%9F"><span class="toc-number">1.8.3.1.</span> <span class="toc-text">如何创建一个新的Conda环境？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B%E8%AE%AD%E7%BB%83%E4%B9%8B%E5%89%8D"><span class="toc-number">1.8.3.2.</span> <span class="toc-text">开始训练之前</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E6%95%B0%E6%8D%AE%E9%9B%86%E7%9A%84%E5%91%BD%E4%BB%A4"><span class="toc-number">1.8.3.3.</span> <span class="toc-text">准备数据集的命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E8%AE%AD%E7%BB%83%E7%9A%84%E5%91%BD%E4%BB%A4"><span class="toc-number">1.8.3.4.</span> <span class="toc-text">运行训练的命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E8%A1%8C%E9%AA%8C%E8%AF%81%E7%9A%84%E5%91%BD%E4%BB%A4"><span class="toc-number">1.8.3.5.</span> <span class="toc-text">进行验证的命令</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/%E7%A0%94%E4%B8%80%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0-%E6%95%B0%E5%80%BC%E5%88%86%E6%9E%90/" title="研一课程笔记-数值分析"><img src="/img/cover/7.jpg" onerror='this.onerror=null,this.src="/img/404.webp"' alt="研一课程笔记-数值分析"></a><div class="content"><a class="title" href="/posts/%E7%A0%94%E4%B8%80%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0-%E6%95%B0%E5%80%BC%E5%88%86%E6%9E%90/" title="研一课程笔记-数值分析">研一课程笔记-数值分析</a><time datetime="2024-09-05T14:25:32.000Z" title="发表于 2024-09-05 22:25:32">2024-09-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/%E8%AF%BBpaper6-%E7%BC%BA%E9%99%B7%E6%A0%B7%E6%9C%AC%E7%94%9F%E6%88%90/" title="读paper6-缺陷样本生成"><img src="/img/cover/21.jpg" onerror='this.onerror=null,this.src="/img/404.webp"' alt="读paper6-缺陷样本生成"></a><div class="content"><a class="title" href="/posts/%E8%AF%BBpaper6-%E7%BC%BA%E9%99%B7%E6%A0%B7%E6%9C%AC%E7%94%9F%E6%88%90/" title="读paper6-缺陷样本生成">读paper6-缺陷样本生成</a><time datetime="2024-09-05T05:20:47.000Z" title="发表于 2024-09-05 13:20:47">2024-09-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/%E8%AF%BBpaper5-%E5%9F%BA%E4%BA%8E%E5%9B%BE%E7%9A%84%E7%BC%BA%E9%99%B7%E6%A3%80%E6%B5%8B%E4%B8%8E%E4%BF%AE%E5%A4%8D%E4%B8%A4%E7%AF%87/" title="读paper5-基于图的缺陷检测与修复两篇"><img src="/img/cover/57.jpg" onerror='this.onerror=null,this.src="/img/404.webp"' alt="读paper5-基于图的缺陷检测与修复两篇"></a><div class="content"><a class="title" href="/posts/%E8%AF%BBpaper5-%E5%9F%BA%E4%BA%8E%E5%9B%BE%E7%9A%84%E7%BC%BA%E9%99%B7%E6%A3%80%E6%B5%8B%E4%B8%8E%E4%BF%AE%E5%A4%8D%E4%B8%A4%E7%AF%87/" title="读paper5-基于图的缺陷检测与修复两篇">读paper5-基于图的缺陷检测与修复两篇</a><time datetime="2024-09-04T07:48:39.000Z" title="发表于 2024-09-04 15:48:39">2024-09-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/cs224w-%E5%9B%BE%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A02/" title="cs224w-图机器学习2"><img src="/img/cover/56.jpg" onerror='this.onerror=null,this.src="/img/404.webp"' alt="cs224w-图机器学习2"></a><div class="content"><a class="title" href="/posts/cs224w-%E5%9B%BE%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A02/" title="cs224w-图机器学习2">cs224w-图机器学习2</a><time datetime="2024-09-02T08:40:23.000Z" title="发表于 2024-09-02 16:40:23">2024-09-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/%E8%AF%BBpaper4-%E5%A4%9A%E6%99%BA%E8%83%BD%E4%BD%93%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0%E5%85%A5%E6%89%8B%E4%B8%8E%E8%AE%BA%E6%96%87%E9%9B%86/" title="读paper4-多智能体强化学习入手与论文集"><img src="/img/cover/13.jpg" onerror='this.onerror=null,this.src="/img/404.webp"' alt="读paper4-多智能体强化学习入手与论文集"></a><div class="content"><a class="title" href="/posts/%E8%AF%BBpaper4-%E5%A4%9A%E6%99%BA%E8%83%BD%E4%BD%93%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0%E5%85%A5%E6%89%8B%E4%B8%8E%E8%AE%BA%E6%96%87%E9%9B%86/" title="读paper4-多智能体强化学习入手与论文集">读paper4-多智能体强化学习入手与论文集</a><time datetime="2024-08-21T02:43:57.000Z" title="发表于 2024-08-21 10:43:57">2024-08-21</time></div></div></div></div></div></div></main><footer id="footer" style="background:0 0"></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();" rel="external nofollow noreferrer"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();" rel="external nofollow noreferrer"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();" rel="external nofollow noreferrer"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:rmf.scrollToTop();" rel="external nofollow noreferrer"><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();" rel="external nofollow noreferrer"><i class="fa fa-copy"></i><span>复制</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.google.com/search?q=&quot;+window.getSelection().toString());" rel="external nofollow noreferrer"><i class="iconfont icon-baidu"></i><span>搜索</span></a><a class="rightMenu-item" href="javascript:rmf.searchinThisPage();" rel="external nofollow noreferrer"><i class="fas fa-search"></i><span>站内搜索</span></a><a class="rightMenu-item" href="#post-comment" onclick="rmf.yinyong()"><i class="fa-solid fa-message"></i><span>引用文本评论</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();" rel="external nofollow noreferrer"><i class="fa fa-link"></i><span>转到链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()" rel="external nofollow noreferrer"><i class="fa fa-copy"></i><span>粘贴</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()" rel="external nofollow noreferrer"><i class="fa fa-window-restore"></i><span>新窗口打开</span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()" rel="external nofollow noreferrer"><i class="fa fa-link"></i><span>转到链接</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()" rel="external nofollow noreferrer"><i class="fa fa-copy"></i><span>复制链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()" rel="external nofollow noreferrer"><i class="fa fa-download"></i><span>保存图片</span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()" rel="external nofollow noreferrer"><i class="fa fa-window-restore"></i><span>在新窗口打开</span></a><a class="rightMenu-item" href="javascript:rmf.click()" rel="external nofollow noreferrer"><i class="fa fa-arrows-alt"></i><span>全屏显示</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()" rel="external nofollow noreferrer"><i class="fa fa-copy"></i><span>复制图片链接</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:rmf.switchDarkMode();" rel="external nofollow noreferrer"><i class="fa fa-moon"></i><span>昼夜切换</span></a><a class="rightMenu-item" href="javascript:rmf.translate();" rel="external nofollow noreferrer"><i class="iconfont icon-fanti"></i><span>繁简转换</span></a><a class="rightMenu-item" href="javascript:rmf.switchReadMode();" rel="external nofollow noreferrer"><i class="fa fa-book"></i><span>阅读模式</span></a><a class="rightMenu-item" href="javascript:fullScreen();" rel="external nofollow noreferrer"><i class="fas fa-expand"></i><span>进入全屏</span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://unpkg.com/@fancyapps/ui/dist/fancybox/fancybox.umd.js"></script><script>function panguFn(){"object"==typeof pangu?pangu.autoSpacingPage():getScript("https://unpkg.com/pangu/dist/browser/pangu.min.js").then(()=>{pangu.autoSpacingPage()})}function panguInit(){GLOBAL_CONFIG_SITE.isPost&&panguFn()}document.addEventListener("DOMContentLoaded",panguInit)</script><div class="js-pjax"><link rel="stylesheet" type="text/css" href="https://unpkg.com/katex/dist/katex.min.css"><script src="https://unpkg.com/katex/dist/contrib/copy-tex.min.js"></script><script>document.querySelectorAll("#article-container span.katex-display").forEach(a=>{btf.wrap(a,"div",{class:"katex-wrap"})})</script><script>function getGiscusTheme(e){return"dark"===e?"dark":"light"}function loadGiscus(){var e,t=Object.assign({src:"https://giscus.app/client.js","data-repo":"ZWN2001/ZWN2001.github.io","data-repo-id":"R_kgDOGH1XWg","data-category-id":"DIC_kwDOGH1XWs4CXnHJ","data-mapping":"pathname","data-theme":getGiscusTheme(document.documentElement.getAttribute("data-theme")),"data-reactions-enabled":"1",crossorigin:"anonymous",async:!0},{"data-lang":"zh-CN","data-loading":"lazy",crossorigin:"anonymous","data-mapping":"og:title","data-input-position":"top","data-category":"Announcements"}),a=document.createElement("script");for(e in t)a.setAttribute(e,t[e]);document.getElementById("giscus-wrap").insertAdjacentElement("afterbegin",a)}function changeGiscusTheme(e){var t;e={setConfig:{theme:getGiscusTheme(e)}},(t=document.querySelector("iframe.giscus-frame"))&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")}function loadOtherComment(){loadGiscus()}btf.addModeChange("giscus",changeGiscusTheme),btf.loadComment(document.getElementById("giscus-wrap"),loadGiscus)</script></div><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script><script type="text/javascript" src="/js/rightmenu.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><script data-pjax>var parent,child;document.getElementById("recent-posts")&&"/"===location.pathname&&(parent=document.getElementById("recent-posts"),child='<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="https://zwn2001.space/categories/编程知识/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">📚 琉璃月の编程知识 (13)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://zwn2001.space/categories/实用知识/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">💡 琉璃月の实用知识 (12)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://zwn2001.space/categories/学习-课外拓展/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">👩‍💻 琉璃月の学习-课外拓展 (31)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://zwn2001.space/categories/学习-课内知识/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">📒 琉璃月の学习-课内知识 (56)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><a class="magnet_link_more"  href="https://zwn2001.space/categories" style="flex:1;text-align: center;margin-bottom: 10px;">查看更多...</a></div></div>',console.log("已挂载magnet"),parent.insertAdjacentHTML("afterbegin",child))</script><style>#catalog_magnet{flex-wrap:wrap;display:flex;width:100%;justify-content:space-between;padding:10px 10px 0 10px;align-content:flex-start}.magnet_item{flex-basis:calc(50% - 5px);background:#f2f2f2;margin-bottom:10px;border-radius:8px;transition:all .2s ease-in-out}.magnet_item:hover{background:#b30070}.magnet_link_more{color:#555}.magnet_link{color:#000}.magnet_link:hover{color:#fff}@media screen and (max-width:600px){.magnet_item{flex-basis:100%}}.magnet_link_context{display:flex;padding:10px;font-size:16px;transition:all .2s ease-in-out}.magnet_link_context:hover{padding:10px 20px}</style><style></style></body></html>