<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>Python爬虫从入门到小黑屋 | ZWN's blog</title><meta name="author" content="洛雪"><meta name="copyright" content="洛雪"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="还是希望能比较系统地回顾一下爬虫的一些知识，不过有一些我也记不清了。 可能对小白不是很友好。 如果看视频可以参考这个。 Python爬虫从入门到小黑屋 概论 爬虫的矛与盾 robots.txt协议： 君子协议。规定了网站中哪些数据可以被爬取哪些数据不可以被爬取。  Request与第一个爬虫 1pip install -i https:&#x2F;&#x2F;pypi.tuna.tsinghua.edu.cn&#x2F;sim"><meta property="og:type" content="article"><meta property="og:title" content="Python爬虫从入门到小黑屋"><meta property="og:url" content="https://zwn2001.space/posts/Python%E7%88%AC%E8%99%AB%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%B0%8F%E9%BB%91%E5%B1%8B/index.html"><meta property="og:site_name" content="ZWN&#39;s blog"><meta property="og:description" content="还是希望能比较系统地回顾一下爬虫的一些知识，不过有一些我也记不清了。 可能对小白不是很友好。 如果看视频可以参考这个。 Python爬虫从入门到小黑屋 概论 爬虫的矛与盾 robots.txt协议： 君子协议。规定了网站中哪些数据可以被爬取哪些数据不可以被爬取。  Request与第一个爬虫 1pip install -i https:&#x2F;&#x2F;pypi.tuna.tsinghua.edu.cn&#x2F;sim"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://zwn2001.space/img/cover3/29.jpg"><meta property="article:published_time" content="2022-07-05T07:24:21.000Z"><meta property="article:modified_time" content="2023-08-27T12:12:18.891Z"><meta property="article:author" content="洛雪"><meta property="article:tag" content="Python"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://zwn2001.space/img/cover3/29.jpg"><link rel="shortcut icon" href="/img/favicon.webp"><link rel="canonical" href="https://zwn2001.space/posts/Python%E7%88%AC%E8%99%AB%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%B0%8F%E9%BB%91%E5%B1%8B/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://unpkg.com/@fancyapps/ui/dist/fancybox/fancybox.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.xml",preload:!0,top_n_per_article:-1,unescape:!1,languages:{hits_empty:"找不到您查询的内容：${query}",hits_stats:"共找到 ${hits} 篇文章"}},translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"简"},noticeOutdate:{limitDay:200,position:"top",messagePrev:"距离上次更新已经过去",messageNext:"天啦！注意内容可能过时。"},highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:300},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"天",dateSuffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"fancybox",Snackbar:void 0,source:{justifiedGallery:{js:"https://unpkg.com/flickr-justified-gallery/dist/fjGallery.min.js",css:"https://unpkg.com/flickr-justified-gallery/dist/fjGallery.css"}},isPhotoFigcaption:!0,islazyload:!0,isAnchor:!0,percent:{toc:!0,rightside:!0},autoDarkmode:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"Python爬虫从入门到小黑屋",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2023-08-27 20:12:18"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,a){0!==a&&(a=864e5*a,t={value:t,expiry:(new Date).getTime()+a},localStorage.setItem(e,JSON.stringify(t)))},get:function(e){var t=localStorage.getItem(e);if(t){t=JSON.parse(t);if(!((new Date).getTime()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=o=>new Promise((t,e)=>{const a=document.createElement("script");a.src=o,a.async=!0,a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.getCSS=(o,n=!1)=>new Promise((t,e)=>{const a=document.createElement("link");a.rel="stylesheet",a.href=o,n&&(a.id=n),a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","ffffff")};e=saveToLocal.get("theme"),"dark"===e?activateDarkMode():"light"===e&&activateLightMode(),e=saveToLocal.get("aside-status");void 0!==e&&("hide"===e?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="/css/transpancy.css"><link rel="stylesheet" href="/css/iconfont.css"><link rel="stylesheet" href="/css/rightmenu.css"><link rel="stylesheet" href="/css/loadimg.css"><link rel="stylesheet" href="/css/project.css"><link type="text/html" rel="stylesheet" href="/css/wide_screen.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css"><style>#recent-posts>.recent-post-item>.recent-post-info>.article-meta-wrap>.tags:before{content:"\A";white-space:pre}#recent-posts>.recent-post-item>.recent-post-info>.article-meta-wrap>.tags>.article-meta__separator{display:none}</style><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" src="/img/favicon.webp"><div class="loading-image-dot"></div><div id="loading-percentage"></div></div></div><script>const loadingPercentage=document.getElementById("loading-percentage");loadingPercentage.style.color="black";let loadingPercentageTimer=setInterval(function(){var e=document.querySelector(".pace-progress");e&&(e=e.getAttribute("data-progress-text"))!==loadingPercentage.textContent&&"60%"===(loadingPercentage.textContent=e)&&clearInterval(loadingPercentageTimer)},100);const preloader={endLoading:()=>{document.body.style.overflow="auto",document.getElementById("loading-box").classList.add("loaded")},initLoading:()=>{document.body.style.overflow="",document.getElementById("loading-box").classList.remove("loaded")}};window.addEventListener("load",()=>{preloader.endLoading()})</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/favicon.webp" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">139</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">43</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(/img/cover3/29.jpg)"><nav id="nav"><span id="blog-info"><a href="/" title="ZWN's blog"><span class="site-name">ZWN's blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-search fa-fw"></i> <span>搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Python爬虫从入门到小黑屋</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-07-05T07:24:21.000Z" title="发表于 2022-07-05 15:24:21">2022-07-05</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-08-27T12:12:18.891Z" title="更新于 2023-08-27 20:12:18">2023-08-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BC%96%E7%A8%8B%E7%9F%A5%E8%AF%86/">编程知识</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">14.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>59分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>还是希望能比较系统地回顾一下爬虫的一些知识，不过有一些我也记不清了。</p><p>可能对小白不是很友好。</p><p>如果看视频可以参考<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.bilibili.com/video/BV1i54y1h75W?spm_id_from=333.999.0.0&amp;vd_source=5554e288a62f91301c113fd5a78e9d87">这个</a>。</p><h1>Python爬虫从入门到小黑屋</h1><h2 id="概论">概论</h2><h3 id="爬虫的矛与盾">爬虫的矛与盾</h3><p><code>robots.txt</code>协议： 君子协议。规定了网站中哪些数据可以被爬取哪些数据不可以被爬取。</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="1.png" style="zoom:30%"><h3 id="Request与第一个爬虫"><code>Request</code>与第一个爬虫</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -i https://pypi.tuna.tsinghua.edu.cn/simple requests</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    url = <span class="string">&quot;https://fanyi.baidu.com/sug&quot;</span></span><br><span class="line"></span><br><span class="line">    s = <span class="built_in">input</span>(<span class="string">&quot;请输入你要翻译的英文单词&quot;</span>)</span><br><span class="line">    dat = &#123;</span><br><span class="line">        <span class="string">&quot;kw&quot;</span>: s</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 发送post请求, 发送的数据必须放在字典中, 通过data参数进行传递</span></span><br><span class="line">    resp = requests.post(url, data=dat)</span><br><span class="line">    <span class="built_in">print</span>(resp.json())  <span class="comment"># 将服务器返回的内容直接处理成json()  =&gt; dict</span></span><br><span class="line">    resp.close()</span><br></pre></td></tr></table></figure><h2 id="数据解析">数据解析</h2><p>有时我们不需要爬取整个界面的内容，我们只希望提取出一小部分从而提高效率，有不同的解析方式可以使用，混合使用也无妨。</p><h3 id="正则表达式">正则表达式</h3><p><code>Python</code>中使用<code>re</code>模块进行正则匹配，<code>re</code>中封装了一些函数，不过还是喜欢直接写正则表达式。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">使用函数：</span><br><span class="line">findall:  匹配字符串中所有的符合正则的内容，返回list</span><br><span class="line">finditer: 匹配字符串中所有的内容[返回的是迭代器], 从迭代器中拿到内容需要.group()</span><br></pre></td></tr></table></figure><p>有些正则含有特殊符号比如<code>\n,\d</code>等等，<code>PyCharm</code>可能有<code>Warning</code>，前面加个<code>r</code>就好了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="comment"># 预加载正则表达式</span></span><br><span class="line">obj = re.<span class="built_in">compile</span>(<span class="string">r&quot;\d+&quot;</span>)</span><br><span class="line"></span><br><span class="line">ret = obj.finditer(<span class="string">&quot;我的电话号是:10086, 我女朋友的电话是:10010&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> it <span class="keyword">in</span> ret:</span><br><span class="line">    <span class="built_in">print</span>(it.group())</span><br><span class="line"></span><br><span class="line">ret = obj.findall(<span class="string">&quot;呵呵哒, 我就不信你不换我1000000000&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(ret)</span><br><span class="line"></span><br><span class="line">s = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">&lt;div class=&#x27;jay&#x27;&gt;&lt;span id=&#x27;1&#x27;&gt;郭麒麟&lt;/span&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;div class=&#x27;jj&#x27;&gt;&lt;span id=&#x27;2&#x27;&gt;宋铁&lt;/span&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;div class=&#x27;jolin&#x27;&gt;&lt;span id=&#x27;3&#x27;&gt;大聪明&lt;/span&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;div class=&#x27;sylar&#x27;&gt;&lt;span id=&#x27;4&#x27;&gt;范思哲&lt;/span&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;div class=&#x27;tory&#x27;&gt;&lt;span id=&#x27;5&#x27;&gt;胡说八道&lt;/span&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (?P&lt;分组名字&gt;正则) 可以单独从正则匹配的内容中进一步提取内容</span></span><br><span class="line">obj = re.<span class="built_in">compile</span>(<span class="string">r&quot;&lt;div class=&#x27;.*?&#x27;&gt;&lt;span id=&#x27;(?P&lt;id&gt;\d+)&#x27;&gt;(?P&lt;wahaha&gt;.*?)&lt;/span&gt;&lt;/div&gt;&quot;</span>, re.S)  <span class="comment"># re.S: 让.能匹配换行符</span></span><br><span class="line"></span><br><span class="line">result = obj.finditer(s)</span><br><span class="line"><span class="keyword">for</span> it <span class="keyword">in</span> result:</span><br><span class="line">    <span class="built_in">print</span>(it.group(<span class="string">&quot;wahaha&quot;</span>))</span><br><span class="line">    <span class="built_in">print</span>(it.group(<span class="string">&quot;id&quot;</span>))</span><br></pre></td></tr></table></figure><h4 id="正则样例：豆瓣top250">正则样例：豆瓣top250</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 拿到页面源代码.   requests</span></span><br><span class="line"><span class="comment"># 通过re来提取想要的有效信息  re</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">    url = <span class="string">&quot;https://movie.douban.com/top250&quot;</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&quot;user-agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.192 Safari/537.36&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    resp = requests.get(url, headers=headers)</span><br><span class="line">    page_content = resp.text</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 解析数据</span></span><br><span class="line">    obj = re.<span class="built_in">compile</span>(<span class="string">&#x27;&lt;li&gt;.*?&lt;div class=&quot;item&quot;&gt;.*?&lt;span class=&quot;title&quot;&gt;(?P&lt;name&gt;.*?)&#x27;</span></span><br><span class="line">                     <span class="string">&#x27;&lt;/span&gt;.*?&lt;p class=&quot;&quot;&gt;.*?&lt;br&gt;(?P&lt;year&gt;.*?)&amp;nbsp.*?&lt;span &#x27;</span></span><br><span class="line">                     <span class="string">&#x27;class=&quot;rating_num&quot; property=&quot;v:average&quot;&gt;(?P&lt;score&gt;.*?)&lt;/span&gt;.*?&#x27;</span></span><br><span class="line">                     <span class="string">&#x27;&lt;span&gt;(?P&lt;num&gt;.*?)人评价&lt;/span&gt;&#x27;</span>, re.S)</span><br><span class="line">    <span class="comment"># 开始匹配</span></span><br><span class="line">    result = obj.finditer(page_content)</span><br><span class="line">    f = <span class="built_in">open</span>(<span class="string">&quot;data.csv&quot;</span>, mode=<span class="string">&quot;w&quot;</span>)</span><br><span class="line">    csvwriter = csv.writer(f)</span><br><span class="line">    <span class="keyword">for</span> it <span class="keyword">in</span> result:</span><br><span class="line">        dic = it.groupdict()</span><br><span class="line">        dic[<span class="string">&#x27;year&#x27;</span>] = dic[<span class="string">&#x27;year&#x27;</span>].strip()</span><br><span class="line">        csvwriter.writerow(dic.values())</span><br><span class="line"></span><br><span class="line">    f.close()</span><br><span class="line">    resp.close()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;over!&quot;</span>)</span><br></pre></td></tr></table></figure><p>其中<code>.*?</code>过滤标签后可能的换行或者空格，或者一些不必要的标签内容。</p><h3 id="bs4"><code>bs4</code></h3><p><code>bs4</code>的原理就是解析检索<code>html</code>标签，对于文件路径直接写在网站源码里的情况十分方便。</p><p>通常使用的方法是<code>find()</code>和<code>find_all()</code>以及<code>get()</code>，故名思意，前两个是标签查找，会查找到相应的标签，并且可以通过标签内属性值进行过滤，后一个则是获取标签中属性的内容。具体用法还是看样例。</p><h4 id="样例">样例</h4><p>这个样例是爬图片，一个问题是图片链接在二级子页面中，所以先要获取子页面源码</p><p>先找到这个<code>div</code>下的所有表项。</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="2.png" style="zoom:30%"><p>然后在其中找到子页面的路径</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="3.png" style="zoom:30%"><p>到子页面中找到图片链接</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="4.png" style="zoom:30%"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.拿到主页面的源代码. 然后提取到子页面的链接地址, href</span></span><br><span class="line"><span class="comment"># 2.通过href拿到子页面的内容. 从子页面中找到图片的下载地址 img -&gt; src</span></span><br><span class="line"><span class="comment"># 3.下载图片</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;https://www.umei.cc/bizhitupian/weimeibizhi/&quot;</span></span><br><span class="line">resp = requests.get(url)</span><br><span class="line">resp.encoding = <span class="string">&#x27;utf-8&#x27;</span>  <span class="comment"># 处理乱码</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(resp.text)</span></span><br><span class="line"><span class="comment"># 把源代码交给bs</span></span><br><span class="line">main_page = BeautifulSoup(resp.text, features=<span class="string">&quot;html.parser&quot;</span>)</span><br><span class="line">resp.close()</span><br><span class="line">alist = main_page.find(<span class="string">&#x27;div&#x27;</span>, class_=<span class="string">&quot;swiper-wrapper after&quot;</span>).find_all(<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(alist)</span><br><span class="line"><span class="keyword">for</span> a <span class="keyword">in</span> alist:</span><br><span class="line">    href = a.get(<span class="string">&#x27;href&#x27;</span>)  <span class="comment"># 直接通过get就可以拿到属性的值</span></span><br><span class="line">    <span class="built_in">print</span>(href)</span><br><span class="line">    <span class="comment"># 拿到子页面的源代码</span></span><br><span class="line">    child_page_resp = requests.get(<span class="string">&#x27;https://www.umei.cc&#x27;</span> + href)</span><br><span class="line">    child_page_resp.encoding = <span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line">    child_page_text = child_page_resp.text</span><br><span class="line">    <span class="comment"># 从子页面中拿到图片的下载路径</span></span><br><span class="line">    child_page = BeautifulSoup(child_page_text, <span class="string">&quot;html.parser&quot;</span>)</span><br><span class="line">    child_page_resp.close()</span><br><span class="line">    src = child_page.find(<span class="string">&#x27;section&#x27;</span>, class_=<span class="string">&quot;img-content&quot;</span>).find(<span class="string">&#x27;img&#x27;</span>).get(<span class="string">&#x27;src&#x27;</span>)</span><br><span class="line">    <span class="comment"># 下载图片</span></span><br><span class="line">    img_resp = requests.get(src)</span><br><span class="line">    <span class="comment"># img_resp.content  # 这里拿到的是字节</span></span><br><span class="line">    img_name = src.split(<span class="string">&quot;/&quot;</span>)[-<span class="number">1</span>]  <span class="comment"># 拿到url中的最后一个/以后的内容</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;img/&quot;</span> + img_name, mode=<span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(img_resp.content)  <span class="comment"># 图片内容写入文件</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;over!!!&quot;</span>, img_name)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;all over!!!&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="xpath"><code>xpath</code></h3><p>常用来直接解析网页源码，对于<code>html</code>标签，我们可以将其转化成树的形式，就可以通过树的父子关系进行提取。</p><p><code>div[2]</code>代表第<code>n</code>个<code>div</code>标签，<code>div</code>表示该层标签只有唯一一个，最后使用<code>text()</code>提取标签内数据。</p><p>获取<code>xpath</code>的方法：浏览器控制台 -&gt; <code>Elements</code> -&gt; 找到标签所在块 -&gt; 右键选<code>Copy</code> -&gt; 选 <code>Copy full Xpath</code></p><h4 id="样例-2">样例</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;https://www.runoob.com/python/att-string-strip.html&quot;</span></span><br><span class="line">resp = requests.get(url,proxies=&#123;<span class="string">&quot;https&quot;</span>:<span class="string">&quot;127.0.0.1:7890&quot;</span>&#125;)</span><br><span class="line"><span class="comment"># print(resp.text)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 解析</span></span><br><span class="line">html = etree.HTML(resp.text)</span><br><span class="line"></span><br><span class="line">divs = html.xpath(<span class="string">&quot;/html/body/div[4]/div/div[2]/div/div[3]/div/h1/text()&quot;</span>)</span><br><span class="line"><span class="comment"># 甚至可以这样</span></span><br><span class="line">h1 = html.xpath(<span class="string">&quot;/html/body/div[4]/div/div[2]/div/div[3]/div/h1&quot;</span>)</span><br><span class="line">res = h1.xpath(<span class="string">&quot;./text()&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(divs)</span><br></pre></td></tr></table></figure><h2 id="模拟登录">模拟登录</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 登录 -&gt; 得到cookie</span></span><br><span class="line"><span class="comment"># 带着cookie 去请求到书架url -&gt; 书架上的内容</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 必须得把上面的两个操作连起来</span></span><br><span class="line"><span class="comment"># 我们可以使用session进行请求 -&gt; session你可以认为是一连串的请求. 在这个过程中的cookie不会丢失</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment"># 会话</span></span><br><span class="line">session = requests.session()</span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&quot;loginName&quot;</span>: <span class="string">&quot;你的用户名&quot;</span>,</span><br><span class="line">    <span class="string">&quot;password&quot;</span>: <span class="string">&quot;密码&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 登录</span></span><br><span class="line">url = <span class="string">&quot;https://passport.17k.com/ck/user/login&quot;</span></span><br><span class="line">resp = session.post(url, data=data)</span><br><span class="line"><span class="built_in">print</span>(resp.text)</span><br><span class="line"><span class="built_in">print</span>(resp.cookies)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 拿书架上的数据</span></span><br><span class="line"><span class="comment"># 刚才的那个session中是有cookie的</span></span><br><span class="line">resp = session.get(<span class="string">&#x27;https://user.17k.com/ck/author/shelf?page=1&amp;appKey=2406394919&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(resp.json())</span><br><span class="line">resp.close()</span><br></pre></td></tr></table></figure><h2 id="防盗链">防盗链</h2><p>有些资源（视频）使用防盗链标记打开视频的界面，在请求时没有放到链就会被认为是非法请求。</p><p>同时有些视频的<code>video</code>链接并不显式地写在页面源代码里，此处以梨视频爬取为例。</p><p>首先检查源代码我们只能找到视频封面，但在播放时审查界面元素我们是可以找到视频播放地址的，说明地址是动态生成的。</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="6.png" style="zoom:30%"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="5.png" style="zoom:30%"><p>比如我所看的这个视频链接是：</p><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://video.pearvideo.com/mp4/adshort/20220607/cont-1764629-15892192_adpkg-ad_hd.mp4">https://video.pearvideo.com/mp4/adshort/20220607/cont-1764629-15892192_adpkg-ad_hd.mp4</a></p><p>刷新界面，使用控制台进行跟踪，选中<code>Fetch/XHR</code>我们会找到一个请求，进行预览就会发现一个貌似是视频链接的链接：</p><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://video.pearvideo.com/mp4/adshort/20220607/1657102159673-15892192_adpkg-ad_hd.mp4">https://video.pearvideo.com/mp4/adshort/20220607/1657102159673-15892192_adpkg-ad_hd.mp4</a></p><p>但一比对就会发现好像不太对，我们找到的这个还不太一样，观察这个请求就会发现其实应该把下面链接中不一样的那部分换上<code>cont-</code>加上请求中的<code>systemTime</code>参数值，然后我们就可以下载视频。</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="7.png" style="zoom:30%"><p>但如果请求头中没有加<code>Referer</code>参数，你会发现返回结果是 “视频已下架”。加上即可。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 拿到contId</span></span><br><span class="line"><span class="comment"># 2. 拿到videoStatus返回的json. -&gt;  srcURL</span></span><br><span class="line"><span class="comment"># 3. srcURL里面的内容进行修整</span></span><br><span class="line"><span class="comment"># 4. 下载视频</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拉取视频的网址</span></span><br><span class="line">url = <span class="string">&quot;https://www.pearvideo.com/video_1721605&quot;</span></span><br><span class="line">contId = url.split(<span class="string">&quot;_&quot;</span>)[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">videoStatusUrl = <span class="string">f&quot;https://www.pearvideo.com/videoStatus.jsp?contId=<span class="subst">&#123;contId&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.192 Safari/537.36&quot;</span>,</span><br><span class="line">    <span class="comment"># 防盗链: 溯源, 当前本次请求的上一级是谁</span></span><br><span class="line">    <span class="string">&quot;Referer&quot;</span>: url</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resp = requests.get(videoStatusUrl, headers=headers)</span><br><span class="line">dic = resp.json()</span><br><span class="line"></span><br><span class="line">srcUrl = dic[<span class="string">&#x27;videoInfo&#x27;</span>][<span class="string">&#x27;videos&#x27;</span>][<span class="string">&#x27;srcUrl&#x27;</span>]</span><br><span class="line">systemTime = dic[<span class="string">&#x27;systemTime&#x27;</span>]</span><br><span class="line">srcUrl = srcUrl.replace(systemTime, <span class="string">f&quot;cont-<span class="subst">&#123;contId&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载视频</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;a.mp4&quot;</span>, mode=<span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(requests.get(srcUrl).content)</span><br></pre></td></tr></table></figure><h2 id="加密数据的解析-以抓取网易云热评为例">加密数据的解析-以抓取网易云热评为例</h2><p>这里是我自己实践的过程，具体详细步骤可以参看B站视频</p><p>同样我们可以找到请求所有评论的url（当然这就意味着不是写在源代码里的）</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="8.png" style="zoom:30%"><p>这样我们可以确定请求的链接</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="9.png" style="zoom:30%"><p>题外话：请求头中也包括了防盗链如果请求失败（没有返回）可以考虑防盗链，或者考虑加上里面的<code>user-agent</code>字段。</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="10.png" style="zoom:30%"><p>我们来查看请求的参数，但发现是加密过的，而且如果不加，请求是没有返回值的，我们的难点在于确定加密过程与原来的参数。我们查看请求的调用栈</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="11.png" style="zoom:30%"><p>调用栈自下向上是调用的从先到后的顺序，我们查看最后调用的代码，也就是第一行。</p><p>注意进入后使用左下角的一对大括号对代码进行格式化。</p><p>在<code>js</code>代码中打断点，刷新界面，点击resume直到到达我们的目标url，我们会发现断点处请求的数据是加密过的（<s>废话</s>）</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="12.png" style="zoom:30%"><p>我们沿着调用栈 (<code>Call Stack</code>) 一层一层向下找。我们会找到一层调用栈，数据是明文的，那么加密的过程就在下一层调用栈中。</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="13.png" style="zoom:30%"><p>我们最终会找到加密代码与赋值的代码</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="14.png" style="zoom:30%"><p>直接<code>ctrl+f</code>搜索就能找到加密用的函数，我们就可以模拟这个加密过程进行加密</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="15.png" style="zoom:30%"><p>注意：常用的序列化与反序列化</p><p><code>json.dumps()</code>----将<code>Python</code>的字典数据转换成<code>json</code>字符,数据的最外面都添加一层&quot;&quot;变为字符串，这也是数据的序列化步骤</p><p><code>json.loads()</code>----将<code>json</code>字符串数据转换为字典或列表（去掉外面一层&quot;&quot;)，这个也是反序列化的步骤。</p><p>​</p><h2 id="多线程">多线程</h2><h3 id="前言">前言</h3><blockquote><p>作者：DarrenChan陈驰<br>链接：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.zhihu.com/question/23474039/answer/269526476">https://www.zhihu.com/question/23474039/answer/269526476</a></p></blockquote><p>在介绍Python中的线程之前，先明确一个问题，Python中的多线程是<strong>假的多线程</strong>！ 为什么这么说，我们先明确一个概念，全局解释器锁（GIL）。</p><p>Python代码的执行由Python虚拟机（解释器）来控制。Python在设计之初就考虑要在主循环中，同时只有一个线程在执行，就像单CPU的系统中运行多个进程那样，内存中可以存放多个程序，但任意时刻，只有一个程序在CPU中运行。同样地，虽然Python解释器可以运行多个线程，只有一个线程在解释器中运行。</p><p>对Python虚拟机的访问由全局解释器锁（GIL）来控制，正是这个锁能保证同时只有一个线程在运行。在多线程环境中，Python虚拟机按照以下方式执行。</p><blockquote><p>1.设置GIL。</p><p>2.切换到一个线程去执行。</p><p>3.运行。</p><p>4.把线程设置为睡眠状态。</p><p>5.解锁GIL。</p><p>6.再次重复以上步骤。</p></blockquote><p>对所有面向I/O的（会调用内建的操作系统C代码的）程序来说，GIL会在这个I/O调用之前被释放，以允许其他线程在这个线程等待I/O的时候运行。如果某线程并未使用很多I/O操作，它会在自己的时间片内一直占用处理器和GIL。也就是说，I/O密集型的Python程序比计算密集型的Python程序更能充分利用多线程的好处。</p><p>我们都知道，比方我有一个4核的CPU，那么这样一来，在单位时间内每个核只能跑一个线程，然后时间片轮转切换。但是Python不一样，它不管你有几个核，单位时间多个核只能跑一个线程，然后时间片轮转。看起来很不可思议？但是这就是GIL搞的鬼。任何Python线程执行前，必须先获得GIL锁，然后，每执行100条<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.zhihu.com/search?q=%E5%AD%97%E8%8A%82%E7%A0%81&amp;search_source=Entity&amp;hybrid_search_source=Entity&amp;hybrid_search_extra=%7B%22sourceType%22%3A%22answer%22%2C%22sourceId%22%3A269526476%7D">字节码</a>，解释器就自动释放GIL锁，让别的线程有机会执行。这个GIL全局锁实际上把所有线程的执行代码都给上了锁，所以，多线程在Python中只能交替执行，即使100个线程跑在100核CPU上，也只能用到1个核。通常我们用的解释器是官方实现的CPython，要真正利用多核，除非重写一个不带GIL的解释器。</p><p>我们不妨做个试验：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">loop</span>():</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        t = Thread(target=loop)</span><br><span class="line">        t.start()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>我的电脑是4核，所以我开了4个线程，看一下CPU资源占有率：</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="16.png" style="zoom:50%"><p>我们发现CPU利用率并没有占满，大致相当于单核水平。</p><p>而如果我们变成进程呢？</p><p>我们改一下代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">loop</span>():</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        t = Process(target=loop)</span><br><span class="line">        t.start()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="17.png" style="zoom:50%"><p>结果直接飙到了100%，说明进程是可以利用多核的！</p><p>为了验证这是Python中的GIL搞得鬼，我试着用Java写相同的代码，开启线程，我们观察一下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.darrenchan.thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestThread</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="18.png" style="zoom:50%"><p>由此可见，Java中的多线程是可以利用多核的，这是真正的多线程！而Python中的多线程只能利用单核，这是假的多线程！</p><p>难道就如此？我们没有办法在Python中利用多核？当然可以！刚才的<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.zhihu.com/search?q=%E5%A4%9A%E8%BF%9B%E7%A8%8B&amp;search_source=Entity&amp;hybrid_search_source=Entity&amp;hybrid_search_extra=%7B%22sourceType%22%3A%22answer%22%2C%22sourceId%22%3A269526476%7D">多进程</a>算是一种解决方案，还有一种就是调用C语言的链接库。对所有面向I/O的（会调用内建的操作系统C代码的）程序来说，GIL会在这个I/O调用之前被释放，以允许其他线程在这个线程等待I/O的时候运行。我们可以把一些 计算密集型任务用C语言编写，然后把.so链接库内容加载到Python中，因为执行C代码，GIL锁会释放，这样一来，就可以做到每个核都跑一个线程的目的！</p><p>可能有的小伙伴不太理解什么是计算密集型任务，什么是I/O密集型任务？</p><p>计算密集型任务的特点是要进行大量的计算，消耗CPU资源，比如计算圆周率、对视频进行高清解码等等，全靠CPU的运算能力。这种计算密集型任务虽然也可以用多任务完成，但是任务越多，花在任务切换的时间就越多，CPU执行任务的效率就越低，所以，要最高效地利用CPU，计算密集型任务同时进行的数量应当等于CPU的核心数。</p><p>计算密集型任务由于主要消耗CPU资源，因此，代码运行效率至关重要。Python这样的脚本语言运行效率很低，完全不适合计算密集型任务。对于计算密集型任务，最好用C语言编写。</p><p>第二种任务的类型是IO密集型，涉及到网络、磁盘IO的任务都是IO密集型任务，这类任务的特点是CPU消耗很少，任务的大部分时间都在等待IO操作完成（因为IO的速度远远低于CPU和内存的速度）。对于IO密集型任务，任务越多，CPU效率越高，但也有一个限度。常见的大部分任务都是IO密集型任务，比如Web应用。</p><p>IO密集型任务执行期间，99%的时间都花在IO上，花在CPU上的时间很少，因此，用运行速度极快的C语言替换用Python这样运行速度极低的脚本语言，完全无法提升运行效率。对于IO密集型任务，最合适的语言就是开发效率最高（代码量最少）的语言，脚本语言是首选，C语言最差。</p><p>综上，Python多线程相当于单核多线程，多线程有两个好处：CPU并行，IO并行，单核多线程相当于自断一臂。所以，在Python中，可以使用多线程，但不要指望能有效利用多核。如果一定要通过多线程利用多核，那只能通过C扩展来实现，不过这样就失去了Python简单易用的特点。不过，也不用过于担心，Python虽然不能利用多线程实现多核任务，但可以通过多进程实现多核任务。多个Python进程有各自独立的GIL锁，互不影响。</p><h3 id="多线程的两种形式">多线程的两种形式</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">func</span>(<span class="params">name</span>):  </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):</span><br><span class="line">        <span class="built_in">print</span>(name, i)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    t1 = Thread(target=func, args=(<span class="string">&quot;t1&quot;</span>,))  <span class="comment"># 传递参数必须是元组</span></span><br><span class="line">    t1.start()</span><br><span class="line"></span><br><span class="line">    t2 = Thread(target=func, args=(<span class="string">&quot;t2&quot;</span>,))</span><br><span class="line">    t2.start()</span><br></pre></td></tr></table></figure><p>上面其实给出了多线程常用的一种形式，也可以通过面向对象的方式：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyThread</span>(<span class="title class_ inherited__">Thread</span>):  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):  </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;子线程&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    t = MyThread()</span><br><span class="line">    t.start()  </span><br></pre></td></tr></table></figure><h2 id="多进程">多进程</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func</span>():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;子进程&quot;</span>, i)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    p = Process(target=func)</span><br><span class="line">    p.start()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;主进程&quot;</span>, i)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyProcess</span>(<span class="title class_ inherited__">Process</span>):  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):  </span><br><span class="line">       <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):</span><br><span class="line">          <span class="built_in">print</span>(<span class="string">&quot;子进程&quot;</span>, i)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    t = MyProcess()</span><br><span class="line">    t.start()  </span><br></pre></td></tr></table></figure><h2 id="线程池与进程池">线程池与进程池</h2><p>通过这种方式减少垃圾对象回收</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor, ProcessPoolExecutor</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fn</span>(<span class="params">name</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):</span><br><span class="line">        <span class="built_in">print</span>(name, i)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># 创建线程池</span></span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(<span class="number">50</span>) <span class="keyword">as</span> t:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">            t.submit(fn, name=<span class="string">f&quot;线程<span class="subst">&#123;i&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="comment"># 等待线程池中的任务全部执行完毕. 才继续执行后面代码(守护)</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;123&quot;</span>)</span><br></pre></td></tr></table></figure><h2 id="协程">协程</h2><p>转自 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://zhuanlan.zhihu.com/p/68043798%EF%BC%8C%E6%9C%89%E6%94%B9%E5%8A%A8">https://zhuanlan.zhihu.com/p/68043798，有改动</a></p><p>由于<code>GIL</code>的存在，导致<code>Python</code>多线程性能甚至比单线程更糟。</p><blockquote><p><code>GIL</code>: 全局解释器锁（英语：<code>Global Interpreter Lock</code>，缩写GIL），是计算机程序设计语言解释器用于同步线程的一种机制，它使得任何时刻仅有一个线程在执行。即便在多核心处理器上，使用 GIL 的解释器也只允许同一时间执行一个线程。</p></blockquote><p>于是出现了协程（<code>Coroutine</code>）这么个东西。</p><blockquote><p>协程: 协程，又称微线程，纤程，英文名<code>Coroutine</code>。协程的作用，是在执行函数A时，可以随时中断，去执行函数B，然后中断继续执行函数A（可以自由切换）。但这一过程并不是函数调用（没有调用语句），这一整个过程看似像多线程，然而协程只有一个线程执行.</p></blockquote><p>协程由于由程序主动控制切换，没有线程切换的开销，所以执行效率极高。对于IO密集型任务非常适用，如果是cpu密集型，推荐多进程+协程的方式。</p><p><strong>进程/线程：操作系统提供的一种并发处理任务的能力。</strong></p><p><strong>协程：程序员通过高超的代码能力，在代码执行流程中人为的实现多任务并发，是单个线程内的任务调度技巧。</strong></p><p>多进程和多线程体现的是操作系统的能力，而协程体现的是程序员的流程控制能力。</p><p>在<code>Python3.4</code>之前，官方没有对协程的支持，存在一些三方库的实现，比如<code>gevent</code>和<code>Tornado</code>。3.4之后就内置了<code>asyncio</code>标准库，官方真正实现了协程这一特性。</p><p>而<code>Python</code>对协程的支持，是通过<code>Generator</code>实现的，协程是遵循某些规则的生成器。因此，我们在了解协程之前，我们先要学习生成器。</p><h3 id="生成器-Generator">生成器(<code>Generator</code>)</h3><p>我们这里主要讨论<code>yield</code>和<code>yield from</code>这两个表达式，这两个表达式和协程的实现息息相关。</p><ul><li><code>Python2.5</code>中引入<code>yield</code>表达式，参见<a href="https://link.zhihu.com/?target=https%3A//www.python.org/dev/peps/pep-0342/" rel="external nofollow noreferrer">PEP342</a></li><li><code>Python3.3</code>中增加<code>yield from</code>语法，参见<a href="https://link.zhihu.com/?target=https%3A//www.python.org/dev/peps/pep-0380/" rel="external nofollow noreferrer">PEP380</a>，</li></ul><p>方法中包含<code>yield</code>表达式后，<code>Python</code>会将其视作<code>generator</code>对象，不再是普通的方法。</p><h4 id="yield表达式的使用"><code>yield</code>表达式的使用</h4><p><strong><code>yield</code>的语法规则是：在<code>yield</code>这里暂停函数的执行，并返回<code>yield</code>后面表达式的值（默认为None），直到被<code>next()</code>方法再次调用时，从上次暂停的yield代码处继续往下执行</strong>。当没有可以继续<code>next()</code>的时候，抛出异常，该异常可被<code>for</code>循环处理。</p><p>该表达式的具体使用：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;generator start&quot;</span>)</span><br><span class="line">    n = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        yield_expression_value = <span class="keyword">yield</span> n</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;yield_expression_value = <span class="subst">&#123;yield_expression_value&#125;</span>&quot;</span>)</span><br><span class="line">        n += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ①创建generator对象</span></span><br><span class="line">generator = test()</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(generator))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\n---------------\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ②启动generator</span></span><br><span class="line">next_result = generator.__next__()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;next_result = <span class="subst">&#123;next_result&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\n---------------\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ③发送值给yield表达式</span></span><br><span class="line">send_result = generator.send(<span class="number">666</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;send_result = <span class="subst">&#123;send_result&#125;</span>&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>执行结果：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;generator&#x27;</span>&gt;</span><br><span class="line"></span><br><span class="line">---------------</span><br><span class="line"></span><br><span class="line">generator start</span><br><span class="line">next_result = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">---------------</span><br><span class="line"></span><br><span class="line">yield_expression_value = <span class="number">666</span></span><br><span class="line">send_result = <span class="number">2</span></span><br></pre></td></tr></table></figure><p>方法说明：</p><ul><li><code>__next__()</code>方法: 作用是启动或者恢复<code>generator</code>的执行，相当于<code>send(None)</code></li><li><code>send(value)</code>方法：作用是发送值给<code>yield</code>表达式。启动<code>generator</code>则是调用<code>send(None)</code></li></ul><p>执行结果的说明：</p><ul><li>①创建<code>generator</code>对象：<strong>包含yield表达式的函数将不再是一个函数，调用之后将会返回<code>generator</code>对象</strong></li><li>②启动<code>generator</code>：使用生成器之前需要先调用<code>__next__</code>或者<code>send(None)</code>，否则将报错。启动<code>generator</code>后，代码将执行到<code>yield</code>出现的位置，也就是执行到<code>yield n</code>，然后将<code>n</code>传递到<code>generator.__next__()</code>这行的返回值。（注意，生成器执行到<code>yield n</code>后将暂停在这里，直到下一次生成器被启动）</li><li>③发送值给<code>yield</code>表达式：调用<code>send</code>方法可以发送值给<code>yield</code>表达式，同时恢复生成器的执行。生成器从上次中断的位置继续向下执行，然后遇到下一个<code>yield</code>，生成器再次暂停，切换到主函数打印出<code>send_result</code>。</li></ul><p>理解这个demo的关键是：生成器启动或恢复执行一次，将会在<code>yield</code>处暂停，返回<code>yield</code>后面表达式的值。上面的第②步仅仅执行到了<code>yield n</code>，并没有执行到赋值语句，到了第③步，生成器恢复执行才给<code>yield_expression_value</code>赋值。</p><h4 id="生产者和消费者模型">生产者和消费者模型</h4><p>上面的例子中，代码中断–&gt;切换执行，体现出了协程的部分特点。</p><p>我们再举一个生产者、消费者的例子，这个例子来自<a href="https://link.zhihu.com/?target=https%3A//www.liaoxuefeng.com/wiki/0014316089557264a6b348958f449949df42a6d3a2e542c000/001432090171191d05dae6e129940518d1d6cf6eeaaa969000" rel="external nofollow noreferrer">廖雪峰的Python教程</a>：</p><blockquote><p>传统的生产者-消费者模型是一个线程写消息，一个线程取消息，通过锁机制控制队列和等待，但一不小心就可能死锁。<br>现在改用协程，生产者生产消息后，直接通过<code>yield</code>跳转到消费者开始执行，待消费者执行完毕后，切换回生产者继续生产，效率极高。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">consumer</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[CONSUMER] start&quot;</span>)</span><br><span class="line">    r = <span class="string">&#x27;start&#x27;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        n = <span class="keyword">yield</span> r</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> n:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;n is empty&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[CONSUMER] Consumer is consuming %s&quot;</span> % n)</span><br><span class="line">        r = <span class="string">&quot;200 ok&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">producer</span>(<span class="params">c</span>):</span><br><span class="line">    <span class="comment"># 启动generator</span></span><br><span class="line">    start_value = c.send(<span class="literal">None</span>)</span><br><span class="line">    <span class="built_in">print</span>(start_value)</span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> n &lt; <span class="number">3</span>:</span><br><span class="line">        n += <span class="number">1</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[PRODUCER] Producer is producing %d&quot;</span> % n)</span><br><span class="line">        r = c.send(n)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;[PRODUCER] Consumer return: %s&#x27;</span> % r)</span><br><span class="line">    <span class="comment"># 关闭generator</span></span><br><span class="line">    c.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建生成器</span></span><br><span class="line">c = consumer()</span><br><span class="line"><span class="comment"># 传入generator</span></span><br><span class="line">producer(c)</span><br></pre></td></tr></table></figure><p>执行结果：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[CONSUMER] start</span><br><span class="line">start</span><br><span class="line">[PRODUCER] producer <span class="keyword">is</span> producing <span class="number">1</span></span><br><span class="line">[CONSUMER] consumer <span class="keyword">is</span> consuming <span class="number">1</span></span><br><span class="line">[PRODUCER] Consumer <span class="keyword">return</span>: <span class="number">200</span> ok</span><br><span class="line">[PRODUCER] producer <span class="keyword">is</span> producing <span class="number">2</span></span><br><span class="line">[CONSUMER] consumer <span class="keyword">is</span> consuming <span class="number">2</span></span><br><span class="line">[PRODUCER] Consumer <span class="keyword">return</span>: <span class="number">200</span> ok</span><br><span class="line">[PRODUCER] producer <span class="keyword">is</span> producing <span class="number">3</span></span><br><span class="line">[CONSUMER] consumer <span class="keyword">is</span> consuming <span class="number">3</span></span><br><span class="line">[PRODUCER] Consumer <span class="keyword">return</span>: <span class="number">200</span> ok</span><br></pre></td></tr></table></figure><blockquote><p>注意到<code>consumer</code>函数是一个<code>generator</code>，把一个<code>consumer</code>传入<code>produce</code>后：</p></blockquote><ol><li>首先调用<code>c.send(None)</code>启动生成器；</li><li>然后，一旦生产了东西，通过<code>c.send(n)</code>切换到<code>consumer</code>执行；</li><li><code>consumer</code>通过<code>yield</code>拿到消息，处理，又通过<code>yield</code>把结果传回；</li><li><code>produce</code>拿到<code>consumer</code>处理的结果，继续生产下一条消息；</li><li><code>produce</code>决定不生产了，通过<code>c.close()</code>关闭<code>consumer</code>，整个过程结束。</li></ol><blockquote><p>整个流程无锁，由一个线程执行，<code>produce</code>和<code>consumer</code>协作完成任务，所以称为“协程”，而非线程的抢占式多任务。</p></blockquote><h4 id="yield-from表达式"><code>yield from</code>表达式</h4><p><code>Python3.3</code>版本新增<code>yield from</code>语法，新语法用于<strong>将一个生成器部分操作委托给另一个生成器</strong>。此外，允许子生成器（即<code>yield from</code>后的“参数”）返回一个值，该值可供委派生成器（即包含<code>yield from</code>的生成器）使用。并且在委派生成器中，可对子生成器进行优化。</p><p>我们先来看最简单的应用，例如：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 子生成器</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>(<span class="params">n</span>):</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> i &lt; n:</span><br><span class="line">        <span class="keyword">yield</span> i</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 委派生成器</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_yield_from</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;test_yield_from start&quot;</span>)</span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> test(n)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;test_yield_from end&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> test_yield_from(<span class="number">3</span>):</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">test_yield_from start</span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line">test_yield_from end</span><br></pre></td></tr></table></figure><p>这里我们仅仅给这个生成器添加了一些打印，如果是正式的代码中，你可以添加正常的执行逻辑。</p><p>如果上面的<code>test_yield_from</code>函数中有两个<code>yield from</code>语句，将串行执行。比如将上面的<code>test_yield_from</code>函数改写成这样：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">test_yield_from</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;test_yield_from start&quot;</span>)</span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> test(n)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;test_yield_from doing&quot;</span>)</span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> test(n)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;test_yield_from end&quot;</span>)</span><br></pre></td></tr></table></figure><p>将输出：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">test_yield_from start</span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line">test_yield_from doing</span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line">test_yield_from end</span><br></pre></td></tr></table></figure><p>在这里，<code>yield from</code>起到的作用相当于下面写法的简写形式</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> test(n):</span><br><span class="line">    <span class="keyword">yield</span> item</span><br></pre></td></tr></table></figure><p>看起来这个<code>yield from</code>也没做什么大不了的事，其实它还帮我们处理了异常之类的。具体可以看<code>stackoverflow</code>上的这个问题：<a href="https://link.zhihu.com/?target=https%3A//stackoverflow.com/questions/9708902/in-practice-what-are-the-main-uses-for-the-new-yield-from-syntax-in-python-3" rel="external nofollow noreferrer">In practice, what are the main uses for the new “yield from” syntax in Python 3.3?</a></p><h3 id="协程-Coroutine">协程(Coroutine)</h3><ul><li><code>Python3.4</code>开始，新增了<code>asyncio</code>相关的<code>API</code>，语法使用[<code>@asyncio.coroutine](mailto:@asyncio.coroutine</code>)和<code>yield from</code>实现协程</li><li><code>Python3.5</code>中引入<code>async</code>/<code>await</code>语法，参见<a href="https://link.zhihu.com/?target=https%3A//www.python.org/dev/peps/pep-0492/" rel="external nofollow noreferrer">PEP492</a></li></ul><p>我们先来看<code>Python3.4</code>的实现。</p><h4 id="asyncio-coroutine-mailto-asyncio-coroutine">[<code>@asyncio.coroutine](mailto:@asyncio.coroutine)</code></h4><p><code>Python3.4</code>中，使用[<code>@asyncio.coroutine](mailto:@asyncio.coroutine)</code>装饰的函数称为协程。不过没有从语法层面进行严格约束。</p><blockquote><h2 id="理解Python装饰器-Decorator">理解Python装饰器(Decorator)</h2><p>Python装饰器看起来类似Java中的注解，然鹅和注解并不相同，不过同样能够实现面向切面编程。</p><p>想要理解Python中的装饰器，不得不先理解闭包（closure）这一概念。</p><h3 id="闭包">闭包</h3><p>看看维基百科中的解释：</p><blockquote><p>在计算机科学中，闭包（英语：Closure），又称词法闭包（Lexical Closure）或函数闭包（function closures），是引用了自由变量的函数。这个被引用的自由变量将和这个函数一同存在，即使已经离开了创造它的环境也不例外。</p></blockquote><p>官方的解释总是不说人话，but–talk is cheap，show me the code:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># print_msg是外围函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_msg</span>():</span><br><span class="line">    msg = <span class="string">&quot;I&#x27;m closure&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># printer是嵌套函数</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">printer</span>():</span><br><span class="line">        <span class="built_in">print</span>(msg)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> printer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里获得的就是一个闭包</span></span><br><span class="line">closure = print_msg()</span><br><span class="line"><span class="comment"># 输出 I&#x27;m closure</span></span><br><span class="line">closure()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上面两行代码相当于print_msg()()</span></span><br></pre></td></tr></table></figure><p><code>msg</code>是一个局部变量，在<code>print_msg</code>函数执行之后应该就不会存在了。但是嵌套函数引用了这个变量，将这个局部变量封闭在了嵌套函数中，这样就形成了一个闭包。</p><p>结合这个例子再看维基百科的解释，就清晰明了多了。<strong>闭包就是引用了自有变量的函数，这个函数保存了执行的上下文，可以脱离原本的作用域独立存在</strong>。</p><h3 id="装饰器">装饰器</h3><p>一个普通的装饰器一般是这样：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def log(<span class="function"><span class="keyword">func</span>):</span></span><br><span class="line">    @functools.wraps(<span class="function"><span class="keyword">func</span>)</span></span><br><span class="line">    def wrapper(*args, **kwargs):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;call %s():&#x27;</span> % <span class="keyword">func</span>.__name__)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;args = &#123;&#125;&#x27;</span>.format(*args))</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(*args, **kwargs)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br></pre></td></tr></table></figure><p>这样就定义了一个打印出方法名及其参数的装饰器。</p><p>调用：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@log</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>(<span class="params">p</span>):</span><br><span class="line">    <span class="built_in">print</span>(test.__name__ + <span class="string">&quot; param: &quot;</span> + p)</span><br><span class="line">    </span><br><span class="line">test(<span class="string">&quot;I&#x27;m a param&quot;</span>)</span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">call <span class="built_in">test</span>():</span><br><span class="line">args = I<span class="string">&#x27;m a param</span></span><br><span class="line"><span class="string">test param: I&#x27;</span>m a param</span><br></pre></td></tr></table></figure><p>装饰器在使用时，用了<code>@</code>语法，让人有些困扰。其实，装饰器只是个方法，与下面的调用方式没有区别：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>(<span class="params">p</span>):</span><br><span class="line">    <span class="built_in">print</span>(test.__name__ + <span class="string">&quot; param: &quot;</span> + p)</span><br><span class="line"></span><br><span class="line">wrapper = log(test)</span><br><span class="line">wrapper(<span class="string">&quot;I&#x27;m a param&quot;</span>)</span><br></pre></td></tr></table></figure><p><code>@</code>语法只是将函数传入装饰器函数，并无神奇之处。</p><p>值得注意的是<code>@functools.wraps(func)</code>，这是python提供的装饰器。它能把原函数的元信息拷贝到装饰器里面的 func 函数中。函数的元信息包括docstring、<strong>name</strong>、参数列表等等。可以尝试去除<code>@functools.wraps(func)</code>，你会发现<code>test.__name__</code>的输出变成了wrapper。</p><h3 id="带参数的装饰器">带参数的装饰器</h3><p>装饰器允许传入参数，一个携带了参数的装饰器将有三层函数，如下所示：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">log_with_param</span>(<span class="params">text</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decorator</span>(<span class="params">func</span>):</span><br><span class="line"><span class="meta">        @functools.wraps(<span class="params">func</span>)</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">wrapper</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;call %s():&#x27;</span> % func.__name__)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;args = &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(*args))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;log_param = &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(text))</span><br><span class="line">            <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> decorator</span><br><span class="line">    </span><br><span class="line"><span class="meta">@log_with_param(<span class="params"><span class="string">&quot;param&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_with_param</span>(<span class="params">p</span>):</span><br><span class="line">    <span class="built_in">print</span>(test_with_param.__name__)</span><br></pre></td></tr></table></figure><p>看到这个代码是不是又有些疑问，内层的decorator函数的参数func是怎么传进去的？和上面一般的装饰器不大一样啊。</p><p>其实道理是一样的，将其<code>@</code>语法去除，恢复函数调用的形式一看就明白了：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 传入装饰器的参数，并接收返回的decorator函数</span></span><br><span class="line">decorator = log_with_param(<span class="string">&quot;param&quot;</span>)</span><br><span class="line"><span class="comment"># 传入test_with_param函数</span></span><br><span class="line">wrapper = decorator(test_with_param)</span><br><span class="line"><span class="comment"># 调用装饰器函数</span></span><br><span class="line">wrapper(<span class="string">&quot;I&#x27;m a param&quot;</span>)</span><br></pre></td></tr></table></figure><p>输出结果与正常使用装饰器相同：</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">call <span class="title function_ invoke__">test_with_param</span>():</span><br><span class="line">args = I<span class="symbol">&#x27;m</span> a param</span><br><span class="line">log_param = param</span><br><span class="line">test_with_param</span><br></pre></td></tr></table></figure><p>至此，装饰器这个有点费解的特性也没什么神秘了。</p><p>装饰器这一语法体现了Python中函数是第一公民，函数是对象、是变量，可以作为参数、可以是返回值，非常的灵活与强大。</p><p>作者：聪明叉<br>链接：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.jianshu.com/p/ee82b941772a">https://www.jianshu.com/p/ee82b941772a</a><br>来源：简书</p></blockquote><p>对于Python原生支持的协程来说，Python对协程和生成器做了一些区分，便于消除这两个不同但相关的概念的歧义：</p><ul><li>标记了[<code>@asyncio.coroutine](mailto:@asyncio.coroutine)</code>装饰器的函数称为协程函数，<code>iscoroutinefunction()</code>方法返回True</li><li>调用协程函数返回的对象称为协程对象，<code>iscoroutine()</code>函数返回True</li></ul><p>举个栗子，我们给上面<code>yield from</code>的demo中添加[<code>@asyncio.coroutine](mailto:@asyncio.coroutine)</code>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">@asyncio.coroutine</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_yield_from</span>(<span class="params">n</span>):</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 是否是协程函数</span></span><br><span class="line"><span class="built_in">print</span>(asyncio.iscoroutinefunction(test_yield_from))</span><br><span class="line"><span class="comment"># 是否是协程对象</span></span><br><span class="line"><span class="built_in">print</span>(asyncio.iscoroutine(test_yield_from(<span class="number">3</span>)))</span><br></pre></td></tr></table></figure><p>毫无疑问输出结果是True。</p><p>可以看下[<code>@asyncio.coroutine](mailto:@asyncio.coroutine)</code>的源码中查看其做了什么，我将其源码简化下，大致如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"><span class="keyword">import</span> types</span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">coroutine</span>(<span class="params">func</span>):</span><br><span class="line">    <span class="comment"># 判断是否是生成器</span></span><br><span class="line">    <span class="keyword">if</span> inspect.isgeneratorfunction(func):</span><br><span class="line">        coro = func</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 将普通函数变成generator</span></span><br><span class="line"><span class="meta">        @functools.wraps(<span class="params">func</span>)</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">coro</span>(<span class="params">*args, **kw</span>):</span><br><span class="line">            res = func(*args, **kw)</span><br><span class="line">            res = <span class="keyword">yield</span> <span class="keyword">from</span> res</span><br><span class="line">            <span class="keyword">return</span> res</span><br><span class="line">    <span class="comment"># 将generator转换成coroutine</span></span><br><span class="line">    wrapper = types.coroutine(coro)</span><br><span class="line">    <span class="comment"># For iscoroutinefunction().</span></span><br><span class="line">    wrapper._is_coroutine = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br></pre></td></tr></table></figure><p>将这个装饰器标记在一个生成器上，就会将其转换成<code>coroutine</code>。</p><p>然后，我们来实际使用下[<code>@asyncio.coroutine](mailto:@asyncio.coroutine)</code>和<code>yield from</code>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="meta">@asyncio.coroutine</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">compute</span>(<span class="params">x, y</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Compute %s + %s ...&quot;</span> % (x, y))</span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> asyncio.sleep(<span class="number">1.0</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"><span class="meta">@asyncio.coroutine</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_sum</span>(<span class="params">x, y</span>):</span><br><span class="line">    result = <span class="keyword">yield</span> <span class="keyword">from</span> compute(x, y)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;%s + %s = %s&quot;</span> % (x, y, result))</span><br><span class="line"></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;start&quot;</span>)</span><br><span class="line"><span class="comment"># 中断调用，直到协程执行结束</span></span><br><span class="line">loop.run_until_complete(print_sum(<span class="number">1</span>, <span class="number">2</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;end&quot;</span>)</span><br><span class="line">loop.close()</span><br></pre></td></tr></table></figure><p>执行结果：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">start</span><br><span class="line">Compute <span class="number">1</span> + <span class="number">2</span> ...</span><br><span class="line"><span class="number">1</span> + <span class="number">2</span> = <span class="number">3</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure><p><code>print_sum</code>这个协程中调用了子协程<code>compute</code>，它将等待<code>compute</code>执行结束才返回结果。</p><p>这个demo点调用流程如下图：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="20.jpg" alt=""></p><p><code>EventLoop</code>将会把<code>print_sum</code>封装成Task对象</p><p>流程图展示了这个demo的控制流程，不过没有展示其全部细节。比如其中“暂停”的1s，实际上创建了一个future对象, 然后通过<code>BaseEventLoop.call_later()</code>在1s后唤醒这个任务。</p><p>值得注意的是，[<code>@asyncio.coroutine](mailto:@asyncio.coroutine)</code>将在Python3.10版本中移除。</p><h4 id="async-await"><code>async</code>/<code>await</code></h4><p>Python3.5开始引入<code>async</code>/<code>await</code>语法（<a href="https://link.zhihu.com/?target=https%3A//www.python.org/dev/peps/pep-0492" rel="external nofollow noreferrer">PEP 492</a>），用来简化协程的使用并且便于理解。</p><p><code>async</code>/<code>await</code>实际上只是[<code>@asyncio.coroutine](mailto:@asyncio.coroutine)</code>和<code>yield from</code>的语法糖：</p><ul><li>把[<code>@asyncio.coroutine](mailto:@asyncio.coroutine)</code>替换为<code>async</code></li><li>把<code>yield from</code>替换为<code>await</code></li></ul><p>即可。</p><p>比如上面的例子：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">compute</span>(<span class="params">x, y</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Compute %s + %s ...&quot;</span> % (x, y))</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">1.0</span>)</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">print_sum</span>(<span class="params">x, y</span>):</span><br><span class="line">    result = <span class="keyword">await</span> compute(x, y)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;%s + %s = %s&quot;</span> % (x, y, result))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;start&quot;</span>)</span><br><span class="line">loop.run_until_complete(print_sum(<span class="number">1</span>, <span class="number">2</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;end&quot;</span>)</span><br><span class="line">loop.close()</span><br></pre></td></tr></table></figure><p>我们再来看一个<code>asyncio</code>中<code>Future</code>的例子：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line">future = asyncio.Future()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">coro1</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;wait 1 second&quot;</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;set_result&quot;</span>)</span><br><span class="line">    future.set_result(<span class="string">&#x27;data&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">coro2</span>():</span><br><span class="line">    result = <span class="keyword">await</span> future</span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">loop.run_until_complete(asyncio.wait([</span><br><span class="line">    coro1()</span><br><span class="line">    coro2()</span><br><span class="line">]))</span><br><span class="line">loop.close()</span><br></pre></td></tr></table></figure><p>输出结果：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wait 1 second</span><br><span class="line">(大约等待1秒)</span><br><span class="line">set_result</span><br><span class="line">data</span><br></pre></td></tr></table></figure><p>这里<code>await</code>后面跟随的<code>future</code>对象，协程中<code>yield from</code>或者<code>await</code>后面可以调用<code>future</code>对象，其作用是：暂停协程，直到<code>future</code>执行结束或者返回<code>result</code>或抛出异常。</p><p>而在我们的例子中，<code>await future</code>必须要等待<code>future.set_result('data')</code>后才能够结束。将<code>coro2()</code>作为第二个协程可能体现得不够明显，可以将协程的调用改成这样：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">loop.run_until_complete(asyncio.wait([</span><br><span class="line">    <span class="comment"># coro1(),</span></span><br><span class="line">    coro2(),</span><br><span class="line">    coro1()</span><br><span class="line">]))</span><br><span class="line">loop.close()</span><br></pre></td></tr></table></figure><p>输出的结果仍旧与上面相同。</p><p>其实，<code>async</code>这个关键字的用法不止能用在函数上，还有<code>async with</code>异步上下文管理器，<code>async for</code>异步迭代器. 对这些感兴趣且觉得有用的可以网上找找资料，这里限于篇幅就不过多展开了。</p><h3 id="使用协程">使用协程</h3><p>协程有很多种写法，我们以一种最流行的写法为例</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">func1</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;你好啊, 我叫潘金莲&quot;</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">3</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;你好啊, 我叫潘金莲&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">func2</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;你好啊, 我叫王建国&quot;</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;你好啊, 我叫王建国&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">func3</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;你好啊, 我叫李雪琴&quot;</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">4</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;你好啊, 我叫李雪琴&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    tasks = [</span><br><span class="line">        asyncio.create_task(func1()),  <span class="comment"># py3.8以后加上asyncio.create_task()</span></span><br><span class="line">        asyncio.create_task(func2()),</span><br><span class="line">        asyncio.create_task(func3())</span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    t1 = time.time()</span><br><span class="line">    <span class="comment"># 一次性启动多个任务(协程)</span></span><br><span class="line">    asyncio.run(main())</span><br><span class="line">    t2 = time.time()</span><br><span class="line">    <span class="built_in">print</span>(t2 - t1)</span><br></pre></td></tr></table></figure><p>以爬取网页代码为例：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">download</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;准备开始下载&quot;</span>)</span><br><span class="line">    resp = requests.get(url) <span class="comment"># 网络请求  requests.get()</span></span><br><span class="line">    <span class="built_in">print</span>(resp.text)</span><br><span class="line">    resp.close()</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)  </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;下载完成&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    urls = [</span><br><span class="line">        <span class="string">&quot;http://www.baidu.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;http://www.bilibili.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;http://www.163.com&quot;</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 准备异步协程对象列表</span></span><br><span class="line">    tasks = []</span><br><span class="line">    <span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">        d = asyncio.create_task(download(url))</span><br><span class="line">        tasks.append(d)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># tasks = [asyncio.create_task(download(url)) for url in urls]  # 这么干也行哦~</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 一次性把所有任务都执行</span></span><br><span class="line">    <span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    asyncio.run(main())</span><br></pre></td></tr></table></figure><h2 id="异步网络请求">异步网络请求</h2><h3 id="aiohttp"><code>aiohttp</code></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># requests.get() 同步的代码 -&gt; 异步操作aiohttp</span></span><br><span class="line"><span class="comment"># pip install aiohttp</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"></span><br><span class="line">urls = [</span><br><span class="line">    <span class="string">&quot;http://kr.shanghai-jiuxin.com/file/2020/1031/191468637cab2f0206f7d1d9b175ac81.jpg&quot;</span>,</span><br><span class="line">    <span class="string">&quot;http://kr.shanghai-jiuxin.com/file/2020/1031/563337d07af599a9ea64e620729f367e.jpg&quot;</span>,</span><br><span class="line">    <span class="string">&quot;http://kr.shanghai-jiuxin.com/file/2020/1031/774218be86d832f359637ab120eba52d.jpg&quot;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">aiodownload</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="comment"># 发送请求.</span></span><br><span class="line">    <span class="comment"># 得到图片内容</span></span><br><span class="line">    <span class="comment"># 保存到文件</span></span><br><span class="line">    name = url.rsplit(<span class="string">&quot;/&quot;</span>, <span class="number">1</span>)[<span class="number">1</span>]  <span class="comment"># 从右边切, 切一次. 得到[1]位置的内容</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:  <span class="comment"># requests</span></span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> session.get(url) <span class="keyword">as</span> resp:  <span class="comment"># resp = requests.get()</span></span><br><span class="line">            <span class="comment"># 请求回来了. 写入文件</span></span><br><span class="line">            <span class="comment"># async with aiofiles.open(name, mode=&quot;wb&quot;) as f: #异步写文件</span></span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(name, mode=<span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:  <span class="comment"># 创建文件</span></span><br><span class="line">                f.write(<span class="keyword">await</span> resp.content.read())  <span class="comment"># 读取内容是异步的. 需要await挂起, resp.text()</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(name, <span class="string">&quot;搞定&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    tasks = []</span><br><span class="line">    <span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">        tasks.append(aiodownload(url))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    asyncio.run(main())</span><br></pre></td></tr></table></figure><p>可以参考：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.cnblogs.com/ssyfj/p/9222342.html">https://www.cnblogs.com/ssyfj/p/9222342.html</a></p><h4 id="注意事项">注意事项</h4><p>转自https://blog.csdn.net/lymmurrain/article/details/109037460</p><h5 id="简单请求">简单请求</h5><p>如果只发出简单的请求(如只有一次请求，无需cookie，SSL，等)，可用如下方法。</p><p>但其实吧很少用，因为一般爬虫中用协程都是要爬取大量页面，可能会使得<code>aiohttp</code>报<code>Unclosed client session</code>的错误。这种情况官方是建议用<code>ClientSession</code>(连接池，见下文)的，性能也有一定的提高。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">fetch</span>():</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.request(<span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;http://python.org/&#x27;</span>) <span class="keyword">as</span> resp:</span><br><span class="line">        <span class="keyword">assert</span> resp.status == <span class="number">200</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="keyword">await</span> resp.text())</span><br><span class="line"><span class="comment">#将协程放入时间循环        </span></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">loop.run_until_complete(fetch())     </span><br></pre></td></tr></table></figure><p>使用连接池请求</p><p>一般情况下使用如下示例,由官网摘抄。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="comment">#传入client使用</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">fetch</span>(<span class="params">client,url</span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> client.get(url) <span class="keyword">as</span> resp:</span><br><span class="line">        <span class="keyword">assert</span> resp.status == <span class="number">200</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> resp.text()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> client:</span><br><span class="line">        html = <span class="keyword">await</span> fetch(client,url)</span><br><span class="line">        <span class="built_in">print</span>(html)</span><br><span class="line"></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">loop.run_until_complete(main())</span><br></pre></td></tr></table></figure><p>是不是感觉有点绕呢，其实平时使用是不必这样将fetch函数抽象出去，可以简单写成下面的简洁示例。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> client:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.request(<span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;http://python.org/&#x27;</span>) <span class="keyword">as</span> resp:</span><br><span class="line">            <span class="keyword">assert</span> resp.status == <span class="number">200</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="keyword">await</span> resp.text())</span><br></pre></td></tr></table></figure><p>发现有什么不同没有，官网的<code>fetch</code>函数抽象出去后，把<code>ClientSession</code>的一个实例作为参数了。所以在<code>with</code>代码块中使用<code>ClientSession</code>实例的情况下，这两者是等同的(我认为，因为两者都是用的都是<code>with</code>代码块中创建的实例)。</p><h5 id="连接池重用">连接池重用</h5><p>而其实官网这段代码是在<code>ClientSession</code>的参考处摘抄的，所以官方这样写我认为只是在提醒要注意<code>ClientSession</code>的用法。那么<code>ClientSession</code>有啥得注意的呢</p><p><code>Session</code> 封装了一个连接池（连接器实例），并且默认情况下支持<code>keep-alive</code>。除非在应用程序的生存期内连接到大量未知的不同服务器，否则建议您在应用程序的生存期内使用单个会话以受益于连接池。</p><p>不要为每个请求创建<code>Session</code> 。每个应用程序很可能需要一个会话，以完全执行所有请求。</p><p>更复杂的情况可能需要在每个站点上进行一次会话，例如，一个会话用于<code>Github</code>，另一个会话用于<code>Facebook API</code>。无论如何，为每个请求建立会话是一个非常糟糕的主意。</p><p>会话内部包含一个连接池。连接重用和保持活动状态（默认情况下均处于启用状态）可能会提高整体性能。</p><p>以上这几段话由官网翻译而来。这几段话都是说，如无必要，只用一个<code>ClientSession</code>实例即可。</p><p>但我在很多资料看到的是像如下这样用的呀</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">fetch</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> client:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.request(<span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">                url) <span class="keyword">as</span> resp:</span><br><span class="line">            <span class="keyword">assert</span> resp.status == <span class="number">200</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="keyword">await</span> resp.text())</span><br></pre></td></tr></table></figure><p>这不明显每请求一次就实例化一个<code>ClientSession</code>嘛，并没有重用<code>ClientSession</code>啊。那应该咋办呢，然而官网并没有举出重用<code>ClientSession</code>的示例(我也是服了，你这么浓墨重彩说道只需一个<code>session</code>，倒是给个示例啊)。</p><p>那只得继续找找资料。然而国内资料不多，只能上<code>github</code>和<code>stackoverflow</code>看看。看了半天也没个定论，主要是两个方法。</p><p>下面是我写的示例</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">fetch</span>(<span class="params">client,url</span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> client.get(url) <span class="keyword">as</span> resp:</span><br><span class="line">        <span class="keyword">assert</span> resp.status == <span class="number">200</span></span><br><span class="line">        text = <span class="keyword">await</span> resp.text()</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(text)</span><br><span class="line"></span><br><span class="line"><span class="comment">#urls是包含多个url的列表</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">fetch_all</span>(<span class="params">urls</span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> client:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> asyncio.gather(*[fetch(client,url) <span class="keyword">for</span> url <span class="keyword">in</span> urls])</span><br><span class="line">    </span><br><span class="line">urls = [<span class="string">&#x27;http://python.org/&#x27;</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>)]</span><br><span class="line">loop=asyncio.get_event_loop()</span><br><span class="line">results = loop.run_until_complete(fetch_all(urls))</span><br><span class="line"><span class="built_in">print</span>(results)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(results))</span><br></pre></td></tr></table></figure><p>手动创建session，不用with</p><p>该方法可以让你获取一个session实例而不仅局限于with代码块中，可以在后续代码中继续使用该session。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">fetch</span>(<span class="params">client,url</span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> client.get(url) <span class="keyword">as</span> resp:</span><br><span class="line">        <span class="keyword">assert</span> resp.status == <span class="number">200</span></span><br><span class="line">        text = <span class="keyword">await</span> resp.text()</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">fetch_all_manual</span>(<span class="params">urls,client</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> asyncio.gather(*[fetch(client, url) <span class="keyword">for</span> url <span class="keyword">in</span> urls])</span><br><span class="line"></span><br><span class="line">urls = [<span class="string">&#x27;http://python.org/&#x27;</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>)]</span><br><span class="line">loop=asyncio.get_event_loop()</span><br><span class="line">client = aiohttp.ClientSession()</span><br><span class="line">results = loop.run_until_complete(fetch_all_manual(urls,client))</span><br><span class="line"><span class="comment">#要手动关闭自己创建的ClientSession，并且client.close()是个协程，得用事件循环关闭</span></span><br><span class="line">loop.run_until_complete(client.close())</span><br><span class="line"><span class="comment">#在关闭loop之前要给aiohttp一点时间关闭ClientSession</span></span><br><span class="line">loop.run_until_complete(asyncio.sleep(<span class="number">3</span>))</span><br><span class="line">loop.close()</span><br><span class="line"><span class="built_in">print</span>(results)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(results))</span><br></pre></td></tr></table></figure><p>此处着重说明以下该方法一些相关事项</p><p>手动创建<code>ClientSession</code>要手动关闭自己创建的<code>ClientSession</code>，并且<code>client.close()</code>是个协程，得用事件循环关闭。<br>在关闭loop之前要给<code>aiohttp</code>一点时间关闭<code>ClientSession</code></p><p>如果无上述步骤会报<code>Unclosed client session</code>的错误，也即<code>ClientSession</code>没有关闭</p><p>但就算你遵循了以上两个事项，如此运行程序会报以下warning，虽然不会影响程序正常进行</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DeprecationWarning: The <span class="built_in">object</span> should be created <span class="keyword">from</span> <span class="keyword">async</span> function</span><br><span class="line">  client = aiohttp.ClientSession()</span><br></pre></td></tr></table></figure><p>这说的是<code>client = aiohttp.ClientSession()</code>这行代码应该在异步函数中执行。如果你无法忍受可以在定义个用异步方法用作创建session</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_session</span>():</span><br><span class="line">    <span class="keyword">return</span> aiohttp.ClientSession()</span><br><span class="line"></span><br><span class="line">session = asyncio.get_event_loop().run_until_complete(create_session())</span><br></pre></td></tr></table></figure><p><code>ClientSession</code> 部分重要参数</p><p>下面是<code>ClientSession</code>的所有参数，这里用的比较多的是connector,headers,cookies。headers和cookies写过爬虫的可能都认识了，这里只谈一下connector。</p><p>connector是<code>aiohttp</code>客户端API的传输工具。并发量控制，ssl证书验证，都可通过connector设置，然后传入<code>ClientSession</code>。</p><p>标准connector有两种：</p><ul><li><code>TCPConnector</code>用于常规TCP套接字（同时支持HTTP和 HTTPS方案）(绝大部分情况使用这种)。</li><li><code>UnixConnector</code> 用于通过UNIX套接字进行连接（主要用于测试）。<br>所有连接器类都应继承自<code>BaseConnector</code>。</li></ul><p>使用可以按以下实例</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建一个TCPConnector</span></span><br><span class="line">conn=aiohttp.TCPConnector(verify_ssl=<span class="literal">False</span>)</span><br><span class="line"><span class="comment">#作为参数传入ClientSession</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession(connector=conn) <span class="keyword">as</span> session: </span><br></pre></td></tr></table></figure><p><code>TCPConnector</code>比较重要的参数有</p><ul><li>verify_ssl（bool）– 布尔值，对HTTPS请求执行SSL证书验证 （默认情况下启用）。当要跳过对具有无效证书的站点的验证时可设置为False。</li><li>limit（int）– 整型，同时连接的总数。如果为limit为 None则connector没有限制（默认值：100）。<br>limit_per_host（int）–限制同时连接到同一端点的总数。如果(host, port, is_ssl)三者相同，则端点是相同的。如果为limit=0，则connector没有限制（默认值：0）。</li></ul><p>如果爬虫用上协程，请求速度是非常快的，很可能会对别人服务器造成拒绝服务的攻击，所以平常使用若无需求，最好还是不要设置limit为0。</p><p>限制并发量的另一个做法(使用Semaphore)</p><p>使用Semaphore直接限制发送请求。此处只写用法，作抛砖引玉之用。也很容易用，在fetch_all_manual函数里加上Semaphore的使用即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">fetch</span>(<span class="params">client,url</span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> client.get(url) <span class="keyword">as</span> resp:</span><br><span class="line">        <span class="keyword">assert</span> resp.status == <span class="number">200</span></span><br><span class="line">        text = <span class="keyword">await</span> resp.text()</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">fetch_all_manual</span>(<span class="params">urls,client</span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> asyncio.Semaphore(<span class="number">5</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> asyncio.gather(*[fetch(client, url) <span class="keyword">for</span> url <span class="keyword">in</span> urls])</span><br><span class="line"></span><br><span class="line">urls = [<span class="string">&#x27;http://python.org/&#x27;</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>)]</span><br><span class="line">loop=asyncio.get_event_loop()</span><br><span class="line">client = aiohttp.ClientSession()</span><br><span class="line">results = loop.run_until_complete(fetch_all_manual(urls,client))</span><br><span class="line"><span class="comment">#要手动关闭自己创建的ClientSession，并且client.close()是个协程，得用事件循环关闭</span></span><br><span class="line">loop.run_until_complete(client.close())</span><br><span class="line"><span class="comment">#在关闭loop之前要给aiohttp一点时间关闭ClientSession</span></span><br><span class="line">loop.run_until_complete(asyncio.sleep(<span class="number">3</span>))</span><br><span class="line">loop.close()</span><br><span class="line"><span class="built_in">print</span>(results)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(results))</span><br></pre></td></tr></table></figure><h3 id="aiofiles"><code>aiofiles</code></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 异步文件操作</span></span><br><span class="line"><span class="comment"># pip install aiofiles</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 基本用法</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiofiles</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">wirte_demo</span>():</span><br><span class="line">    <span class="comment"># 异步方式执行with操作,修改为 async with</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiofiles.<span class="built_in">open</span>(<span class="string">&quot;text.txt&quot;</span>,<span class="string">&quot;w&quot;</span>,encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> fp:</span><br><span class="line">        <span class="keyword">await</span> fp.write(<span class="string">&quot;hello world &quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;数据写入成功&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read_demo</span>():</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiofiles.<span class="built_in">open</span>(<span class="string">&quot;text.txt&quot;</span>,<span class="string">&quot;r&quot;</span>,encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> fp:</span><br><span class="line">        content = <span class="keyword">await</span> fp.read()</span><br><span class="line">        <span class="built_in">print</span>(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">read2_demo</span>():</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiofiles.<span class="built_in">open</span>(<span class="string">&quot;text.txt&quot;</span>,<span class="string">&quot;r&quot;</span>,encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> fp:</span><br><span class="line">        <span class="comment"># 读取每行</span></span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">for</span> line <span class="keyword">in</span> fp:</span><br><span class="line">            <span class="built_in">print</span>(line)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    asyncio.run(wirte_demo())</span><br><span class="line">    asyncio.run(read_demo())</span><br><span class="line">    asyncio.run(read2_demo())</span><br></pre></td></tr></table></figure><h2 id="视频的爬取">视频的爬取</h2><p>程序员会想办法把用户上传好的视频进行转码(不同清晰度)做切片(ts)处理。这样既方便用户进行大跨度的调整进度条(最小延迟)。也能为公司节省大量的流量费。既然要把视频切成非常多个小碎片。那就需要有个文件来记录这些小碎片的路径。该文件⼀般为M3U文件，M3U文件中的内容经过UTF-8的编码后，就是M3U8文件。今天, 我们看到的各大视频网站平台使用的几乎都是M3U8文件。</p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="19.jpg" alt="M3U8文件" style="zoom:25%"><p>我们首先就要找这个文件。</p><p>想要抓取一个视频:</p><ol><li>找到m3u8 (各种手段)</li><li>通过m3u8下载到ts文件</li><li>可以通过各种手段(不仅是编程手段，甚至pr) 把ts文件合并为一个mp4文件</li></ol><h3 id="一些格式固定的代码">一些格式固定的代码</h3><p>跳过其中的无效信息，去掉行中的换行、空格等：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">import</span> aiofiles</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">aio_download</span>(<span class="params">up_url</span>): <span class="comment"># up_url顶层域名，可能需要进行url拼接</span></span><br><span class="line">    tasks = []</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:  <span class="comment"># 提前准备好session</span></span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> aiofiles.<span class="built_in">open</span>(<span class="string">&quot;m3u8.txt&quot;</span>, mode=<span class="string">&quot;r&quot;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">async</span> <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">                <span class="keyword">if</span> line.startswith(<span class="string">&quot;#&quot;</span>):</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="comment"># line就是xxxxx.ts</span></span><br><span class="line">                line = line.strip()  <span class="comment"># 去掉没用的空格和换行</span></span><br><span class="line">                <span class="comment"># 拼接真正的ts路径（如果需要）</span></span><br><span class="line">                ts_url = up_url + line</span><br><span class="line">                task = asyncio.create_task(download_ts(ts_url, line, session))  <span class="comment"># 创建任务</span></span><br><span class="line">                tasks.append(task)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">await</span> asyncio.wait(tasks)  <span class="comment"># 等待任务结束</span></span><br><span class="line">            </span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">download_ts</span>(<span class="params">url, name, session</span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> session.get(url) <span class="keyword">as</span> resp:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> aiofiles.<span class="built_in">open</span>(<span class="string">f&quot;video/<span class="subst">&#123;name&#125;</span>&quot;</span>, mode=<span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">await</span> f.write(<span class="keyword">await</span> resp.content.read())  <span class="comment"># 把下载到的内容写入到文件中</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;name&#125;</span>下载完毕&quot;</span>)</span><br></pre></td></tr></table></figure><p>调用时：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 异步协程</span></span><br><span class="line">asyncio.run(aio_download(url_up))</span><br></pre></td></tr></table></figure><h3 id="加密的问题">加密的问题</h3><p>ts文件可能加密过，需要用m3u8的<code>key.key</code>文件中找密钥，需要抓包确定密钥文件前面的域名，然后下载密钥文件，对ts文件解密：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES </span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">dec_ts</span>(<span class="params">name, key</span>): <span class="comment"># name是文件名，key是从文件中拿到的密钥</span></span><br><span class="line">    aes = AES.new(key=key, IV=<span class="string">b&quot;0000000000000000&quot;</span>, mode=AES.MODE_CBC)</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiofiles.<span class="built_in">open</span>(<span class="string">f&quot;video/<span class="subst">&#123;name&#125;</span>&quot;</span>, mode=<span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f1,\</span><br><span class="line">        aiofiles.<span class="built_in">open</span>(<span class="string">f&quot;video/temp_<span class="subst">&#123;name&#125;</span>&quot;</span>, mode=<span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f2:</span><br><span class="line"></span><br><span class="line">        bs = <span class="keyword">await</span> f1.read()  <span class="comment"># 从源文件读取内容</span></span><br><span class="line">        <span class="keyword">await</span> f2.write(aes.decrypt(bs))  <span class="comment"># 把解密好的内容写入文件</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;name&#125;</span>处理完毕&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">aio_dec</span>(<span class="params">key</span>):</span><br><span class="line">    <span class="comment"># 解密</span></span><br><span class="line">    tasks = []</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiofiles.<span class="built_in">open</span>(<span class="string">&quot;m3u8.txt&quot;</span>, mode=<span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            <span class="keyword">if</span> line.startswith(<span class="string">&quot;#&quot;</span>):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            line = line.strip()</span><br><span class="line">            <span class="comment"># 开始创建异步任务</span></span><br><span class="line">            task = asyncio.create_task(dec_ts(line, key))</span><br><span class="line">            tasks.append(task)</span><br><span class="line">        <span class="keyword">await</span> asyncio.wait(tasks)</span><br></pre></td></tr></table></figure><p>一般使用<code>from Crypto.Cipher import AES</code>，在m3u8文件中会有标注</p><p>合并ts文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">merge_ts</span>():</span><br><span class="line">    <span class="comment"># mac: cat 1.ts 2.ts 3.ts &gt; xxx.mp4</span></span><br><span class="line">    <span class="comment"># windows: copy /b 1.ts+2.ts+3.ts xxx.mp4</span></span><br><span class="line">    lst = []</span><br><span class="line">    s = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;shdbz.m3u8&quot;</span>, mode=<span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            <span class="keyword">if</span> line.startswith(<span class="string">&quot;#&quot;</span>):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            line = line.strip()</span><br><span class="line">            lst.append(<span class="string">f&quot;<span class="subst">&#123;line&#125;</span>+&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(lst)</span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">str</span> <span class="keyword">in</span> lst:</span><br><span class="line">        s += <span class="built_in">str</span> <span class="comment"># 或者使用join，但是我的好像有点问题</span></span><br><span class="line">    s = s[<span class="number">0</span>:-<span class="number">1</span>]</span><br><span class="line">    os.system(<span class="string">f&quot;copy/b <span class="subst">&#123;s&#125;</span> xxx.mp4&quot;</span>)</span><br><span class="line">    <span class="comment"># 可能不成功，建议使用cmd</span></span><br></pre></td></tr></table></figure><h2 id="Selenium">Selenium</h2><p>Selenium 是一种开源工具，用于在 Web 浏览器上执行自动化测试（使用任何 Web 浏览器进行 Web 应用程序测试）。可以对抗一些反爬但是问题是比较慢。</p><h3 id="一些基本操作">一些基本操作</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium.webdriver <span class="keyword">import</span> Chrome</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.keys <span class="keyword">import</span> Keys</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">web = Chrome()</span><br><span class="line">web.get(<span class="string">&quot;http://lagou.com&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 找到某个元素. 点击它</span></span><br><span class="line">el = web.find_element(By.XPATH, <span class="string">&#x27;//*[@id=&quot;changeCityBox&quot;]/p[1]/a&#x27;</span>)</span><br><span class="line">el.click()  <span class="comment"># 点击事件</span></span><br><span class="line"></span><br><span class="line">time.sleep(<span class="number">1</span>)  <span class="comment"># 让浏览器缓一会儿</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 找到输入框. 输入python  =&gt;  输入回车</span></span><br><span class="line">web.find_element(By.XPATH, <span class="string">&#x27;//*[@id=&quot;search_input&quot;]&#x27;</span>).send_keys(<span class="string">&quot;python&quot;</span>, Keys.ENTER)</span><br><span class="line"></span><br><span class="line">web.find_element_by_xpath(<span class="string">&#x27;//*[@id=&quot;s_position_list&quot;]/ul/li[1]/div[1]/div[1]/div[1]/a/h3&#x27;</span>).click()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如何进入到进窗口中进行提取</span></span><br><span class="line"><span class="comment"># 注意, 在selenium的眼中. 新窗口默认是不切换过来的.</span></span><br><span class="line">web.switch_to.window(web.window_handles[-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在新窗口中提取内容</span></span><br><span class="line">job_detail = web.find_element_by_xpath(<span class="string">&#x27;//*[@id=&quot;job_detail&quot;]/dd[2]/div&#x27;</span>).text</span><br><span class="line"><span class="built_in">print</span>(job_detail)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关掉子窗口</span></span><br><span class="line">web.close()</span><br><span class="line"><span class="comment"># 变更selenium的窗口视角. 回到原来的窗口中</span></span><br><span class="line">web.switch_to.window(web.window_handles[<span class="number">0</span>])</span><br></pre></td></tr></table></figure><h3 id="页面中iframe如何处理">页面中<code>iframe</code>如何处理</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">web.get(<span class="string">&quot;https://www.91kanju.com/vod-play/541-2-1.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理iframe的话. 必须先拿到iframe. 然后切换视角到iframe . 再然后才可以拿数据</span></span><br><span class="line">iframe = web.find_element(By.XPATH,<span class="string">&#x27;//*[@id=&quot;player_iframe&quot;]&#x27;</span>)</span><br><span class="line">web.switch_to.frame(iframe)  <span class="comment"># 切换到iframe</span></span><br><span class="line"><span class="comment"># web.switch_to.default_content()  # 切换回原页面</span></span><br><span class="line">tx = web.find_element(By.XPATH,<span class="string">&#x27;//*[@id=&quot;main&quot;]/h3[1]&#x27;</span>).text</span><br><span class="line"><span class="built_in">print</span>(tx)</span><br></pre></td></tr></table></figure><h3 id="无头浏览器与下拉列表">无头浏览器与下拉列表</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium.webdriver <span class="keyword">import</span> Chrome</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.chrome.options <span class="keyword">import</span> Options</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.select <span class="keyword">import</span> Select</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"></span><br><span class="line"><span class="comment"># 准备好参数配置</span></span><br><span class="line">opt = Options()</span><br><span class="line">opt.add_argument(<span class="string">&quot;--headless&quot;</span>)</span><br><span class="line">opt.add_argument(<span class="string">&quot;--disbale-gpu&quot;</span>)</span><br><span class="line"></span><br><span class="line">web = Chrome(options=opt)  <span class="comment"># 把参数配置设置到浏览器中</span></span><br><span class="line"></span><br><span class="line">web.get(<span class="string">&quot;https://www.endata.com.cn/BoxOffice/BO/Year/index.html&quot;</span>)</span><br><span class="line"></span><br><span class="line">time.sleep(<span class="number">2</span>)</span><br><span class="line"><span class="comment"># 定位到下拉列表</span></span><br><span class="line">sel_el = web.find_element(By.XPATH, <span class="string">&#x27;//*[@id=&quot;OptionDate&quot;]&#x27;</span>)</span><br><span class="line"><span class="comment"># 对元素进行包装, 包装成下拉菜单</span></span><br><span class="line">sel = Select(sel_el)</span><br><span class="line"><span class="comment"># 让浏览器进行调整选项</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(sel.options)):  <span class="comment"># i就是每一个下拉框选项的索引位置</span></span><br><span class="line">    sel.select_by_index(i)  <span class="comment"># 按照索引进行切换</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    table = web.find_element(By.XPATH,<span class="string">&#x27;//*[@id=&quot;TableList&quot;]/table&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(table.text)  <span class="comment"># 打印所有文本信息</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;===================================&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;运行完毕.  &quot;</span>)</span><br><span class="line">web.close()</span><br></pre></td></tr></table></figure><h3 id="处理滑块">处理滑块</h3><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/Jeeson_Z/article/details/82047685">https://blog.csdn.net/Jeeson_Z/article/details/82047685</a></p><p>以B站为例，但是现在B站好像已经不用滑块了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.wait <span class="keyword">import</span> WebDriverWait</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support <span class="keyword">import</span> expected_conditions <span class="keyword">as</span> EC</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver <span class="keyword">import</span> ActionChains</span><br><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> urlretrieve</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init</span>():</span><br><span class="line">    <span class="comment"># 定义为全局变量，方便其他模块使用</span></span><br><span class="line">    <span class="keyword">global</span> url, browser, username, password, wait</span><br><span class="line">    <span class="comment"># 登录界面的url</span></span><br><span class="line">    url = <span class="string">&#x27;https://passport.bilibili.com/login&#x27;</span></span><br><span class="line">    <span class="comment"># 实例化一个chrome浏览器</span></span><br><span class="line">    browser = webdriver.Chrome()</span><br><span class="line">    <span class="comment"># 用户名</span></span><br><span class="line">    username = <span class="string">&#x27;17389025490&#x27;</span></span><br><span class="line">    <span class="comment"># 密码</span></span><br><span class="line">    password = <span class="string">&#x27;Zhaoweining750&#x27;</span></span><br><span class="line">    <span class="comment"># 设置等待超时</span></span><br><span class="line">    wait = WebDriverWait(browser, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="comment"># 打开登录页面</span></span><br><span class="line">    browser.get(url)</span><br><span class="line">    <span class="comment"># 获取用户名输入框</span></span><br><span class="line">    user = wait.until(EC.presence_of_element_located((By.ID, <span class="string">&#x27;login-username&#x27;</span>)))</span><br><span class="line">    <span class="comment"># 获取密码输入框</span></span><br><span class="line">    passwd = wait.until(EC.presence_of_element_located((By.ID, <span class="string">&#x27;login-passwd&#x27;</span>)))</span><br><span class="line">    <span class="comment"># 输入用户名</span></span><br><span class="line">    user.send_keys(username)</span><br><span class="line">    <span class="comment"># 输入密码</span></span><br><span class="line">    passwd.send_keys(password)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取图片信息</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_image_info</span>(<span class="params">img</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    :param img: (Str)想要获取的图片类型：带缺口、原始</span></span><br><span class="line"><span class="string">    :return: 该图片(Image)、位置信息(List)</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将网页源码转化为能被解析的lxml格式</span></span><br><span class="line">    soup = BeautifulSoup(browser.page_source, <span class="string">&#x27;lxml&#x27;</span>)</span><br><span class="line">    <span class="comment"># 获取验证图片的所有组成片标签</span></span><br><span class="line">    imgs = soup.find_all(<span class="string">&#x27;div&#x27;</span>, &#123;<span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;gt_cut_&#x27;</span> + img + <span class="string">&#x27;_slice&#x27;</span>&#125;)</span><br><span class="line">    <span class="comment"># 用正则提取缺口的小图片的url，并替换后缀</span></span><br><span class="line">    img_url = re.findall(<span class="string">&#x27;url\(\&quot;(.*)\&quot;\);&#x27;</span>, imgs[<span class="number">0</span>].get(<span class="string">&#x27;style&#x27;</span>))[<span class="number">0</span>].replace(<span class="string">&#x27;webp&#x27;</span>, <span class="string">&#x27;jpg&#x27;</span>)</span><br><span class="line">    <span class="comment"># 使用urlretrieve()方法根据url下载缺口图片对象</span></span><br><span class="line">    urlretrieve(url=img_url, filename=img + <span class="string">&#x27;.jpg&#x27;</span>)</span><br><span class="line">    <span class="comment"># 生成缺口图片对象</span></span><br><span class="line">    image = Image.<span class="built_in">open</span>(img + <span class="string">&#x27;.jpg&#x27;</span>)</span><br><span class="line">    <span class="comment"># 获取组成他们的小图片的位置信息</span></span><br><span class="line">    position = get_position(imgs)</span><br><span class="line">    <span class="comment"># 返回图片对象及其位置信息</span></span><br><span class="line">    <span class="keyword">return</span> image, position</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取小图片位置</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_position</span>(<span class="params">img</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    :param img: (List)存放多个小图片的标签</span></span><br><span class="line"><span class="string">    :return: (List)每个小图片的位置信息</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    img_position = []</span><br><span class="line">    <span class="keyword">for</span> small_img <span class="keyword">in</span> img:</span><br><span class="line">        position = &#123;&#125;</span><br><span class="line">        <span class="comment"># 获取每个小图片的横坐标</span></span><br><span class="line">        position[<span class="string">&#x27;x&#x27;</span>] = <span class="built_in">int</span>(re.findall(<span class="string">&#x27;background-position: (.*)px (.*)px;&#x27;</span>, small_img.get(<span class="string">&#x27;style&#x27;</span>))[<span class="number">0</span>][<span class="number">0</span>])</span><br><span class="line">        <span class="comment"># 获取每个小图片的纵坐标</span></span><br><span class="line">        position[<span class="string">&#x27;y&#x27;</span>] = <span class="built_in">int</span>(re.findall(<span class="string">&#x27;background-position: (.*)px (.*)px;&#x27;</span>, small_img.get(<span class="string">&#x27;style&#x27;</span>))[<span class="number">0</span>][<span class="number">1</span>])</span><br><span class="line">        img_position.append(position)</span><br><span class="line">    <span class="keyword">return</span> img_position</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 裁剪图片</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Corp</span>(<span class="params">image, position</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    :param image:(Image)被裁剪的图片</span></span><br><span class="line"><span class="string">    :param position: (List)该图片的位置信息</span></span><br><span class="line"><span class="string">    :return: (List)存放裁剪后的每个图片信息</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 第一行图片信息</span></span><br><span class="line">    first_line_img = []</span><br><span class="line">    <span class="comment"># 第二行图片信息</span></span><br><span class="line">    second_line_img = []</span><br><span class="line">    <span class="keyword">for</span> pos <span class="keyword">in</span> position:</span><br><span class="line">        <span class="keyword">if</span> pos[<span class="string">&#x27;y&#x27;</span>] == -<span class="number">58</span>:</span><br><span class="line">            first_line_img.append(image.crop((<span class="built_in">abs</span>(pos[<span class="string">&#x27;x&#x27;</span>]), <span class="number">58</span>, <span class="built_in">abs</span>(pos[<span class="string">&#x27;x&#x27;</span>]) + <span class="number">10</span>, <span class="number">116</span>)))</span><br><span class="line">        <span class="keyword">if</span> pos[<span class="string">&#x27;y&#x27;</span>] == <span class="number">0</span>:</span><br><span class="line">            second_line_img.append(image.crop((<span class="built_in">abs</span>(pos[<span class="string">&#x27;x&#x27;</span>]), <span class="number">0</span>, <span class="built_in">abs</span>(pos[<span class="string">&#x27;x&#x27;</span>]) + <span class="number">10</span>, <span class="number">58</span>)))</span><br><span class="line">    <span class="keyword">return</span> first_line_img, second_line_img</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 拼接大图</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">put_imgs_together</span>(<span class="params">first_line_img, second_line_img, img_name</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    :param first_line_img: (List)第一行图片位置信息</span></span><br><span class="line"><span class="string">    :param second_line_img: (List)第二行图片信息</span></span><br><span class="line"><span class="string">    :return: (Image)拼接后的正确顺序的图片</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 新建一个图片，new()第一个参数是颜色模式，第二个是图片尺寸</span></span><br><span class="line">    image = Image.new(<span class="string">&#x27;RGB&#x27;</span>, (<span class="number">260</span>, <span class="number">116</span>))</span><br><span class="line">    <span class="comment"># 初始化偏移量为0</span></span><br><span class="line">    offset = <span class="number">0</span></span><br><span class="line">    <span class="comment"># 拼接第一行</span></span><br><span class="line">    <span class="keyword">for</span> img <span class="keyword">in</span> first_line_img:</span><br><span class="line">        <span class="comment"># past()方法进行粘贴，第一个参数是被粘对象，第二个是粘贴位置</span></span><br><span class="line">        image.paste(img, (offset, <span class="number">0</span>))</span><br><span class="line">        <span class="comment"># 偏移量对应增加移动到下一个图片位置,size[0]表示图片宽度</span></span><br><span class="line">        offset += img.size[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># 偏移量重置为0</span></span><br><span class="line">    x_offset = <span class="number">0</span></span><br><span class="line">    <span class="comment"># 拼接第二行</span></span><br><span class="line">    <span class="keyword">for</span> img <span class="keyword">in</span> second_line_img:</span><br><span class="line">        <span class="comment"># past()方法进行粘贴，第一个参数是被粘对象，第二个是粘贴位置</span></span><br><span class="line">        image.paste(img, (x_offset, <span class="number">58</span>))</span><br><span class="line">        <span class="comment"># 偏移量对应增加移动到下一个图片位置，size[0]表示图片宽度</span></span><br><span class="line">        x_offset += img.size[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># 保存图片</span></span><br><span class="line">    image.save(img_name)</span><br><span class="line">    <span class="comment"># 返回图片对象</span></span><br><span class="line">    <span class="keyword">return</span> image</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断像素是否相同</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_pixel_equal</span>(<span class="params">bg_image, fullbg_image, x, y</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    :param bg_image: (Image)缺口图片</span></span><br><span class="line"><span class="string">    :param fullbg_image: (Image)完整图片</span></span><br><span class="line"><span class="string">    :param x: (Int)位置x</span></span><br><span class="line"><span class="string">    :param y: (Int)位置y</span></span><br><span class="line"><span class="string">    :return: (Boolean)像素是否相同</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取缺口图片的像素点(按照RGB格式)</span></span><br><span class="line">    bg_pixel = bg_image.load()[x, y]</span><br><span class="line">    <span class="comment"># 获取完整图片的像素点(按照RGB格式)</span></span><br><span class="line">    fullbg_pixel = fullbg_image.load()[x, y]</span><br><span class="line">    <span class="comment"># 设置一个判定值，像素值之差超过判定值则认为该像素不相同</span></span><br><span class="line">    threshold = <span class="number">60</span></span><br><span class="line">    <span class="comment"># 判断像素的各个颜色之差，abs()用于取绝对值</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">abs</span>(bg_pixel[<span class="number">0</span>] - fullbg_pixel[<span class="number">0</span>] &lt; threshold) <span class="keyword">and</span> <span class="built_in">abs</span>(bg_pixel[<span class="number">1</span>] - fullbg_pixel[<span class="number">1</span>] &lt; threshold) <span class="keyword">and</span> <span class="built_in">abs</span>(</span><br><span class="line">            bg_pixel[<span class="number">2</span>] - fullbg_pixel[<span class="number">2</span>] &lt; threshold)):</span><br><span class="line">        <span class="comment"># 如果差值在判断值之内，返回是相同像素</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 如果差值在判断值之外，返回不是相同像素</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算滑块移动距离</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_distance</span>(<span class="params">bg_image, fullbg_image</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    :param bg_image: (Image)缺口图片</span></span><br><span class="line"><span class="string">    :param fullbg_image: (Image)完整图片</span></span><br><span class="line"><span class="string">    :return: (Int)缺口离滑块的距离</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 滑块的初始位置</span></span><br><span class="line">    distance = <span class="number">57</span></span><br><span class="line">    <span class="comment"># 遍历像素点横坐标</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(distance, fullbg_image.size[<span class="number">0</span>]):</span><br><span class="line">        <span class="comment"># 遍历像素点纵坐标</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(fullbg_image.size[<span class="number">1</span>]):</span><br><span class="line">            <span class="comment"># 如果不是相同像素</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> is_pixel_equal(fullbg_image, bg_image, i, j):</span><br><span class="line">                <span class="comment"># 返回此时横轴坐标就是滑块需要移动的距离</span></span><br><span class="line">                <span class="keyword">return</span> i</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构造滑动轨迹</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_trace</span>(<span class="params">distance</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    :param distance: (Int)缺口离滑块的距离</span></span><br><span class="line"><span class="string">    :return: (List)移动轨迹</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建存放轨迹信息的列表</span></span><br><span class="line">    trace = []</span><br><span class="line">    <span class="comment"># 设置加速的距离</span></span><br><span class="line">    faster_distance = distance * (<span class="number">4</span> / <span class="number">5</span>)</span><br><span class="line">    <span class="comment"># 设置初始位置、初始速度、时间间隔</span></span><br><span class="line">    start, v0, t = <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.2</span></span><br><span class="line">    <span class="comment"># 当尚未移动到终点时</span></span><br><span class="line">    <span class="keyword">while</span> start &lt; distance:</span><br><span class="line">        <span class="comment"># 如果处于加速阶段</span></span><br><span class="line">        <span class="keyword">if</span> start &lt; faster_distance:</span><br><span class="line">            <span class="comment"># 设置加速度为2</span></span><br><span class="line">            a = <span class="number">1.5</span></span><br><span class="line">        <span class="comment"># 如果处于减速阶段</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 设置加速度为-3</span></span><br><span class="line">            a = -<span class="number">3</span></span><br><span class="line">        <span class="comment"># 移动的距离公式</span></span><br><span class="line">        move = v0 * t + <span class="number">1</span> / <span class="number">2</span> * a * t * t</span><br><span class="line">        <span class="comment"># 此刻速度</span></span><br><span class="line">        v = v0 + a * t</span><br><span class="line">        <span class="comment"># 重置初速度</span></span><br><span class="line">        v0 = v</span><br><span class="line">        <span class="comment"># 重置起点</span></span><br><span class="line">        start += move</span><br><span class="line">        <span class="comment"># 将移动的距离加入轨迹列表</span></span><br><span class="line">        trace.append(<span class="built_in">round</span>(move))</span><br><span class="line">    <span class="comment"># 返回轨迹信息</span></span><br><span class="line">    <span class="keyword">return</span> trace</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 模拟拖动</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">move_to_gap</span>(<span class="params">trace</span>):</span><br><span class="line">    <span class="comment"># 得到滑块标签</span></span><br><span class="line">    slider = wait.until(EC.presence_of_element_located((By.CLASS_NAME, <span class="string">&#x27;gt_slider_knob&#x27;</span>)))</span><br><span class="line">    <span class="comment"># 使用click_and_hold()方法悬停在滑块上，perform()方法用于执行</span></span><br><span class="line">    ActionChains(browser).click_and_hold(slider).perform()</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> trace:</span><br><span class="line">        <span class="comment"># 使用move_by_offset()方法拖动滑块，perform()方法用于执行</span></span><br><span class="line">        ActionChains(browser).move_by_offset(xoffset=x, yoffset=<span class="number">0</span>).perform()</span><br><span class="line">    <span class="comment"># 模拟人类对准时间</span></span><br><span class="line">    sleep(<span class="number">0.5</span>)</span><br><span class="line">    <span class="comment"># 释放滑块</span></span><br><span class="line">    ActionChains(browser).release().perform()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 主程序</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># 初始化</span></span><br><span class="line">    init()</span><br><span class="line">    <span class="comment"># 登录</span></span><br><span class="line">    login()</span><br><span class="line">    <span class="comment"># 获取缺口图片及其位置信息</span></span><br><span class="line">    bg, bg_position = get_image_info(<span class="string">&#x27;bg&#x27;</span>)</span><br><span class="line">    <span class="comment"># 获取完整图片及其位置信息</span></span><br><span class="line">    fullbg, fullbg_position = get_image_info(<span class="string">&#x27;fullbg&#x27;</span>)</span><br><span class="line">    <span class="comment"># 将混乱的缺口图片裁剪成小图，获取两行的位置信息</span></span><br><span class="line">    bg_first_line_img, bg_second_line_img = Corp(bg, bg_position)</span><br><span class="line">    <span class="comment"># 将混乱的完整图片裁剪成小图，获取两行的位置信息</span></span><br><span class="line">    fullbg_first_line_img, fullbg_second_line_img = Corp(fullbg, fullbg_position)</span><br><span class="line">    <span class="comment"># 根据两行图片信息拼接出缺口图片正确排列的图片</span></span><br><span class="line">    bg_image = put_imgs_together(bg_first_line_img, bg_second_line_img, <span class="string">&#x27;bg.jpg&#x27;</span>)</span><br><span class="line">    <span class="comment"># 根据两行图片信息拼接出完整图片正确排列的图片</span></span><br><span class="line">    fullbg_image = put_imgs_together(fullbg_first_line_img, fullbg_second_line_img, <span class="string">&#x27;fullbg.jpg&#x27;</span>)</span><br><span class="line">    <span class="comment"># 计算滑块移动距离</span></span><br><span class="line">    distance = get_distance(bg_image, fullbg_image)</span><br><span class="line">    <span class="comment"># 计算移动轨迹</span></span><br><span class="line">    trace = get_trace(distance - <span class="number">10</span>)</span><br><span class="line">    <span class="comment"># 移动滑块</span></span><br><span class="line">    move_to_gap(trace)</span><br><span class="line">    sleep(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 程序入口</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><h4 id="处理滑块的一些问题">处理滑块的一些问题</h4><p>在处理12306的滑块时总是失败，使用selenium套件操作滑块后会出现“哎呀，出错了，点击刷新再来一次”这样的提示。</p><p>知己知彼，参见https://blog.csdn.net/weixin_44685869/article/details/105602629</p><p>网页只要设置了检查<code>webdriver</code>的<code>Javascript</code>方法，就很容易发现爬虫。使用的方法就是<code>Navigator</code>对象的<code>webdriver</code>属性，用这个属性来判断客户端是否通过<code>WebDriver</code>驱动浏览器。如果监测到客户端的<code>webdriver</code>属性存在，则无法继续操作获取数据。<code>selenium</code>就存在<code>WebDriver</code>属性。</p><p>监测结果有3种，分别是<code>true</code>，<code>false</code>，<code>undefind</code>。</p><p>最广为人知的识别是否是<code>selenium</code>的方法就是 <code>window.navigator.webdriver</code>，当浏览器被打开后，<code>js</code>就会给当前窗口一个<code>window</code>属性，里面存放着用户的各种&quot;信息&quot;。</p><p>使用渲染工具有 <code>webdriver</code> 属性时，<code>navigation.webdriver</code>的返回值时<code>true</code>。反之则会返回<code>false</code>或者<code>undefind</code>。</p><p>了解了<code>WebDriver</code>识别的原理和返回值后，我们就能相处应对的办法。既然 <code>Web Driver</code> 的识别依赖<code>navigation.webdriver</code>的返回值，那么我们在触发<code>Javascript</code>办法前将<code>navigation.webdriver</code>的返回值改为<code>false</code>或者<code>undefind</code>，问题就解决了。</p><p>不过这种修改该属性值的办法只在当前页面有效，当浏览器打开新标签或新窗口时需要重新执行改变<code>navigator.webdriver</code>值的<code>JavaScript</code>代码。一般来说足够了。</p><p>例如：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium.webdriver <span class="keyword">import</span> Chrome</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">brower = Chrome(executable_path=<span class="string">r&#x27;D:\python\chromedriver_win32\chromedriver.exe&#x27;</span>)</span><br><span class="line">url = <span class="string">&#x27;http://www.porters.vip/features/webdriver.html&#x27;</span></span><br><span class="line">brower.get(url)</span><br><span class="line"></span><br><span class="line"><span class="comment">#关键=================================</span></span><br><span class="line">script = <span class="string">&#x27;Object.defineProperty(navigator,&quot;webdriver&quot;,&#123;get:() =&gt; false,&#125;);&#x27;</span></span><br><span class="line"><span class="comment">#运行Javascript</span></span><br><span class="line">brower.execute_script(script)</span><br><span class="line"><span class="comment">#======================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#定位按钮并点击</span></span><br><span class="line">brower.find_element_by_css_selector(<span class="string">&#x27;.btn.btn-primary.btn-lg&#x27;</span>).click()</span><br><span class="line"></span><br><span class="line"><span class="comment">#定位到文章内容元素</span></span><br><span class="line">elements = brower.find_element_by_css_selector(<span class="string">&#x27;#content&#x27;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(elements.text)</span><br><span class="line">brower.close()</span><br></pre></td></tr></table></figure><p>或者在创建浏览器对象时：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 2.chrome的版本大于等于88</span></span><br><span class="line">option = Options()</span><br><span class="line">option.add_argument(<span class="string">&#x27;--disable-blink-features=AutomationControlled&#x27;</span>)</span><br><span class="line"></span><br><span class="line">web = Chrome(options=option)</span><br></pre></td></tr></table></figure><h4 id="PS-使用opencv处理缺口类滑块">PS. 使用opencv处理缺口类滑块</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"></span><br><span class="line">GAUSSIAN_BLUR_KERNEL_SIZE = (<span class="number">5</span>, <span class="number">5</span>)</span><br><span class="line">GAUSSIAN_BLUR_SIGMA_X = <span class="number">0</span></span><br><span class="line">CANNY_THRESHOLD1 = <span class="number">200</span></span><br><span class="line">CANNY_THRESHOLD2 = <span class="number">450</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_gaussian_blur_image</span>(<span class="params">image</span>):</span><br><span class="line">    <span class="keyword">return</span> cv2.GaussianBlur(image, GAUSSIAN_BLUR_KERNEL_SIZE, GAUSSIAN_BLUR_SIGMA_X)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_canny_image</span>(<span class="params">image</span>):</span><br><span class="line">    <span class="keyword">return</span> cv2.Canny(image, CANNY_THRESHOLD1, CANNY_THRESHOLD2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_contours</span>(<span class="params">image</span>):</span><br><span class="line">    contours, _ = cv2.findContours(image, cv2.RETR_CCOMP, cv2.CHAIN_APPROX_SIMPLE)</span><br><span class="line">    <span class="keyword">return</span> contours</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_contour_area_threshold</span>(<span class="params">image_width, image_height</span>):</span><br><span class="line">    contour_area_min = (image_width * <span class="number">0.15</span>) * (image_height * <span class="number">0.25</span>) * <span class="number">0.8</span></span><br><span class="line">    contour_area_max = (image_width * <span class="number">0.15</span>) * (image_height * <span class="number">0.25</span>) * <span class="number">1.2</span></span><br><span class="line">    <span class="keyword">return</span> contour_area_min, contour_area_max</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_arc_length_threshold</span>(<span class="params">image_width, image_height</span>):</span><br><span class="line">    arc_length_min = ((image_width * <span class="number">0.15</span>) + (image_height * <span class="number">0.25</span>)) * <span class="number">2</span> * <span class="number">0.8</span></span><br><span class="line">    arc_length_max = ((image_width * <span class="number">0.15</span>) + (image_height * <span class="number">0.25</span>)) * <span class="number">2</span> * <span class="number">1.2</span></span><br><span class="line">    <span class="keyword">return</span> arc_length_min, arc_length_max</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_offset_threshold</span>(<span class="params">image_width</span>):</span><br><span class="line">    offset_min = <span class="number">0.2</span> * image_width</span><br><span class="line">    offset_max = <span class="number">0.85</span> * image_width</span><br><span class="line">    <span class="keyword">return</span> offset_min, offset_max</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    image_raw = cv2.imread(<span class="string">&#x27;captcha.png&#x27;</span>)</span><br><span class="line">    image_height, image_width, _ = image_raw.shape</span><br><span class="line">    image_gaussian_blur = get_gaussian_blur_image(image_raw)</span><br><span class="line">    image_canny = get_canny_image(image_gaussian_blur)</span><br><span class="line">    contours = get_contours(image_canny)</span><br><span class="line">    cv2.imwrite(<span class="string">&#x27;image_canny.png&#x27;</span>, image_canny)</span><br><span class="line">    cv2.imwrite(<span class="string">&#x27;image_gaussian_blur.png&#x27;</span>, image_gaussian_blur)</span><br><span class="line">    contour_area_min, contour_area_max = get_contour_area_threshold(image_width, image_height)</span><br><span class="line">    arc_length_min, arc_length_max = get_arc_length_threshold(image_width, image_height)</span><br><span class="line">    offset_min, offset_max = get_offset_threshold(image_width)</span><br><span class="line">    offset = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">for</span> contour <span class="keyword">in</span> contours:</span><br><span class="line">        x, y, w, h = cv2.boundingRect(contour)</span><br><span class="line">        <span class="keyword">if</span> contour_area_min &lt; cv2.contourArea(contour) &lt; contour_area_max <span class="keyword">and</span> \</span><br><span class="line">                arc_length_min &lt; cv2.arcLength(contour, <span class="literal">True</span>) &lt; arc_length_max <span class="keyword">and</span> \</span><br><span class="line">                offset_min &lt; x &lt; offset_max:</span><br><span class="line">            cv2.rectangle(image_raw, (x, y), (x + w, y + h), (<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>), <span class="number">2</span>)</span><br><span class="line">            offset = x</span><br><span class="line">    cv2.imwrite(<span class="string">&#x27;image_label.png&#x27;</span>, image_raw)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;offset&#x27;</span>, offset)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者:</span> <span class="post-copyright-info"><a href="https://zwn2001.space">洛雪</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接:</span> <span class="post-copyright-info"><a href="https://zwn2001.space/posts/Python%E7%88%AC%E8%99%AB%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%B0%8F%E9%BB%91%E5%B1%8B/">https://zwn2001.space/posts/Python%E7%88%AC%E8%99%AB%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%B0%8F%E9%BB%91%E5%B1%8B/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明:</span> <span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zwn2001.space" target="_blank">ZWN's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Python/">Python</a></div><div class="post_share"><div class="social-share" data-image="/img/cover3/29.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://unpkg.com/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://unpkg.com/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" title="正则表达式"><img class="cover" src="/img/cover3/30.jpg" onerror='onerror=null,src="/img/404.webp"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">正则表达式</div></div></a></div><div class="next-post pull-right"><a href="/posts/isdu%E6%9A%91%E6%9C%9F%E7%BB%B4%E6%8A%A4%E6%97%A5%E5%BF%97/" title="isdu暑期维护日志"><img class="cover" src="/img/cover1/2.jpg" onerror='onerror=null,src="/img/404.webp"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">isdu暑期维护日志</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/Python%E7%88%AC12306%E4%BD%99%E7%A5%A8/" title="Python爬12306余票"><img class="cover" src="/img/cover2/11-min.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-11</div><div class="title">Python爬12306余票</div></div></a></div><div><a href="/posts/Python%E5%B0%8F%E6%8A%84/" title="Python小抄"><img class="cover" src="/img/cover1/3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-06</div><div class="title">Python小抄</div></div></a></div><div><a href="/posts/advanced-Python/" title="Python进阶语法记录-OOP、IO、网络"><img class="cover" src="/img/cover1/2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-13</div><div class="title">Python进阶语法记录-OOP、IO、网络</div></div></a></div><div><a href="/posts/basic-Python/" title="Python基础语法记录"><img class="cover" src="/img/cover3/34.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-11</div><div class="title">Python基础语法记录</div></div></a></div><div><a href="/posts/opencv-basic/" title="opencv_basic"><img class="cover" src="/img/cover2/5-min.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-26</div><div class="title">opencv_basic</div></div></a></div><div><a href="/posts/%E6%89%8B%E6%8E%A7%E9%BC%A0%E6%A0%87/" title="手控鼠标"><img class="cover" src="/img/cover3/34.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-05-15</div><div class="title">手控鼠标</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i> <span>评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/favicon.webp" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">洛雪</div><div class="author-info__description">我虽无意逐鹿，却知苍生苦楚</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">139</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">43</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/ZWN2001"><i class="fab fa-github"></i><span>我的Github</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/ZWN2001" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">新域名：www.zwn2001.space，有效期：10年。https://www.zwn-blog.xyz已过期。访问时建议科学上网，否则博客内公式渲染会出现问题且速度慢。Ctrl+shift+r可强制刷新网站以避免浏览器缓存造成的更新不及时</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">Python爬虫从入门到小黑屋</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%AE%BA"><span class="toc-number">1.1.</span> <span class="toc-text">概论</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%88%AC%E8%99%AB%E7%9A%84%E7%9F%9B%E4%B8%8E%E7%9B%BE"><span class="toc-number">1.1.1.</span> <span class="toc-text">爬虫的矛与盾</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Request%E4%B8%8E%E7%AC%AC%E4%B8%80%E4%B8%AA%E7%88%AC%E8%99%AB"><span class="toc-number">1.1.2.</span> <span class="toc-text">Request与第一个爬虫</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E8%A7%A3%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">数据解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">1.2.1.</span> <span class="toc-text">正则表达式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A3%E5%88%99%E6%A0%B7%E4%BE%8B%EF%BC%9A%E8%B1%86%E7%93%A3top250"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">正则样例：豆瓣top250</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bs4"><span class="toc-number">1.2.2.</span> <span class="toc-text">bs4</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B7%E4%BE%8B"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">样例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#xpath"><span class="toc-number">1.2.3.</span> <span class="toc-text">xpath</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B7%E4%BE%8B-2"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">样例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E6%8B%9F%E7%99%BB%E5%BD%95"><span class="toc-number">1.3.</span> <span class="toc-text">模拟登录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%98%B2%E7%9B%97%E9%93%BE"><span class="toc-number">1.4.</span> <span class="toc-text">防盗链</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A0%E5%AF%86%E6%95%B0%E6%8D%AE%E7%9A%84%E8%A7%A3%E6%9E%90-%E4%BB%A5%E6%8A%93%E5%8F%96%E7%BD%91%E6%98%93%E4%BA%91%E7%83%AD%E8%AF%84%E4%B8%BA%E4%BE%8B"><span class="toc-number">1.5.</span> <span class="toc-text">加密数据的解析-以抓取网易云热评为例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B"><span class="toc-number">1.6.</span> <span class="toc-text">多线程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.6.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%9A%84%E4%B8%A4%E7%A7%8D%E5%BD%A2%E5%BC%8F"><span class="toc-number">1.6.2.</span> <span class="toc-text">多线程的两种形式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E8%BF%9B%E7%A8%8B"><span class="toc-number">1.7.</span> <span class="toc-text">多进程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%B8%8E%E8%BF%9B%E7%A8%8B%E6%B1%A0"><span class="toc-number">1.8.</span> <span class="toc-text">线程池与进程池</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%8F%E7%A8%8B"><span class="toc-number">1.9.</span> <span class="toc-text">协程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%99%A8-Generator"><span class="toc-number">1.9.1.</span> <span class="toc-text">生成器(Generator)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#yield%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">1.9.1.1.</span> <span class="toc-text">yield表达式的使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85%E5%92%8C%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.9.1.2.</span> <span class="toc-text">生产者和消费者模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#yield-from%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">1.9.1.3.</span> <span class="toc-text">yield from表达式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%8F%E7%A8%8B-Coroutine"><span class="toc-number">1.9.2.</span> <span class="toc-text">协程(Coroutine)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#asyncio-coroutine-mailto-asyncio-coroutine"><span class="toc-number">1.9.2.1.</span> <span class="toc-text">[@asyncio.coroutine](mailto:@asyncio.coroutine)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%90%86%E8%A7%A3Python%E8%A3%85%E9%A5%B0%E5%99%A8-Decorator"><span class="toc-number">1.10.</span> <span class="toc-text">理解Python装饰器(Decorator)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AD%E5%8C%85"><span class="toc-number">1.10.1.</span> <span class="toc-text">闭包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A3%85%E9%A5%B0%E5%99%A8"><span class="toc-number">1.10.2.</span> <span class="toc-text">装饰器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%A6%E5%8F%82%E6%95%B0%E7%9A%84%E8%A3%85%E9%A5%B0%E5%99%A8"><span class="toc-number">1.10.3.</span> <span class="toc-text">带参数的装饰器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#async-await"><span class="toc-number">1.10.3.1.</span> <span class="toc-text">async&#x2F;await</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%8D%8F%E7%A8%8B"><span class="toc-number">1.10.4.</span> <span class="toc-text">使用协程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82"><span class="toc-number">1.11.</span> <span class="toc-text">异步网络请求</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#aiohttp"><span class="toc-number">1.11.1.</span> <span class="toc-text">aiohttp</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">1.11.1.1.</span> <span class="toc-text">注意事项</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E8%AF%B7%E6%B1%82"><span class="toc-number">1.11.1.1.1.</span> <span class="toc-text">简单请求</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E6%B1%A0%E9%87%8D%E7%94%A8"><span class="toc-number">1.11.1.1.2.</span> <span class="toc-text">连接池重用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#aiofiles"><span class="toc-number">1.11.2.</span> <span class="toc-text">aiofiles</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%86%E9%A2%91%E7%9A%84%E7%88%AC%E5%8F%96"><span class="toc-number">1.12.</span> <span class="toc-text">视频的爬取</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E6%A0%BC%E5%BC%8F%E5%9B%BA%E5%AE%9A%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-number">1.12.1.</span> <span class="toc-text">一些格式固定的代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E5%AF%86%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.12.2.</span> <span class="toc-text">加密的问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Selenium"><span class="toc-number">1.13.</span> <span class="toc-text">Selenium</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="toc-number">1.13.1.</span> <span class="toc-text">一些基本操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B5%E9%9D%A2%E4%B8%ADiframe%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86"><span class="toc-number">1.13.2.</span> <span class="toc-text">页面中iframe如何处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E5%A4%B4%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%8E%E4%B8%8B%E6%8B%89%E5%88%97%E8%A1%A8"><span class="toc-number">1.13.3.</span> <span class="toc-text">无头浏览器与下拉列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E6%BB%91%E5%9D%97"><span class="toc-number">1.13.4.</span> <span class="toc-text">处理滑块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E6%BB%91%E5%9D%97%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98"><span class="toc-number">1.13.4.1.</span> <span class="toc-text">处理滑块的一些问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PS-%E4%BD%BF%E7%94%A8opencv%E5%A4%84%E7%90%86%E7%BC%BA%E5%8F%A3%E7%B1%BB%E6%BB%91%E5%9D%97"><span class="toc-number">1.13.4.2.</span> <span class="toc-text">PS. 使用opencv处理缺口类滑块</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/%E6%AF%95%E8%AE%BE%E4%BB%8E%E8%B0%83%E7%A0%94%E5%88%B0%E5%AE%8C%E5%B7%A5/" title="毕设从调研到完工"><img src="/img/cover2/2-min.jpg" onerror='this.onerror=null,this.src="/img/404.webp"' alt="毕设从调研到完工"></a><div class="content"><a class="title" href="/posts/%E6%AF%95%E8%AE%BE%E4%BB%8E%E8%B0%83%E7%A0%94%E5%88%B0%E5%AE%8C%E5%B7%A5/" title="毕设从调研到完工">毕设从调研到完工</a><time datetime="2024-01-03T13:30:28.000Z" title="发表于 2024-01-03 21:30:28">2024-01-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/2023%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AF%BE%E8%AE%BE%E7%BB%8F%E9%AA%8C%E5%88%86%E4%BA%AB/" title="2023数据库课设经验分享"><img src="/img/cover3/4-min.jpg" onerror='this.onerror=null,this.src="/img/404.webp"' alt="2023数据库课设经验分享"></a><div class="content"><a class="title" href="/posts/2023%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AF%BE%E8%AE%BE%E7%BB%8F%E9%AA%8C%E5%88%86%E4%BA%AB/" title="2023数据库课设经验分享">2023数据库课设经验分享</a><time datetime="2023-08-18T08:01:49.000Z" title="发表于 2023-08-18 16:01:49">2023-08-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/%E5%88%A0%E9%99%A4gitignore%E4%BF%AE%E6%94%B9%E5%89%8D%E6%8F%90%E4%BA%A4%E7%9A%84%E5%A4%A7%E6%96%87%E4%BB%B6/" title="删除gitignore修改前提交的大文件"><img src="/img/cover1/18.jpg" onerror='this.onerror=null,this.src="/img/404.webp"' alt="删除gitignore修改前提交的大文件"></a><div class="content"><a class="title" href="/posts/%E5%88%A0%E9%99%A4gitignore%E4%BF%AE%E6%94%B9%E5%89%8D%E6%8F%90%E4%BA%A4%E7%9A%84%E5%A4%A7%E6%96%87%E4%BB%B6/" title="删除gitignore修改前提交的大文件">删除gitignore修改前提交的大文件</a><time datetime="2023-07-10T13:50:49.000Z" title="发表于 2023-07-10 21:50:49">2023-07-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%8D%9A%E5%AE%A2%E5%85%AC%E5%BC%8F%E6%B8%B2%E6%9F%93%E6%8E%92%E6%9F%A5/" title="记一次博客公式渲染排查"><img src="/img/cover1/1.jpg" onerror='this.onerror=null,this.src="/img/404.webp"' alt="记一次博客公式渲染排查"></a><div class="content"><a class="title" href="/posts/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%8D%9A%E5%AE%A2%E5%85%AC%E5%BC%8F%E6%B8%B2%E6%9F%93%E6%8E%92%E6%9F%A5/" title="记一次博客公式渲染排查">记一次博客公式渲染排查</a><time datetime="2023-06-23T01:21:51.000Z" title="发表于 2023-06-23 09:21:51">2023-06-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/A-star%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/" title="A-star路径规划"><img src="/img/cover1/33.jpg" onerror='this.onerror=null,this.src="/img/404.webp"' alt="A-star路径规划"></a><div class="content"><a class="title" href="/posts/A-star%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92/" title="A-star路径规划">A-star路径规划</a><time datetime="2023-06-19T13:17:15.000Z" title="发表于 2023-06-19 21:17:15">2023-06-19</time></div></div></div></div></div></div></main><footer id="footer" style="background:0 0"></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i> <span>数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();" rel="external nofollow noreferrer"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();" rel="external nofollow noreferrer"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();" rel="external nofollow noreferrer"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:rmf.scrollToTop();" rel="external nofollow noreferrer"><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();" rel="external nofollow noreferrer"><i class="fa fa-copy"></i><span>复制</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.google.com/search?q=&quot;+window.getSelection().toString());" rel="external nofollow noreferrer"><i class="iconfont icon-baidu"></i><span>搜索</span></a><a class="rightMenu-item" href="javascript:rmf.searchinThisPage();" rel="external nofollow noreferrer"><i class="fas fa-search"></i><span>站内搜索</span></a><a class="rightMenu-item" href="#post-comment" onclick="rmf.yinyong()"><i class="fa-solid fa-message"></i><span>引用文本评论</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();" rel="external nofollow noreferrer"><i class="fa fa-link"></i><span>转到链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()" rel="external nofollow noreferrer"><i class="fa fa-copy"></i><span>粘贴</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()" rel="external nofollow noreferrer"><i class="fa fa-window-restore"></i><span>新窗口打开</span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()" rel="external nofollow noreferrer"><i class="fa fa-link"></i><span>转到链接</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()" rel="external nofollow noreferrer"><i class="fa fa-copy"></i><span>复制链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()" rel="external nofollow noreferrer"><i class="fa fa-download"></i><span>保存图片</span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()" rel="external nofollow noreferrer"><i class="fa fa-window-restore"></i><span>在新窗口打开</span></a><a class="rightMenu-item" href="javascript:rmf.click()" rel="external nofollow noreferrer"><i class="fa fa-arrows-alt"></i><span>全屏显示</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()" rel="external nofollow noreferrer"><i class="fa fa-copy"></i><span>复制图片链接</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:rmf.switchDarkMode();" rel="external nofollow noreferrer"><i class="fa fa-moon"></i><span>昼夜切换</span></a><a class="rightMenu-item" href="javascript:rmf.translate();" rel="external nofollow noreferrer"><i class="iconfont icon-fanti"></i><span>繁简转换</span></a><a class="rightMenu-item" href="javascript:rmf.switchReadMode();" rel="external nofollow noreferrer"><i class="fa fa-book"></i><span>阅读模式</span></a><a class="rightMenu-item" href="javascript:fullScreen();" rel="external nofollow noreferrer"><i class="fas fa-expand"></i><span>进入全屏</span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://unpkg.com/@fancyapps/ui/dist/fancybox/fancybox.umd.js"></script><script src="https://unpkg.com/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script>function panguFn(){"object"==typeof pangu?pangu.autoSpacingPage():getScript("https://unpkg.com/pangu/dist/browser/pangu.min.js").then(()=>{pangu.autoSpacingPage()})}function panguInit(){GLOBAL_CONFIG_SITE.isPost&&panguFn()}document.addEventListener("DOMContentLoaded",panguInit)</script><div class="js-pjax"><link rel="stylesheet" type="text/css" href="https://unpkg.com/katex/dist/katex.min.css"><script src="https://unpkg.com/katex/dist/contrib/copy-tex.min.js"></script><script>document.querySelectorAll("#article-container span.katex-display").forEach(a=>{btf.wrap(a,"div",{class:"katex-wrap"})})</script><script>function getGiscusTheme(e){return"dark"===e?"dark":"light"}function loadGiscus(){var e,t=Object.assign({src:"https://giscus.app/client.js","data-repo":"ZWN2001/ZWN2001.github.io","data-repo-id":"R_kgDOGH1XWg","data-category-id":"DIC_kwDOGH1XWs4CXnHJ","data-mapping":"pathname","data-theme":getGiscusTheme(document.documentElement.getAttribute("data-theme")),"data-reactions-enabled":"1",crossorigin:"anonymous",async:!0},{"data-lang":"zh-CN","data-loading":"lazy",crossorigin:"anonymous","data-mapping":"og:title","data-input-position":"top","data-category":"Announcements"}),a=document.createElement("script");for(e in t)a.setAttribute(e,t[e]);document.getElementById("giscus-wrap").insertAdjacentElement("afterbegin",a)}function changeGiscusTheme(e){var t;e={setConfig:{theme:getGiscusTheme(e)}},(t=document.querySelector("iframe.giscus-frame"))&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")}function loadOtherComment(){loadGiscus()}btf.addModeChange("giscus",changeGiscusTheme),btf.loadComment(document.getElementById("giscus-wrap"),loadGiscus)</script></div><script type="text/javascript" src="https://cdn1.tianli0.top/npm/jquery@latest/dist/jquery.min.js"></script><script type="text/javascript" src="/js/rightmenu.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i> <span>数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><script data-pjax src="https://fastly.jsdelivr.net/gh/Zfour/hexo-github-calendar@1.21/hexo_githubcalendar.js"></script><script data-pjax>function GithubCalendarConfig(){var t=document.getElementById("recent-posts");t&&"/"==location.pathname&&(console.log("已挂载github calendar"),t.insertAdjacentHTML("afterbegin",'<div class="recent-post-item" style="width:100%;height:auto;padding:10px;"><div id="github_loading" style="width:10%;height:100%;margin:0 auto;display: block"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"  viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animateTransform></path></svg></div><div id="github_container"></div></div>')),GithubCalendar("https://my-hexo-github-calender.vercel.app/api/?ZWN2001",["#ebedf0","#f1f8ff","#dbedff","#c8e1ff","#79b8ff","#2188ff","#0366d6","#005cc5","#044289","#032f62","#05264c"],"ZWN2001")}document.getElementById("recent-posts")&&GithubCalendarConfig()</script><style>#github_container{min-height:280px}@media screen and (max-width:650px){#github_container{min-height:0}}</style><style></style><script data-pjax>var parent,child;document.getElementById("recent-posts")&&"/"===location.pathname&&(parent=document.getElementById("recent-posts"),child='<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="https://zwn2001.space/categories/编程知识/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">📚 洛雪の编程知识 (17)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://zwn2001.space/categories/实用知识/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">💡 洛雪の实用知识 (14)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://zwn2001.space/categories/学习-课外拓展/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">👩‍💻 洛雪の学习-课外拓展 (20)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://zwn2001.space/categories/学习-课内知识/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">📒 洛雪の学习-课内知识 (57)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><a class="magnet_link_more"  href="https://zwn2001.space/categories" style="flex:1;text-align: center;margin-bottom: 10px;">查看更多...</a></div></div>',console.log("已挂载magnet"),parent.insertAdjacentHTML("afterbegin",child))</script><style>#catalog_magnet{flex-wrap:wrap;display:flex;width:100%;justify-content:space-between;padding:10px 10px 0 10px;align-content:flex-start}.magnet_item{flex-basis:calc(50% - 5px);background:#f2f2f2;margin-bottom:10px;border-radius:8px;transition:all .2s ease-in-out}.magnet_item:hover{background:#b30070}.magnet_link_more{color:#555}.magnet_link{color:#000}.magnet_link:hover{color:#fff}@media screen and (max-width:600px){.magnet_item{flex-basis:100%}}.magnet_link_context{display:flex;padding:10px;font-size:16px;transition:all .2s ease-in-out}.magnet_link_context:hover{padding:10px 20px}</style><style></style></body></html>